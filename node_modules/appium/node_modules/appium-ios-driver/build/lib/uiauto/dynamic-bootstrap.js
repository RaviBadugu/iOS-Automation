"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.prepareBootstrap = prepareBootstrap;
exports.getEnv = getEnv;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _crypto = _interopRequireDefault(require("crypto"));

var _appiumSupport = require("appium-support");

var _buildScript = _interopRequireDefault(require("./build-script"));

var _logger = _interopRequireDefault(require("./logger"));

var _uiautoClient = require("./uiauto-client");

let BOOTSTRAP_JS_PATH = _path.default.resolve(__dirname, '..', '..', '..', 'uiauto', 'bootstrap.js');

let COMMAND_PROXY_CLIENT_PATH = _path.default.resolve(__dirname, 'bin', 'command-proxy-client.js');

if (!__dirname.match(/build\/lib\/uiauto$/)) {
  BOOTSTRAP_JS_PATH = _path.default.resolve(__dirname, '..', 'uiauto', 'bootstrap.js');
  COMMAND_PROXY_CLIENT_PATH = _path.default.resolve(__dirname, 'bin', 'command-proxy-client.js');
}

function getEnv(opts = {}) {
  return {
    nodePath: process.execPath,
    commandProxyClientPath: COMMAND_PROXY_CLIENT_PATH,
    instrumentsSock: opts.sock || _uiautoClient.DEFAULT_INSTRUMENTS_SOCKET,
    interKeyDelay: opts.interKeyDelay || null,
    justLoopInfinitely: opts.justLoopInfinitely,
    autoAcceptAlerts: opts.autoAcceptAlerts,
    autoDismissAlerts: opts.autoDismissAlerts,
    sendKeyStrategy: opts.sendKeyStrategy,
    initialLocation: opts.initialLocation
  };
}

function buildCode(_x) {
  return _buildCode.apply(this, arguments);
}

function _buildCode() {
  _buildCode = (0, _asyncToGenerator2.default)(function* (opts) {
    if (opts.code) return opts.code;
    let env = getEnv(opts);

    _logger.default.debug(`Dynamic env: ${JSON.stringify(env)}`);

    let bootstrapJs = BOOTSTRAP_JS_PATH;
    let imports = opts.imports && opts.imports.pre ? opts.imports.pre : [];
    let bootstrapCode = yield (0, _buildScript.default)(bootstrapJs, imports);
    let lines = [];
    lines.push('// This file is automatically generated. Do not manually modify!');
    lines.push('');
    lines.push(bootstrapCode);
    lines.push('');
    lines.push('bootstrap({');
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _lodash.default.toPairs(env)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        let _step$value = (0, _slicedToArray2.default)(_step.value, 2),
            key = _step$value[0],
            value = _step$value[1];

        if (!_lodash.default.isUndefined(value)) {
          let quote = _lodash.default.isString(value) ? '\"' : '';
          lines.push(`  "${key}": ${quote}${value}${quote},`);
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    lines[lines.length - 1] = lines[lines.length - 1].replace(/,$/, '');
    lines.push('});');
    return lines.join('\r\n');
  });
  return _buildCode.apply(this, arguments);
}

function computeHash(code) {
  return _crypto.default.createHash('md5').update(code).digest('hex').substring(0, 16);
}

function getDynamicBootstrapDir(opts = {}) {
  let dynamicBootstrapDir;

  if (process.env.APPIUM_BOOTSTRAP_DIR) {
    dynamicBootstrapDir = process.env.APPIUM_BOOTSTRAP_DIR;
  } else if (process.env.HOME) {
    dynamicBootstrapDir = _path.default.resolve(process.env.HOME, 'Library/Application Support/appium/bootstrap');
  } else {
    dynamicBootstrapDir = _path.default.resolve(opts.tmpDir || '/tmp', 'appium/bootstrap');
  }

  return dynamicBootstrapDir;
}

function writeDynamicBootstrapIfNecessary(_x2, _x3, _x4, _x5) {
  return _writeDynamicBootstrapIfNecessary.apply(this, arguments);
}

function _writeDynamicBootstrapIfNecessary() {
  _writeDynamicBootstrapIfNecessary = (0, _asyncToGenerator2.default)(function* (dynamicBootstrapDir, dynamicBootstrapPath, code, hash) {
    yield (0, _appiumSupport.mkdirp)(dynamicBootstrapDir);
    let codeIsGood = true;

    try {
      let existingCode = yield _appiumSupport.fs.readFile(dynamicBootstrapPath);
      codeIsGood = computeHash(existingCode) === hash;
    } catch (err) {
      codeIsGood = false;
    }

    if (codeIsGood) {
      _logger.default.debug(`Reusing dynamic bootstrap: ${dynamicBootstrapPath}`);
    } else {
      _logger.default.debug(`Creating or overwriting dynamic bootstrap: ${dynamicBootstrapPath}`);

      yield _appiumSupport.fs.writeFile(dynamicBootstrapPath, code, {
        flag: 'w+'
      });
    }
  });
  return _writeDynamicBootstrapIfNecessary.apply(this, arguments);
}

function prepareBootstrap() {
  return _prepareBootstrap.apply(this, arguments);
}

function _prepareBootstrap() {
  _prepareBootstrap = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    _logger.default.debug('Preparing bootstrap code');

    let dynamicBootstrapDir = getDynamicBootstrapDir(opts);

    _logger.default.debug(`Dynamic bootstrap dir: ${dynamicBootstrapDir}`);

    let code = yield buildCode(opts);
    let hash = computeHash(code);

    let dynamicBootstrapPath = _path.default.resolve(dynamicBootstrapDir, `bootstrap-${hash}.js`);

    _logger.default.debug(`Dynamic bootstrap code: ${code.split('\n')[0]}...`);

    _logger.default.debug(`Dynamic bootstrap path: ${dynamicBootstrapPath}`);

    yield writeDynamicBootstrapIfNecessary(dynamicBootstrapDir, dynamicBootstrapPath, code, hash);
    return dynamicBootstrapPath;
  });
  return _prepareBootstrap.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG8vZHluYW1pYy1ib290c3RyYXAuanMiXSwibmFtZXMiOlsiQk9PVFNUUkFQX0pTX1BBVEgiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIkNPTU1BTkRfUFJPWFlfQ0xJRU5UX1BBVEgiLCJtYXRjaCIsImdldEVudiIsIm9wdHMiLCJub2RlUGF0aCIsInByb2Nlc3MiLCJleGVjUGF0aCIsImNvbW1hbmRQcm94eUNsaWVudFBhdGgiLCJpbnN0cnVtZW50c1NvY2siLCJzb2NrIiwiREVGQVVMVF9JTlNUUlVNRU5UU19TT0NLRVQiLCJpbnRlcktleURlbGF5IiwianVzdExvb3BJbmZpbml0ZWx5IiwiYXV0b0FjY2VwdEFsZXJ0cyIsImF1dG9EaXNtaXNzQWxlcnRzIiwic2VuZEtleVN0cmF0ZWd5IiwiaW5pdGlhbExvY2F0aW9uIiwiYnVpbGRDb2RlIiwiY29kZSIsImVudiIsImxvZ2dlciIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsImJvb3RzdHJhcEpzIiwiaW1wb3J0cyIsInByZSIsImJvb3RzdHJhcENvZGUiLCJsaW5lcyIsInB1c2giLCJfIiwidG9QYWlycyIsImtleSIsInZhbHVlIiwiaXNVbmRlZmluZWQiLCJxdW90ZSIsImlzU3RyaW5nIiwibGVuZ3RoIiwicmVwbGFjZSIsImpvaW4iLCJjb21wdXRlSGFzaCIsImNyeXB0byIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJzdWJzdHJpbmciLCJnZXREeW5hbWljQm9vdHN0cmFwRGlyIiwiZHluYW1pY0Jvb3RzdHJhcERpciIsIkFQUElVTV9CT09UU1RSQVBfRElSIiwiSE9NRSIsInRtcERpciIsIndyaXRlRHluYW1pY0Jvb3RzdHJhcElmTmVjZXNzYXJ5IiwiZHluYW1pY0Jvb3RzdHJhcFBhdGgiLCJoYXNoIiwiY29kZUlzR29vZCIsImV4aXN0aW5nQ29kZSIsImZzIiwicmVhZEZpbGUiLCJlcnIiLCJ3cml0ZUZpbGUiLCJmbGFnIiwicHJlcGFyZUJvb3Rz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SSxTQUFTRCxTQUFTLENBQUNkLElBQUQsQ0FBMUI7QUFDQSxRQUFJa0QsSUFBSSxHQUFHYixXQUFXLENBQUN0QixJQUFELENBQXRCOztBQUNBLFFBQUlrQyxvQkFBb0IsR0FBR3ZELGNBQUtDLE9BQUwsQ0FBYWlELG1CQUFiLEVBQW1DLGFBQVlNLElBQUssS0FBcEQsQ0FBM0I7O0FBQ0FqQyxvQkFBT0MsS0FBUCxDQUFjLDJCQUEwQkgsSUFBSSxDQUFDNEMsS0FBTCxDQUFXLElBQVgsRUFBaUIsQ0FBakIsQ0FBb0IsS0FBNUQ7O0FBQ0ExQyxvQkFBT0MsS0FBUCxDQUFjLDJCQUEwQitCLG9CQUFxQixFQUE3RDs7QUFDQSxVQUFNRCxnQ0FBZ0MsQ0FBQ0osbUJBQUQsRUFDcENLLG9CQURvQyxFQUNkbEMsSUFEYyxFQUNSbUMsSUFEUSxDQUF0QztBQUdBLFdBQU9ELG9CQUFQO0FBQ0QsRyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEdlbmVyYXRlIGEgYm9vdHN0cmFwIGZvciB0aGUgVUlBdXRvIEluc3RydW1lbnRzIHNjcmlwdCBjb250YWluaW5nXG4vLyB0aGUgZW52aXJvbm1lbnQgdmFyaWFibGVzIHdlIG5lZWQuXG5cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCB7IGZzLCBta2RpcnAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgYnVpbGRTY3JpcHQgZnJvbSAnLi9idWlsZC1zY3JpcHQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBERUZBVUxUX0lOU1RSVU1FTlRTX1NPQ0tFVCB9IGZyb20gJy4vdWlhdXRvLWNsaWVudCc7XG5cblxubGV0IEJPT1RTVFJBUF9KU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3VpYXV0bycsICdib290c3RyYXAuanMnKTtcbmxldCBDT01NQU5EX1BST1hZX0NMSUVOVF9QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2JpbicsICdjb21tYW5kLXByb3h5LWNsaWVudC5qcycpO1xuaWYgKCFfX2Rpcm5hbWUubWF0Y2goL2J1aWxkXFwvbGliXFwvdWlhdXRvJC8pKSB7XG4gIEJPT1RTVFJBUF9KU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3VpYXV0bycsICdib290c3RyYXAuanMnKTtcbiAgQ09NTUFORF9QUk9YWV9DTElFTlRfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdiaW4nLCAnY29tbWFuZC1wcm94eS1jbGllbnQuanMnKTtcbn1cblxuZnVuY3Rpb24gZ2V0RW52IChvcHRzID0ge30pIHtcbiAgLy8gYnVpbGQgYW4gb2JqZWN0IHdpdGggdGhlIHJlcXVpcmVkIHByb3BlcnRpZXMgZm9yIGJvb3RzdHJhcFxuICByZXR1cm4ge1xuICAgIG5vZGVQYXRoOiBwcm9jZXNzLmV4ZWNQYXRoLFxuICAgIGNvbW1hbmRQcm94eUNsaWVudFBhdGg6IENPTU1BTkRfUFJPWFlfQ0xJRU5UX1BBVEgsXG4gICAgaW5zdHJ1bWVudHNTb2NrOiBvcHRzLnNvY2sgfHwgREVGQVVMVF9JTlNUUlVNRU5UU19TT0NLRVQsXG4gICAgaW50ZXJLZXlEZWxheTogb3B0cy5pbnRlcktleURlbGF5IHx8IG51bGwsXG4gICAganVzdExvb3BJbmZpbml0ZWx5OiBvcHRzLmp1c3RMb29wSW5maW5pdGVseSxcbiAgICBhdXRvQWNjZXB0QWxlcnRzOiBvcHRzLmF1dG9BY2NlcHRBbGVydHMsXG4gICAgYXV0b0Rpc21pc3NBbGVydHM6IG9wdHMuYXV0b0Rpc21pc3NBbGVydHMsXG4gICAgc2VuZEtleVN0cmF0ZWd5OiBvcHRzLnNlbmRLZXlTdHJhdGVneSxcbiAgICBpbml0aWFsTG9jYXRpb246IG9wdHMuaW5pdGlhbExvY2F0aW9uLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZENvZGUgKG9wdHMpIHtcbiAgLy8gb25seSBidWlsZCB0aGUgY29kZSBpZiBpdCBoYXNuJ3QgYmVlbiBkb25lIGJlZm9yZVxuICBpZiAob3B0cy5jb2RlKSByZXR1cm4gb3B0cy5jb2RlO1xuXG4gIGxldCBlbnYgPSBnZXRFbnYob3B0cyk7XG4gIGxvZ2dlci5kZWJ1ZyhgRHluYW1pYyBlbnY6ICR7SlNPTi5zdHJpbmdpZnkoZW52KX1gKTtcblxuICBsZXQgYm9vdHN0cmFwSnMgPSBCT09UU1RSQVBfSlNfUEFUSDtcbiAgLy8gaWYgc3BlY2lhbCBpbXBvcnRzIHdlcmUgc2VudCBpbiwgbWFrZSB1c2Ugb2YgdGhlbVxuICBsZXQgaW1wb3J0cyA9IChvcHRzLmltcG9ydHMgJiYgb3B0cy5pbXBvcnRzLnByZSkgPyBvcHRzLmltcG9ydHMucHJlIDogW107XG4gIGxldCBib290c3RyYXBDb2RlID0gYXdhaXQgYnVpbGRTY3JpcHQoYm9vdHN0cmFwSnMsIGltcG9ydHMpO1xuXG4gIC8vIGdlbmVyYXRlIHRoZSBkeW5hbWljIHBhcnQgb2YgdGhlIGJvb3RzdHJhcCBjb2RlXG4gIC8vIHdpdGggdGhlIGVudmlyb25tZW50IHNldCB1cCBwcm9wZXJseVxuICBsZXQgbGluZXMgPSBbXTtcbiAgbGluZXMucHVzaCgnLy8gVGhpcyBmaWxlIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkLiBEbyBub3QgbWFudWFsbHkgbW9kaWZ5IScpO1xuICBsaW5lcy5wdXNoKCcnKTtcbiAgbGluZXMucHVzaChib290c3RyYXBDb2RlKTtcbiAgbGluZXMucHVzaCgnJyk7XG4gIGxpbmVzLnB1c2goJ2Jvb3RzdHJhcCh7Jyk7XG4gIC8vIGFkZCBlYWNoIGRlZmluZWQgdmFyaWFibGUgdG8gdGhlIGVudmlyb25tZW50XG4gIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoZW52KSkge1xuICAgIGlmICghXy5pc1VuZGVmaW5lZCh2YWx1ZSkpIHtcbiAgICAgIGxldCBxdW90ZSA9IF8uaXNTdHJpbmcodmFsdWUpID8gJ1xcXCInIDogJyc7XG4gICAgICBsaW5lcy5wdXNoKGAgIFwiJHtrZXl9XCI6ICR7cXVvdGV9JHt2YWx1ZX0ke3F1b3RlfSxgKTtcbiAgICB9XG4gIH1cbiAgLy8gZ2V0IHJpZCBvZiB0aGUgbGFzdCBjb21tYSB0aGF0IHdhcyBhZGRlZFxuICBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXSA9IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLnJlcGxhY2UoLywkLywgJycpO1xuICBsaW5lcy5wdXNoKCd9KTsnKTtcbiAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcclxcbicpO1xufVxuXG5mdW5jdGlvbiBjb21wdXRlSGFzaCAoY29kZSkge1xuICByZXR1cm4gY3J5cHRvXG4gICAgLmNyZWF0ZUhhc2goJ21kNScpXG4gICAgLnVwZGF0ZShjb2RlKVxuICAgIC5kaWdlc3QoJ2hleCcpXG4gICAgLnN1YnN0cmluZygwLCAxNik7XG59XG5cbmZ1bmN0aW9uIGdldER5bmFtaWNCb290c3RyYXBEaXIgKG9wdHMgPSB7fSkge1xuICAvLyBmaWd1cmluZyBvdXQgd2hlcmUgdG8gc3RvcmUgZHluYW1pYyBib290c3RyYXBcbiAgbGV0IGR5bmFtaWNCb290c3RyYXBEaXI7XG4gIGlmIChwcm9jZXNzLmVudi5BUFBJVU1fQk9PVFNUUkFQX0RJUikge1xuICAgIC8vIG1haW5seSBmb3IgdGVzdFxuICAgIGR5bmFtaWNCb290c3RyYXBEaXIgPSBwcm9jZXNzLmVudi5BUFBJVU1fQk9PVFNUUkFQX0RJUjtcbiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5IT01FKSB7XG4gICAgZHluYW1pY0Jvb3RzdHJhcERpciA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5IT01FLFxuICAgICAgJ0xpYnJhcnkvQXBwbGljYXRpb24gU3VwcG9ydC9hcHBpdW0vYm9vdHN0cmFwJyk7XG4gIH0gZWxzZSB7XG4gICAgLy8gbm8gdXNlciBkaXIsIHVzaW5nIHRtcFxuICAgIGR5bmFtaWNCb290c3RyYXBEaXIgPSBwYXRoLnJlc29sdmUob3B0cy50bXBEaXIgfHwgJy90bXAnLCAnYXBwaXVtL2Jvb3RzdHJhcCcpO1xuICB9XG4gIHJldHVybiBkeW5hbWljQm9vdHN0cmFwRGlyO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3cml0ZUR5bmFtaWNCb290c3RyYXBJZk5lY2Vzc2FyeSAoZHluYW1pY0Jvb3RzdHJhcERpciwgZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIGhhc2gpIHtcbiAgYXdhaXQgbWtkaXJwKGR5bmFtaWNCb290c3RyYXBEaXIpO1xuXG4gIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGV4aXN0aW5nIGNvZGUgYW5kIGl0IGhhcyB0aGUgc2FtZSBoYXNoXG4gIGxldCBjb2RlSXNHb29kID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBsZXQgZXhpc3RpbmdDb2RlID0gYXdhaXQgZnMucmVhZEZpbGUoZHluYW1pY0Jvb3RzdHJhcFBhdGgpO1xuICAgIGNvZGVJc0dvb2QgPSBjb21wdXRlSGFzaChleGlzdGluZ0NvZGUpID09PSBoYXNoO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb2RlSXNHb29kID0gZmFsc2U7XG4gIH1cblxuICAvLyB3cml0ZSBmaWxlIGlmIHRoZSBvbGQgY29kZSBpcyBub3QgdGhlIHNhbWVcbiAgaWYgKGNvZGVJc0dvb2QpIHtcbiAgICBsb2dnZXIuZGVidWcoYFJldXNpbmcgZHluYW1pYyBib290c3RyYXA6ICR7ZHluYW1pY0Jvb3RzdHJhcFBhdGh9YCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBDcmVhdGluZyBvciBvdmVyd3JpdGluZyBkeW5hbWljIGJvb3RzdHJhcDogJHtkeW5hbWljQm9vdHN0cmFwUGF0aH1gKTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIHtmbGFnOiAndysnfSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUJvb3RzdHJhcCAob3B0cyA9IHt9KSB7XG4gIGxvZ2dlci5kZWJ1ZygnUHJlcGFyaW5nIGJvb3RzdHJhcCBjb2RlJyk7XG5cbiAgbGV0IGR5bmFtaWNCb290c3RyYXBEaXIgPSBnZXREeW5hbWljQm9vdHN0cmFwRGlyKG9wdHMpO1xuICBsb2dnZXIuZGVidWcoYER5bmFtaWMgYm9vdHN0cmFwIGRpcjogJHtkeW5hbWljQm9vdHN0cmFwRGlyfWApO1xuXG4gIC8vIGJ1aWxkaW5nIGNvZGUgYW5kIGhhc2hcbiAgbGV0IGNvZGUgPSBhd2FpdCBidWlsZENvZGUob3B0cyk7XG4gIGxldCBoYXNoID0gY29tcHV0ZUhhc2goY29kZSk7XG4gIGxldCBkeW5hbWljQm9vdHN0cmFwUGF0aCA9IHBhdGgucmVzb2x2ZShkeW5hbWljQm9vdHN0cmFwRGlyLCBgYm9vdHN0cmFwLSR7aGFzaH0uanNgKTtcbiAgbG9nZ2VyLmRlYnVnKGBEeW5hbWljIGJvb3RzdHJhcCBjb2RlOiAke2NvZGUuc3BsaXQoJ1xcbicpWzBdfS4uLmApO1xuICBsb2dnZXIuZGVidWcoYER5bmFtaWMgYm9vdHN0cmFwIHBhdGg6ICR7ZHluYW1pY0Jvb3RzdHJhcFBhdGh9YCk7XG4gIGF3YWl0IHdyaXRlRHluYW1pY0Jvb3RzdHJhcElmTmVjZXNzYXJ5KGR5bmFtaWNCb290c3RyYXBEaXIsXG4gICAgZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIGhhc2gpO1xuXG4gIHJldHVybiBkeW5hbWljQm9vdHN0cmFwUGF0aDtcbn1cblxuZXhwb3J0IHsgcHJlcGFyZUJvb3RzdHJhcCwgZ2V0RW52IH07XG4iXSwiZmlsZSI6ImxpYi91aWF1dG8vZHluYW1pYy1ib290c3RyYXAuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
