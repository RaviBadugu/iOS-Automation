"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _through = require("through");

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _utils = require("./utils");

var _streams = require("./streams");

require("colors");

const ERR_NEVER_CHECKED_IN = 'Instruments never checked in';
const ERR_CRASHED_ON_STARTUP = 'Instruments crashed on startup';
const ERR_AMBIGUOUS_DEVICE = 'Instruments Usage Error : Ambiguous device name/identifier';

class Instruments {
  static quickInstruments(opts) {
    return (0, _asyncToGenerator2.default)(function* () {
      opts = _lodash.default.clone(opts);
      let xcodeTraceTemplatePath = yield _appiumXcode.default.getAutomationTraceTemplatePath();

      _lodash.default.defaults(opts, {
        launchTimeout: 60000,
        template: xcodeTraceTemplatePath,
        withoutDelay: true,
        xcodeVersion: '8.1',
        webSocket: null,
        flakeyRetries: 2
      });

      return new Instruments(opts);
    })();
  }

  constructor(opts) {
    opts = _lodash.default.cloneDeep(opts);

    _lodash.default.defaults(opts, {
      termTimeout: 5000,
      tmpDir: '/tmp/appium-instruments',
      launchTimeout: 90000,
      flakeyRetries: 0,
      realDevice: false
    });

    const props = ['app', 'termTimeout', 'flakeyRetries', 'udid', 'bootstrap', 'template', 'withoutDelay', 'processArguments', 'realDevice', 'simulatorSdkAndDevice', 'tmpDir', 'traceDir', 'locale', 'language'];

    for (var _i = 0; _i < props.length; _i++) {
      const f = props[_i];
      this[f] = opts[f];
    }

    this.traceDir = this.traceDir || this.tmpDir;
    this.launchTimeout = (0, _utils.parseLaunchTimeout)(opts.launchTimeout);
    this.proc = null;
    this.webSocket = opts.webSocket;
    this.instrumentsPath = opts.instrumentsPath;
    this.launchTries = 0;
    this.socketConnectDelays = [];
    this.gotFBSOpenApplicationError = false;
    this.onShutdown = new _bluebird.default((resolve, reject) => {
      this.onShutdownDeferred = {
        resolve,
        reject
      };
    });
    this.onShutdown.catch(() => {}).done();
  }

  configure() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_this.xcodeVersion) {
        _this.xcodeVersion = yield _appiumXcode.default.getVersion(true);
      }

      if (_this.xcodeVersion.versionFloat === 6.0 && _this.withoutDelay) {
        _logger.default.info('In xcode 6.0, instruments-without-delay does not work. ' + 'If using Appium, you can disable instruments-without-delay ' + 'with the --native-instruments-lib server flag');
      }

      if (_this.xcodeVersion.versionString === '5.0.1') {
        throw new Error('Xcode 5.0.1 ships with a broken version of ' + 'Instruments. please upgrade to 5.0.2');
      }

      if (_this.xcodeVersion.major > 7) {
        throw new Error(`Instruments-based automation was removed in Xcode 8. ` + `Xcode ${_this.xcodeVersion.versionString} is not supported. ` + `Please try the XCUItest driver.`);
      }

      if (!_this.template) {
        _this.template = yield _appiumXcode.default.getAutomationTraceTemplatePath();
      }

      if (!_this.instrumentsPath) {
        _this.instrumentsPath = yield (0, _utils.getInstrumentsPath)();
      }
    })();
  }

  launchOnce() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.info('Launching instruments');

      yield _appiumSupport.fs.rimraf(_this2.tmpDir);
      yield (0, _appiumSupport.mkdirp)(_this2.tmpDir);
      yield (0, _appiumSupport.mkdirp)(_this2.traceDir);
      _this2.exitListener = null;
      _this2.proc = yield _this2.spawnInstruments();

      _this2.proc.on('exit', (code, signal) => {
        const msg = code !== null ? `code: ${code}` : `signal: ${signal}`;

        _logger.default.debug(`Instruments exited with ${msg}`);
      });

      let launchResultPromise = new _bluebird.default((resolve, reject) => {
        _this2.launchResultDeferred = {
          resolve,
          reject
        };
      });

      _this2.setExitListener(() => {
        _this2.proc = null;

        _this2.launchResultDeferred.reject(new Error(ERR_CRASHED_ON_STARTUP));
      });

      _this2.proc.on('error', err => {
        _logger.default.debug(`Error with instruments proc: ${err.message}`);

        if (err.message.indexOf('ENOENT') !== -1) {
          _this2.proc = null;

          _logger.default.error(`Unable to spawn instruments: ${err.message}`);

          _this2.launchResultDeferred.reject(err);
        }
      });

      _this2.proc.stdout.setEncoding('utf8');

      _this2.proc.stdout.pipe((0, _streams.outputStream)()).pipe((0, _streams.dumpStream)());

      _this2.proc.stderr.setEncoding('utf8');

      let actOnStderr = output => {
        if (_this2.launchTimeout.afterSimLaunch && output && output.match(/CLTilesManagerClient: initialize/)) {
          _this2.addSocketConnectTimer(_this2.launchTimeout.afterSimLaunch, 'afterLaunch', (0, _asyncToGenerator2.default)(function* () {
            yield _this2.killInstruments();

            _this2.launchResultDeferred.reject(new Error(ERR_NEVER_CHECKED_IN));
          }));
        }

        let fbsErrStr = '(FBSOpenApplicationErrorDomain error 8.)';

        if (output.indexOf(fbsErrStr) !== -1) {
          _this2.gotFBSOpenApplicationError = true;
        }

        if (output.indexOf(ERR_AMBIGUOUS_DEVICE) !== -1) {
          let msg = `${ERR_AMBIGUOUS_DEVICE}: '${_this2.simulatorSdkAndDevice}'`;

          _this2.launchResultDeferred.reject(new Error(msg));
        }
      };

      _this2.proc.stderr.pipe((0, _through.through)(function (output) {
        actOnStderr(output);
        this.queue(output);
      })).pipe((0, _streams.errorStream)()).pipe((0, _streams.webSocketAlertStream)(_this2.webSocket)).pipe((0, _streams.dumpStream)());

      _this2.addSocketConnectTimer(_this2.launchTimeout.global, 'global', (0, _asyncToGenerator2.default)(function* () {
        yield _this2.killInstruments();

        _this2.launchResultDeferred.reject(new Error(ERR_NEVER_CHECKED_IN));
      }));

      try {
        yield launchResultPromise;
      } finally {
        _this2.clearSocketConnectTimers();
      }

      _this2.setExitListener((code, signal) => {
        _this2.proc = null;
        const msg = code !== null ? `code: ${code}` : `signal: ${signal}`;

        _this2.onShutdownDeferred.reject(new Error(`Abnormal exit with ${msg}`));
      });
    })();
  }

  launch() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      yield _this3.configure();
      let launchTries = 0;

      do {
        launchTries++;

        _logger.default.debug(`Attempting to launch instruments, this is try #${launchTries}`);

        try {
          yield _this3.launchOnce();
          break;
        } catch (err) {
          _logger.default.error(`Error launching instruments: ${err.message}`);

          let errIsCatchable = err.message === ERR_NEVER_CHECKED_IN || err.message === ERR_CRASHED_ON_STARTUP;

          if (!errIsCatchable) {
            throw err;
          }

          if (launchTries <= _this3.flakeyRetries) {
            if (_this3.gotFBSOpenApplicationError) {
              _logger.default.debug('Got the FBSOpenApplicationError, not killing the ' + 'sim but leaving it open so the app will launch');

              _this3.gotFBSOpenApplicationError = false;
              yield _bluebird.default.delay(1000);
            } else {
              if (!_this3.realDevice) {
                yield (0, _appiumIosSimulator.killAllSimulators)();
              }

              yield _bluebird.default.delay(5000);
            }
          } else {
            _logger.default.errorAndThrow('We exceeded the number of retries allowed for ' + 'instruments to successfully start; failing launch');
          }
        }
      } while (true);
    })();
  }

  registerLaunch() {
    this.launchResultDeferred.resolve();
  }

  spawnInstruments() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let traceDir;

      for (let i = 0;; i++) {
        traceDir = _path.default.resolve(_this4.traceDir, `instrumentscli${i}.trace`);
        if (!(yield _appiumSupport.fs.exists(traceDir))) break;
      }

      let args = ['-t', _this4.template, '-D', traceDir];

      if (_this4.udid) {
        args = args.concat(['-w', _this4.udid]);

        _logger.default.debug(`Attempting to run app on real device with UDID '${_this4.udid}'`);
      }

      if (!_this4.udid && _this4.simulatorSdkAndDevice) {
        args = args.concat(['-w', _this4.simulatorSdkAndDevice]);

        _logger.default.debug(`Attempting to run app on ${_this4.simulatorSdkAndDevice}`);
      }

      args = args.concat([_this4.app]);

      if (_this4.processArguments) {
        _logger.default.debug(`Attempting to run app with process arguments: ${JSON.stringify(_this4.processArguments)}`);

        if (_lodash.default.isString(_this4.processArguments)) {
          if (_this4.processArguments.indexOf('-e ') === -1) {
            _logger.default.debug('Plain string process arguments being pushed into arguments');

            args.push(_this4.processArguments);
          } else {
            _logger.default.debug('Environment variables being pushed into arguments');

            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = _this4.processArguments.split('-e ')[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                let arg = _step.value;
                arg = arg.trim();

                if (arg.length) {
                  let space = arg.indexOf(' ');
                  let flag = arg.substring(0, space);
                  let value = arg.substring(space + 1);
                  args.push('-e', flag, value);
                }
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator.return != null) {
                  _iterator.return();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          }
        } else {
          var _iteratorNormalCompletion2 = true;
          var _didIteratorError2 = false;
          var _iteratorError2 = undefined;

          try {
            for (var _iterator2 = _lodash.default.toPairs(_this4.processArguments)[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              let _step2$value = (0, _slicedToArray2.default)(_step2.value, 2),
                  flag = _step2$value[0],
                  value = _step2$value[1];

              args.push('-e', flag, value);
            }
          } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
                _iterator2.return();
              }
            } finally {
              if (_didIteratorError2) {
                throw _iteratorError2;
              }
            }
          }
        }
      }

      args = args.concat(['-e', 'UIASCRIPT', _this4.bootstrap]);
      args = args.concat(['-e', 'UIARESULTSPATH', _this4.tmpDir]);

      if (_this4.language) {
        args = args.concat([`-AppleLanguages (${_this4.language})`]);
        args = args.concat([`-NSLanguages (${_this4.language})`]);
      }

      if (_this4.locale) {
        args = args.concat([`-AppleLocale ${_this4.locale}`]);
      }

      let env = _lodash.default.clone(process.env);

      if (_this4.xcodeVersion.major >= 7 && !_this4.udid) {
        _logger.default.info("On xcode 7.0+, instruments-without-delay does not work, " + "skipping instruments-without-delay");

        _this4.withoutDelay = false;
      }

      let iwdPath = yield (0, _utils.getIwdPath)(_this4.xcodeVersion.major);
      env.CA_DEBUG_TRANSACTIONS = 1;

      if (_this4.withoutDelay && !_this4.udid) {
        env.DYLD_INSERT_LIBRARIES = _path.default.resolve(iwdPath, 'InstrumentsShim.dylib');
        env.LIB_PATH = iwdPath;
      }

      let instrumentsExecArgs = [_this4.instrumentsPath, ...args];
      instrumentsExecArgs = _lodash.default.map(instrumentsExecArgs, function (arg) {
        if (arg === null) {
          throw new Error('A null value was passed as an arg to execute ' + 'instruments on the command line. A letiable is ' + 'probably not getting set. Array of command args: ' + JSON.stringify(instrumentsExecArgs));
        }

        if (_lodash.default.isString(arg) && arg.indexOf(' ') !== -1) {
          return `"${arg}"`;
        }

        return arg;
      });

      _logger.default.debug(`Spawning instruments with command: '${instrumentsExecArgs.join(' ')}'`);

      if (_this4.withoutDelay) {
        _logger.default.debug('And extra without-delay env: ' + JSON.stringify({
          DYLD_INSERT_LIBRARIES: env.DYLD_INSERT_LIBRARIES,
          LIB_PATH: env.LIB_PATH
        }));
      }

      _logger.default.debug(`And launch timeouts (in ms): ${JSON.stringify(_this4.launchTimeout)}`);

      return yield (0, _teen_process.spawn)(_this4.instrumentsPath, args, {
        env
      });
    })();
  }

  addSocketConnectTimer(delay, type, doAction) {
    let socketConnectDelay = (0, _appiumSupport.cancellableDelay)(delay);
    socketConnectDelay.then(() => {
      _logger.default.warn(`Instruments socket client never checked in; timing out (${type})`);

      return doAction();
    }).catch(_bluebird.default.CancellationError, () => {}).done();
    this.socketConnectDelays.push(socketConnectDelay);
  }

  clearSocketConnectTimers() {
    var _iteratorNormalCompletion3 = true;
    var _didIteratorError3 = false;
    var _iteratorError3 = undefined;

    try {
      for (var _iterator3 = this.socketConnectDelays[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
        let delay = _step3.value;
        delay.cancel();
      }
    } catch (err) {
      _didIteratorError3 = true;
      _iteratorError3 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion3 && _iterator3.return != null) {
          _iterator3.return();
        }
      } finally {
        if (_didIteratorError3) {
          throw _iteratorError3;
        }
      }
    }

    this.socketConnectDelays = [];
  }

  setExitListener(exitListener) {
    if (!this.proc) return;

    if (this.exitListener) {
      this.proc.removeListener('exit', this.exitListener);
    }

    this.exitListener = exitListener;
    this.proc.on('exit', exitListener);
  }

  killInstruments() {
    var _this5 = this;

    if (!this.proc) return;

    _logger.default.debug(`Kill Instruments process (pid: ${this.proc.pid})`);

    return new _bluebird.default(function () {
      var _ref3 = (0, _asyncToGenerator2.default)(function* (resolve) {
        let wasTerminated = false;
        let termDelay = (0, _appiumSupport.cancellableDelay)(_this5.termTimeout);
        let termPromise = termDelay.catch(_bluebird.default.CancellationError, () => {});

        _this5.setExitListener(() => {
          _this5.proc = null;
          wasTerminated = true;
          termDelay.cancel();
          resolve();
        });

        _logger.default.debug('Sending SIGTERM');

        _this5.proc.kill('SIGTERM');

        yield termPromise;

        if (!wasTerminated) {
          _logger.default.warn(`Instruments did not terminate after ${_this5.termTimeout / 1000} seconds!`);

          _logger.default.debug('Sending SIGKILL');

          _this5.proc.kill('SIGKILL');

          if (_lodash.default.isFunction(_this5.exitListener)) {
            _this5.exitListener();
          }
        }
      });

      return function (_x) {
        return _ref3.apply(this, arguments);
      };
    }());
  }

  shutdown() {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug('Starting shutdown.');

      yield _this6.killInstruments();

      _this6.onShutdownDeferred.resolve();
    })();
  }

}

var _default = Instruments;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0cnVtZW50cy9pbnN0cnVtZW50cy5qcyJdLCJuYW1lcyI6WyJFUlJfTkVWRVJfQ0hFQ0tFRF9JTiIsIkVSUl9DUkFTSEVEX09OX1NUQVJUVVAiLCJFUlJfQU1CSUdVT1VTX0RFVklDRSIsIkluc3RydW1lbnRzIiwicXVpY2tJbnN0cnVtZW50cyIsIm9wdHMiLCJfIiwiY2xvbmUiLCJ4Y29kZVRyYWNlVGVtcGxhdGVQYXRoIiwieGNvZGUiLCJnZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgiLCJkZWZhdWx0cyIsImxhdW5jaFRpbWVvdXQiLCJ0ZW1wbGF0ZSIsIndpdGhvdXREZWxheSIsInhjb2RlVmVyc2lvbiIsIndlYlNvY2tldCIsImZsYWtleVJldHJpZXMiLCJjb25zdHJ1Y3RvciIsImNsb25lRGVlcCIsInRlcm1UaW1lb3V0IiwidG1wRGlyIiwicmVhbERldmljZSIsInByb3BzIiwiZiIsInRyYWNlRGlyIiwicHJvYyIsImluc3RydW1lbnRzUGF0aCIsImxhdW5jaFRyaWVzIiwic29ja2V0Q29ubmVjdERlbGF5cyIsImdvdEZCU09wZW5BcHBsaWNhdGlvbkVycm9yIiwib25TaHV0ZG93biIsIkIiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25TaHV0ZG93bkRlZmVycmVkIiwiY2F0Y2giLCJkb25lIiwiY29uZmlndXJlIiwiZ2V0VmVyc2lvbiIsInZlcnNpb25GbG9hdCIsImxvZyIsImluZm8iLCJ2ZXJzaW9uU3RyaW5nIiwiRXJyb3IiLCJtYWpvciIsImxhdW5jaE9uY2UiLCJmcyIsInJpbXJhZiIsImV4aXRMaXN0ZW5lciIsInNwYXduSW5zdHJ1bWVudHMiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJtc2ciLCJkZWJ1ZyIsImxhdW5jaFJlc3VsdFByb21pc2UiLCJsYXVuY2hSZXN1bHREZWZlcnJlZCIsInNldEV4aXRMaXN0ZW5lciIsImVyciIsIm1lc3NhZ2UiLCJpbmRleE9mIiwiZXJyb3IiLCJzdGRvdXQiLCJzZXRFbmNvZGluZyIsInBpcGUiLCJzdGRlcnIiLCJhY3RPblN0ZGVyciIsIm91dHB1dCIsImFmdGVyU2ltTGF1bmNoIiwibWF0Y2giLCJhZGRTb2NrZXRDb25uZWN0VGltZXIiLCJraWxsSW5zdHJ1bWVudHMiLCJmYnNFcnJTdHIiLCJzaW11bGF0b3JTZGtBbmREZXZpY2UiLCJxdWV1ZSIsImdsb2JhbCIsImNsZWFyU29ja2V0Q29ubmVjdFRpbWVycyIsImxhdW5jaCIsImVycklzQ2F0Y2hhYmxlIiwiZGVsYXkiLCJlcnJvckFuZFRocm93IiwicmVnaXN0ZXJMYXVuY2giLCJpIiwicGF0aCIsImV4aXN0cyIsImFyZ3MiLCJ1ZGlkIiwiY29uY2F0IiwiYXBwIiwicHJvY2Vzc0FyZ3VtZW50cyIsIkpTT04iLCJzdHJpbmdpZnkiLCJpc1N0cmluZyIsInB1c2giLCJzcGxpdCIsImFyZyIsInRyaW0iLCJsZW5ndGgiLCJzcGFjZSIsImZsYWciLCJzdWJzdHJpbmciLCJ2YWx1ZSIsInRvUGFpcnMiLCJib290c3RyYXAiLCJsYW5ndWFnZSIsImxvY2FsZSIsImVudiIsInByb2Nlc3MiLCJpd2RQYXRoIiwiQ0FfREVCVUdfVFJBTlNBQ1RJT05TIiwiRFlMRF9JTlNFUlRfTElCUkFSSUVTIiwiTElCX1BBVEgiLCJpbnN0cnVtZW50c0V4ZWNBcmdzIiwibWFwIiwiam9pbiIsInR5cGUiLCJkb0FjdGlvbiIsInNvY2tldENvbm5lY3REZWxheSIsInRoZW4iLCJ3YXJuIiwiQ2FuY2VsbGF0aW9uRXJyb3IiLCJjYW5jZWwiLCJyZW1vdmVMaXN0ZW5lciIsInBpZCIsIndhc1Rlcm1pbmF0ZWQiLCJ0ZXJtRGVsYXkiLCJ0ZXJtUHJvbWlzZSIsImtpbGwiLCJpc0Z1bmN0aW9uIiwic2h1dGRvd24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxvQkFBb0IsR0FBRyw4QkFBN0I7QUFDQSxNQUFN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cEcsV0FBTCxHQUFtQixJQUFLLFdBQXhFOztBQUNBcUIsMEJBQUljLEtBQUosQ0FBVSxpQkFBVjs7QUFDQSxVQUFBLE1BQUksQ0FBQzdCLElBQUwsQ0FBVXNHLElBQVYsQ0FBZSxTQUFmOztBQUNBLGNBQUkxSCxnQkFBRTJILFVBQUYsQ0FBYSxNQUFJLENBQUNoRixZQUFsQixDQUFKLEVBQXFDO0FBQ25DLFlBQUEsTUFBSSxDQUFDQSxZQUFMO0FBQ0Q7QUFDRjtBQUNGLE9BdEJNOztBQUFBO0FBQUE7QUFBQTtBQUFBLFFBQVA7QUF1QkQ7O0FBR0tpRixFQUFBQSxRQUFOLEdBQWtCO0FBQUE7O0FBQUE7QUFDaEJ6RixzQkFBSWMsS0FBSixDQUFVLG9CQUFWOztBQUNBLFlBQU0sTUFBSSxDQUFDaUIsZUFBTCxFQUFOOztBQUNBLE1BQUEsTUFBSSxDQUFDckMsa0JBQUwsQ0FBd0JGLE9BQXhCO0FBSGdCO0FBSWpCOztBQTdYZTs7ZUFnWUg5QixXIiwic291cmNlc0NvbnRlbnQiOlsiLy8gV3JhcHBlciBhcm91bmQgQXBwbGUncyBJbnN0cnVtZW50cyBhcHBcblxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdGhyb3VnaCB9IGZyb20gJ3Rocm91Z2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBta2RpcnAsIGZzLCBjYW5jZWxsYWJsZURlbGF5IH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHhjb2RlIGZyb20gJ2FwcGl1bS14Y29kZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBraWxsQWxsU2ltdWxhdG9ycyB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCB7IGdldEluc3RydW1lbnRzUGF0aCwgcGFyc2VMYXVuY2hUaW1lb3V0LCBnZXRJd2RQYXRoIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBvdXRwdXRTdHJlYW0sIGVycm9yU3RyZWFtLCB3ZWJTb2NrZXRBbGVydFN0cmVhbSwgZHVtcFN0cmVhbSB9IGZyb20gJy4vc3RyZWFtcyc7XG5pbXBvcnQgJ2NvbG9ycyc7XG5cblxuY29uc3QgRVJSX05FVkVSX0NIRUNLRURfSU4gPSAnSW5zdHJ1bWVudHMgbmV2ZXIgY2hlY2tlZCBpbic7XG5jb25zdCBFUlJfQ1JBU0hFRF9PTl9TVEFSVFVQID0gJ0luc3RydW1lbnRzIGNyYXNoZWQgb24gc3RhcnR1cCc7XG5jb25zdCBFUlJfQU1CSUdVT1VTX0RFVklDRSA9ICdJbnN0cnVtZW50cyBVc2FnZSBFcnJvciA6IEFtYmlndW91cyBkZXZpY2UgbmFtZS9pZGVudGlmaWVyJztcblxuY2xhc3MgSW5zdHJ1bWVudHMge1xuICAvLyBzaW1wbGUgZmFjdG9yeSB3aXRoIHNhbmUgZGVmYXVsdHNcbiAgc3RhdGljIGFzeW5jIHF1aWNrSW5zdHJ1bWVudHMgKG9wdHMpIHtcbiAgICBvcHRzID0gXy5jbG9uZShvcHRzKTtcbiAgICBsZXQgeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICAgIF8uZGVmYXVsdHMob3B0cywge1xuICAgICAgbGF1bmNoVGltZW91dDogNjAwMDAsXG4gICAgICB0ZW1wbGF0ZTogeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCxcbiAgICAgIHdpdGhvdXREZWxheTogdHJ1ZSxcbiAgICAgIHhjb2RlVmVyc2lvbjogJzguMScsXG4gICAgICB3ZWJTb2NrZXQ6IG51bGwsXG4gICAgICBmbGFrZXlSZXRyaWVzOiAyXG4gICAgfSk7XG4gICAgcmV0dXJuIG5ldyBJbnN0cnVtZW50cyhvcHRzKTtcbiAgfVxuXG4gIC8qXG4gICAqIG9wdHM6XG4gICAqICAgLSBhcHBcbiAgICogICAtIHRlcm1UaW1lb3V0IC0gZGVmYXVsdHMgdG8gNTAwMFxuICAgKiAgIC0gZmxha2V5UmV0cmllcyAtIGRlZmF1bHRzIHRvIDBcbiAgICogICAtIHVkaWRcbiAgICogICAtIGJvb3RzdHJhcFxuICAgKiAgIC0gdGVtcGxhdGVcbiAgICogICAtIHdpdGhvdXREZWxheVxuICAgKiAgIC0gcHJvY2Vzc0FyZ3VtZW50c1xuICAgKiAgIC0gc2ltdWxhdG9yU2RrQW5kRGV2aWNlXG4gICAqICAgLSB0bXBEaXIgLSBkZWZhdWx0cyB0byBgL3RtcC9hcHBpdW0taW5zdHJ1bWVudHNgXG4gICAqICAgLSB0cmFjZURpclxuICAgKiAgIC0gbGF1bmNoVGltZW91dCAtIGRlZmF1bHRzIHRvIDkwMDAwXG4gICAqICAgLSB3ZWJTb2NrZXRcbiAgICogICAtIGluc3RydW1lbnRzUGF0aFxuICAgKiAgIC0gcmVhbERldmljZSAtIHRydWUvZmFsc2UsIGRlZmF1bHRzIHRvIGZhbHNlXG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cykge1xuICAgIG9wdHMgPSBfLmNsb25lRGVlcChvcHRzKTtcbiAgICBfLmRlZmF1bHRzKG9wdHMsIHtcbiAgICAgIHRlcm1UaW1lb3V0OiA1MDAwLFxuICAgICAgdG1wRGlyOiAnL3RtcC9hcHBpdW0taW5zdHJ1bWVudHMnLFxuICAgICAgbGF1bmNoVGltZW91dDogOTAwMDAsXG4gICAgICBmbGFrZXlSZXRyaWVzOiAwLFxuICAgICAgcmVhbERldmljZTogZmFsc2VcbiAgICB9KTtcblxuICAgIC8vIGNvbmZpZ1xuICAgIGNvbnN0IHByb3BzID0gW1xuICAgICAgJ2FwcCcsICd0ZXJtVGltZW91dCcsICdmbGFrZXlSZXRyaWVzJywgJ3VkaWQnLCAnYm9vdHN0cmFwJyxcbiAgICAgICd0ZW1wbGF0ZScsICd3aXRob3V0RGVsYXknLCAncHJvY2Vzc0FyZ3VtZW50cycsICdyZWFsRGV2aWNlJyxcbiAgICAgICdzaW11bGF0b3JTZGtBbmREZXZpY2UnLCAndG1wRGlyJywgJ3RyYWNlRGlyJywgJ2xvY2FsZScsICdsYW5ndWFnZScsXG4gICAgXTtcbiAgICBmb3IgKGNvbnN0IGYgb2YgcHJvcHMpIHtcbiAgICAgIHRoaXNbZl0gPSBvcHRzW2ZdO1xuICAgIH1cbiAgICB0aGlzLnRyYWNlRGlyID0gdGhpcy50cmFjZURpciB8fCB0aGlzLnRtcERpcjtcbiAgICB0aGlzLmxhdW5jaFRpbWVvdXQgPSBwYXJzZUxhdW5jaFRpbWVvdXQob3B0cy5sYXVuY2hUaW1lb3V0KTtcblxuICAgIC8vIHN0YXRlXG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLndlYlNvY2tldCA9IG9wdHMud2ViU29ja2V0O1xuICAgIHRoaXMuaW5zdHJ1bWVudHNQYXRoID0gb3B0cy5pbnN0cnVtZW50c1BhdGg7XG4gICAgdGhpcy5sYXVuY2hUcmllcyA9IDA7XG4gICAgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzID0gW107XG4gICAgdGhpcy5nb3RGQlNPcGVuQXBwbGljYXRpb25FcnJvciA9IGZhbHNlO1xuICAgIHRoaXMub25TaHV0ZG93biA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMub25TaHV0ZG93bkRlZmVycmVkID0ge3Jlc29sdmUsIHJlamVjdH07XG4gICAgfSk7XG4gICAgLy8gYXZvaWRzIFVuaGFuZGxlZEV4Y2VwdGlvblxuICAgIHRoaXMub25TaHV0ZG93bi5jYXRjaCgoKSA9PiB7fSkuZG9uZSgpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvY2F0Y2gtb3ItcmV0dXJuXG4gIH1cblxuICBhc3luYyBjb25maWd1cmUgKCkge1xuICAgIGlmICghdGhpcy54Y29kZVZlcnNpb24pIHtcbiAgICAgIHRoaXMueGNvZGVWZXJzaW9uID0gYXdhaXQgeGNvZGUuZ2V0VmVyc2lvbih0cnVlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMueGNvZGVWZXJzaW9uLnZlcnNpb25GbG9hdCA9PT0gNi4wICYmIHRoaXMud2l0aG91dERlbGF5KSB7XG4gICAgICBsb2cuaW5mbygnSW4geGNvZGUgNi4wLCBpbnN0cnVtZW50cy13aXRob3V0LWRlbGF5IGRvZXMgbm90IHdvcmsuICcgK1xuICAgICAgICAgICAgICAgJ0lmIHVzaW5nIEFwcGl1bSwgeW91IGNhbiBkaXNhYmxlIGluc3RydW1lbnRzLXdpdGhvdXQtZGVsYXkgJyArXG4gICAgICAgICAgICAgICAnd2l0aCB0aGUgLS1uYXRpdmUtaW5zdHJ1bWVudHMtbGliIHNlcnZlciBmbGFnJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nID09PSAnNS4wLjEnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1hjb2RlIDUuMC4xIHNoaXBzIHdpdGggYSBicm9rZW4gdmVyc2lvbiBvZiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnSW5zdHJ1bWVudHMuIHBsZWFzZSB1cGdyYWRlIHRvIDUuMC4yJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi5tYWpvciA+IDcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW5zdHJ1bWVudHMtYmFzZWQgYXV0b21hdGlvbiB3YXMgcmVtb3ZlZCBpbiBYY29kZSA4LiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgWGNvZGUgJHt0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nfSBpcyBub3Qgc3VwcG9ydGVkLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgUGxlYXNlIHRyeSB0aGUgWENVSXRlc3QgZHJpdmVyLmApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy50ZW1wbGF0ZSkge1xuICAgICAgdGhpcy50ZW1wbGF0ZSA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pbnN0cnVtZW50c1BhdGgpIHtcbiAgICAgIHRoaXMuaW5zdHJ1bWVudHNQYXRoID0gYXdhaXQgZ2V0SW5zdHJ1bWVudHNQYXRoKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbGF1bmNoT25jZSAoKSB7XG4gICAgbG9nLmluZm8oJ0xhdW5jaGluZyBpbnN0cnVtZW50cycpO1xuICAgIC8vIHByZXBhcmUgdGVtcCBkaXJcbiAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy50bXBEaXIpO1xuICAgIGF3YWl0IG1rZGlycCh0aGlzLnRtcERpcik7XG4gICAgYXdhaXQgbWtkaXJwKHRoaXMudHJhY2VEaXIpO1xuXG4gICAgdGhpcy5leGl0TGlzdGVuZXIgPSBudWxsO1xuICAgIHRoaXMucHJvYyA9IGF3YWl0IHRoaXMuc3Bhd25JbnN0cnVtZW50cygpO1xuICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGNvbnN0IG1zZyA9IGNvZGUgIT09IG51bGwgPyBgY29kZTogJHtjb2RlfWAgOiBgc2lnbmFsOiAke3NpZ25hbH1gO1xuICAgICAgbG9nLmRlYnVnKGBJbnN0cnVtZW50cyBleGl0ZWQgd2l0aCAke21zZ31gKTtcbiAgICB9KTtcblxuICAgIC8vIHNldCB1cCB0aGUgcHJvbWlzZSB0byBoYW5kbGUgbGF1bmNoXG4gICAgbGV0IGxhdW5jaFJlc3VsdFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmxhdW5jaFJlc3VsdERlZmVycmVkID0ge3Jlc29sdmUsIHJlamVjdH07XG4gICAgfSk7XG5cbiAgICAvLyBUaGVyZSB3YXMgYSBzcGVjaWFsIGNhc2UgZm9yIGlnbm9yZVN0YXJ0dXBFeGl0XG4gICAgLy8gYnV0IGl0IGlzIG5vdCBuZWVkZWQgYW55bW9yZSwgeW91IG1heSBqdXN0IGxpc3RlbiBmb3IgZXhpdC5cbiAgICB0aGlzLnNldEV4aXRMaXN0ZW5lcigoKSA9PiB7XG4gICAgICB0aGlzLnByb2MgPSBudWxsO1xuICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKEVSUl9DUkFTSEVEX09OX1NUQVJUVVApKTtcbiAgICB9KTtcblxuICAgIHRoaXMucHJvYy5vbignZXJyb3InLCAoZXJyKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICBsb2cuZGVidWcoYEVycm9yIHdpdGggaW5zdHJ1bWVudHMgcHJvYzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9FTlQnKSAhPT0gLTEpIHtcbiAgICAgICAgdGhpcy5wcm9jID0gbnVsbDsgLy8gb3RoZXJ3aXNlIHdlJ2xsIHRyeSB0byBzZW5kIHNpZ2tpbGxcbiAgICAgICAgbG9nLmVycm9yKGBVbmFibGUgdG8gc3Bhd24gaW5zdHJ1bWVudHM6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgIHRoaXMubGF1bmNoUmVzdWx0RGVmZXJyZWQucmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLnByb2Muc3Rkb3V0LnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgdGhpcy5wcm9jLnN0ZG91dC5waXBlKG91dHB1dFN0cmVhbSgpKS5waXBlKGR1bXBTdHJlYW0oKSk7XG5cbiAgICB0aGlzLnByb2Muc3RkZXJyLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgbGV0IGFjdE9uU3RkZXJyID0gKG91dHB1dCkgPT4ge1xuICAgICAgaWYgKHRoaXMubGF1bmNoVGltZW91dC5hZnRlclNpbUxhdW5jaCAmJiBvdXRwdXQgJiYgb3V0cHV0Lm1hdGNoKC9DTFRpbGVzTWFuYWdlckNsaWVudDogaW5pdGlhbGl6ZS8pKSB7XG4gICAgICAgIHRoaXMuYWRkU29ja2V0Q29ubmVjdFRpbWVyKHRoaXMubGF1bmNoVGltZW91dC5hZnRlclNpbUxhdW5jaCwgJ2FmdGVyTGF1bmNoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGF3YWl0IHRoaXMua2lsbEluc3RydW1lbnRzKCk7XG4gICAgICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKEVSUl9ORVZFUl9DSEVDS0VEX0lOKSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBsZXQgZmJzRXJyU3RyID0gJyhGQlNPcGVuQXBwbGljYXRpb25FcnJvckRvbWFpbiBlcnJvciA4LiknO1xuICAgICAgaWYgKG91dHB1dC5pbmRleE9mKGZic0VyclN0cikgIT09IC0xKSB7XG4gICAgICAgIHRoaXMuZ290RkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAob3V0cHV0LmluZGV4T2YoRVJSX0FNQklHVU9VU19ERVZJQ0UpICE9PSAtMSkge1xuICAgICAgICBsZXQgbXNnID0gYCR7RVJSX0FNQklHVU9VU19ERVZJQ0V9OiAnJHt0aGlzLnNpbXVsYXRvclNka0FuZERldmljZX0nYDtcbiAgICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wcm9jLnN0ZGVyci5waXBlKHRocm91Z2goZnVuY3Rpb24gKG91dHB1dCkge1xuICAgICAgYWN0T25TdGRlcnIob3V0cHV0KTtcbiAgICAgIHRoaXMucXVldWUob3V0cHV0KTtcbiAgICB9KSkucGlwZShlcnJvclN0cmVhbSgpKVxuICAgIC5waXBlKHdlYlNvY2tldEFsZXJ0U3RyZWFtKHRoaXMud2ViU29ja2V0KSlcbiAgICAucGlwZShkdW1wU3RyZWFtKCkpO1xuXG4gICAgLy8gc3RhcnQgd2FpdGluZyBmb3IgaW5zdHJ1bWVudHMgdG8gbGF1bmNoIHN1Y2Nlc3NmdWxseVxuICAgIHRoaXMuYWRkU29ja2V0Q29ubmVjdFRpbWVyKHRoaXMubGF1bmNoVGltZW91dC5nbG9iYWwsICdnbG9iYWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmtpbGxJbnN0cnVtZW50cygpO1xuICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKEVSUl9ORVZFUl9DSEVDS0VEX0lOKSk7XG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgbGF1bmNoUmVzdWx0UHJvbWlzZTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5jbGVhclNvY2tldENvbm5lY3RUaW1lcnMoKTtcbiAgICB9XG4gICAgdGhpcy5zZXRFeGl0TGlzdGVuZXIoKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgIGNvbnN0IG1zZyA9IGNvZGUgIT09IG51bGwgPyBgY29kZTogJHtjb2RlfWAgOiBgc2lnbmFsOiAke3NpZ25hbH1gO1xuICAgICAgdGhpcy5vblNodXRkb3duRGVmZXJyZWQucmVqZWN0KG5ldyBFcnJvcihgQWJub3JtYWwgZXhpdCB3aXRoICR7bXNnfWApKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGxhdW5jaCAoKSB7XG4gICAgYXdhaXQgdGhpcy5jb25maWd1cmUoKTtcbiAgICBsZXQgbGF1bmNoVHJpZXMgPSAwO1xuICAgIGRvIHtcbiAgICAgIGxhdW5jaFRyaWVzKys7XG4gICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gbGF1bmNoIGluc3RydW1lbnRzLCB0aGlzIGlzIHRyeSAjJHtsYXVuY2hUcmllc31gKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5sYXVuY2hPbmNlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy5lcnJvcihgRXJyb3IgbGF1bmNoaW5nIGluc3RydW1lbnRzOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICBsZXQgZXJySXNDYXRjaGFibGUgPSBlcnIubWVzc2FnZSA9PT0gRVJSX05FVkVSX0NIRUNLRURfSU4gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyLm1lc3NhZ2UgPT09IEVSUl9DUkFTSEVEX09OX1NUQVJUVVA7XG4gICAgICAgIGlmICghZXJySXNDYXRjaGFibGUpIHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxhdW5jaFRyaWVzIDw9IHRoaXMuZmxha2V5UmV0cmllcykge1xuICAgICAgICAgIGlmICh0aGlzLmdvdEZCU09wZW5BcHBsaWNhdGlvbkVycm9yKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoJ0dvdCB0aGUgRkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IsIG5vdCBraWxsaW5nIHRoZSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnc2ltIGJ1dCBsZWF2aW5nIGl0IG9wZW4gc28gdGhlIGFwcCB3aWxsIGxhdW5jaCcpO1xuICAgICAgICAgICAgdGhpcy5nb3RGQlNPcGVuQXBwbGljYXRpb25FcnJvciA9IGZhbHNlOyAvLyBjbGVhciBvdXQgZm9yIG5leHQgbGF1bmNoXG4gICAgICAgICAgICBhd2FpdCBCLmRlbGF5KDEwMDApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMucmVhbERldmljZSkge1xuICAgICAgICAgICAgICBhd2FpdCBraWxsQWxsU2ltdWxhdG9ycygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgQi5kZWxheSg1MDAwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ1dlIGV4Y2VlZGVkIHRoZSBudW1iZXIgb2YgcmV0cmllcyBhbGxvd2VkIGZvciAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaW5zdHJ1bWVudHMgdG8gc3VjY2Vzc2Z1bGx5IHN0YXJ0OyBmYWlsaW5nIGxhdW5jaCcpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSB3aGlsZSAodHJ1ZSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc3RhbnQtY29uZGl0aW9uXG4gIH1cblxuICByZWdpc3RlckxhdW5jaCAoKSB7XG4gICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZXNvbHZlKCk7XG4gIH1cblxuICBhc3luYyBzcGF3bkluc3RydW1lbnRzICgpIHtcbiAgICBsZXQgdHJhY2VEaXI7XG4gICAgZm9yIChsZXQgaSA9IDA7IDsgaSsrKSB7XG4gICAgICAvLyBsb29wIHdoaWxlIHRoZXJlIGFyZSB0cmFjZWRpcnMgdG8gZGVsZXRlXG4gICAgICB0cmFjZURpciA9IHBhdGgucmVzb2x2ZSh0aGlzLnRyYWNlRGlyLCBgaW5zdHJ1bWVudHNjbGkke2l9LnRyYWNlYCk7XG4gICAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh0cmFjZURpcikpIGJyZWFrOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgfVxuXG4gICAgLy8gYnVpbGQgdXAgdGhlIGFyZ3VtZW50cyB0byB1c2VcbiAgICBsZXQgYXJncyA9IFsnLXQnLCB0aGlzLnRlbXBsYXRlLCAnLUQnLCB0cmFjZURpcl07XG4gICAgaWYgKHRoaXMudWRpZCkge1xuICAgICAgLy8gcmVhbCBkZXZpY2UsIHNvIHNwZWNpZnkgdWRpZFxuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLXcnLCB0aGlzLnVkaWRdKTtcbiAgICAgIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBydW4gYXBwIG9uIHJlYWwgZGV2aWNlIHdpdGggVURJRCAnJHt0aGlzLnVkaWR9J2ApO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudWRpZCAmJiB0aGlzLnNpbXVsYXRvclNka0FuZERldmljZSkge1xuICAgICAgLy8gc2ltLCBzbyBzcGVjaWZ5IHRoZSBzZGsgYW5kIGRldmljZVxuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLXcnLCB0aGlzLnNpbXVsYXRvclNka0FuZERldmljZV0pO1xuICAgICAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHJ1biBhcHAgb24gJHt0aGlzLnNpbXVsYXRvclNka0FuZERldmljZX1gKTtcbiAgICB9XG4gICAgYXJncyA9IGFyZ3MuY29uY2F0KFt0aGlzLmFwcF0pO1xuICAgIGlmICh0aGlzLnByb2Nlc3NBcmd1bWVudHMpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBydW4gYXBwIHdpdGggcHJvY2VzcyBhcmd1bWVudHM6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5wcm9jZXNzQXJndW1lbnRzKX1gKTtcbiAgICAgIC8vIGFueSBhZGRpdGlvbmFsIHN0dWZmIHNwZWNpZmllZCBieSB0aGUgdXNlclxuXG4gICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLnByb2Nlc3NBcmd1bWVudHMpKSB7XG4gICAgICAgIGlmICh0aGlzLnByb2Nlc3NBcmd1bWVudHMuaW5kZXhPZignLWUgJykgPT09IC0xKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKCdQbGFpbiBzdHJpbmcgcHJvY2VzcyBhcmd1bWVudHMgYmVpbmcgcHVzaGVkIGludG8gYXJndW1lbnRzJyk7XG4gICAgICAgICAgYXJncy5wdXNoKHRoaXMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nLmRlYnVnKCdFbnZpcm9ubWVudCB2YXJpYWJsZXMgYmVpbmcgcHVzaGVkIGludG8gYXJndW1lbnRzJyk7XG4gICAgICAgICAgZm9yIChsZXQgYXJnIG9mIHRoaXMucHJvY2Vzc0FyZ3VtZW50cy5zcGxpdCgnLWUgJykpIHtcbiAgICAgICAgICAgIGFyZyA9IGFyZy50cmltKCk7XG4gICAgICAgICAgICBpZiAoYXJnLmxlbmd0aCkge1xuICAgICAgICAgICAgICBsZXQgc3BhY2UgPSBhcmcuaW5kZXhPZignICcpO1xuICAgICAgICAgICAgICBsZXQgZmxhZyA9IGFyZy5zdWJzdHJpbmcoMCwgc3BhY2UpO1xuICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBhcmcuc3Vic3RyaW5nKHNwYWNlICsgMSk7XG4gICAgICAgICAgICAgIGFyZ3MucHVzaCgnLWUnLCBmbGFnLCB2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBwcm9jZXNzIGFyZ3VtZW50cyBjYW4gYWxzbyBiZSBhIGhhc2ggb2YgZmxhZ3MgYW5kIHZhbHVlc1xuICAgICAgICAvLyB7XCJwcm9jZXNzQXJndW1lbnRzXCI6IHtcImZsYWcxXCI6IFwidmFsdWUxXCIsIFwiZmxhZzJcIjogXCJ2YWx1ZTJcIn19XG4gICAgICAgIGZvciAobGV0IFtmbGFnLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHRoaXMucHJvY2Vzc0FyZ3VtZW50cykpIHtcbiAgICAgICAgICBhcmdzLnB1c2goJy1lJywgZmxhZywgdmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbJy1lJywgJ1VJQVNDUklQVCcsIHRoaXMuYm9vdHN0cmFwXSk7XG4gICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLWUnLCAnVUlBUkVTVUxUU1BBVEgnLCB0aGlzLnRtcERpcl0pO1xuICAgIGlmICh0aGlzLmxhbmd1YWdlKSB7XG4gICAgICBhcmdzID0gYXJncy5jb25jYXQoW2AtQXBwbGVMYW5ndWFnZXMgKCR7dGhpcy5sYW5ndWFnZX0pYF0pO1xuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtgLU5TTGFuZ3VhZ2VzICgke3RoaXMubGFuZ3VhZ2V9KWBdKTtcbiAgICB9XG4gICAgaWYgKHRoaXMubG9jYWxlKSB7XG4gICAgICBhcmdzID0gYXJncy5jb25jYXQoW2AtQXBwbGVMb2NhbGUgJHt0aGlzLmxvY2FsZX1gXSk7XG4gICAgfVxuXG4gICAgbGV0IGVudiA9IF8uY2xvbmUocHJvY2Vzcy5lbnYpO1xuICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi5tYWpvciA+PSA3ICYmICF0aGlzLnVkaWQpIHtcbiAgICAgIC8vIGl3ZCBjdXJyZW50bHkgZG9lcyBub3Qgd29yayB3aXRoIHhjb2RlNywgc2V0dGluZyB3aXRob3V0RGVsYXkgdG8gZmFsc2VcbiAgICAgIGxvZy5pbmZvKFwiT24geGNvZGUgNy4wKywgaW5zdHJ1bWVudHMtd2l0aG91dC1kZWxheSBkb2VzIG5vdCB3b3JrLCBcIiArXG4gICAgICAgICAgICAgICBcInNraXBwaW5nIGluc3RydW1lbnRzLXdpdGhvdXQtZGVsYXlcIik7XG4gICAgICB0aGlzLndpdGhvdXREZWxheSA9IGZhbHNlO1xuICAgIH1cbiAgICBsZXQgaXdkUGF0aCA9IGF3YWl0IGdldEl3ZFBhdGgodGhpcy54Y29kZVZlcnNpb24ubWFqb3IpO1xuICAgIGVudi5DQV9ERUJVR19UUkFOU0FDVElPTlMgPSAxO1xuICAgIGlmICh0aGlzLndpdGhvdXREZWxheSAmJiAhdGhpcy51ZGlkKSB7XG4gICAgICAvLyBzaW0sIGFuZCB1c2luZyBpLXctZFxuICAgICAgZW52LkRZTERfSU5TRVJUX0xJQlJBUklFUyA9IHBhdGgucmVzb2x2ZShpd2RQYXRoLCAnSW5zdHJ1bWVudHNTaGltLmR5bGliJyk7XG4gICAgICBlbnYuTElCX1BBVEggPSBpd2RQYXRoO1xuICAgIH1cbiAgICBsZXQgaW5zdHJ1bWVudHNFeGVjQXJncyA9IFt0aGlzLmluc3RydW1lbnRzUGF0aCwgLi4uYXJnc107XG4gICAgaW5zdHJ1bWVudHNFeGVjQXJncyA9IF8ubWFwKGluc3RydW1lbnRzRXhlY0FyZ3MsIGZ1bmN0aW9uIChhcmcpIHtcbiAgICAgIGlmIChhcmcgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIG51bGwgdmFsdWUgd2FzIHBhc3NlZCBhcyBhbiBhcmcgdG8gZXhlY3V0ZSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdpbnN0cnVtZW50cyBvbiB0aGUgY29tbWFuZCBsaW5lLiBBIGxldGlhYmxlIGlzICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2JhYmx5IG5vdCBnZXR0aW5nIHNldC4gQXJyYXkgb2YgY29tbWFuZCBhcmdzOiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGluc3RydW1lbnRzRXhlY0FyZ3MpKTtcbiAgICAgIH1cbiAgICAgIC8vIGVzY2FwZSBhbnkgYXJndW1lbnQgdGhhdCBoYXMgYSBzcGFjZSBpbiBpdFxuICAgICAgaWYgKF8uaXNTdHJpbmcoYXJnKSAmJiBhcmcuaW5kZXhPZignICcpICE9PSAtMSkge1xuICAgICAgICByZXR1cm4gYFwiJHthcmd9XCJgO1xuICAgICAgfVxuICAgICAgLy8gb3RoZXJ3aXNlIGp1c3QgdXNlIHRoZSBhcmd1bWVudFxuICAgICAgcmV0dXJuIGFyZztcbiAgICB9KTtcbiAgICBsb2cuZGVidWcoYFNwYXduaW5nIGluc3RydW1lbnRzIHdpdGggY29tbWFuZDogJyR7aW5zdHJ1bWVudHNFeGVjQXJncy5qb2luKCcgJyl9J2ApO1xuICAgIGlmICh0aGlzLndpdGhvdXREZWxheSkge1xuICAgICAgbG9nLmRlYnVnKCdBbmQgZXh0cmEgd2l0aG91dC1kZWxheSBlbnY6ICcgKyBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIERZTERfSU5TRVJUX0xJQlJBUklFUzogZW52LkRZTERfSU5TRVJUX0xJQlJBUklFUyxcbiAgICAgICAgTElCX1BBVEg6IGVudi5MSUJfUEFUSFxuICAgICAgfSkpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEFuZCBsYXVuY2ggdGltZW91dHMgKGluIG1zKTogJHtKU09OLnN0cmluZ2lmeSh0aGlzLmxhdW5jaFRpbWVvdXQpfWApO1xuICAgIHJldHVybiBhd2FpdCBzcGF3bih0aGlzLmluc3RydW1lbnRzUGF0aCwgYXJncywge2Vudn0pO1xuICB9XG5cbiAgYWRkU29ja2V0Q29ubmVjdFRpbWVyIChkZWxheSwgdHlwZSwgZG9BY3Rpb24pIHtcbiAgICBsZXQgc29ja2V0Q29ubmVjdERlbGF5ID0gY2FuY2VsbGFibGVEZWxheShkZWxheSk7XG4gICAgLyogZXNsaW50LWRpc2FibGUgKi9cbiAgICBzb2NrZXRDb25uZWN0RGVsYXkudGhlbigoKSA9PiB7XG4gICAgICBsb2cud2FybihgSW5zdHJ1bWVudHMgc29ja2V0IGNsaWVudCBuZXZlciBjaGVja2VkIGluOyB0aW1pbmcgb3V0ICgke3R5cGV9KWApO1xuICAgICAgcmV0dXJuIGRvQWN0aW9uKCk7XG4gICAgfSkuY2F0Y2goQi5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pLmRvbmUoKTtcbiAgICAvKiBlc2xpbnQtZW5hYmxlICovXG4gICAgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzLnB1c2goc29ja2V0Q29ubmVjdERlbGF5KTtcbiAgfVxuXG4gIGNsZWFyU29ja2V0Q29ubmVjdFRpbWVycyAoKSB7XG4gICAgZm9yIChsZXQgZGVsYXkgb2YgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzKSB7XG4gICAgICBkZWxheS5jYW5jZWwoKTtcbiAgICB9XG4gICAgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzID0gW107XG4gIH1cblxuICBzZXRFeGl0TGlzdGVuZXIgKGV4aXRMaXN0ZW5lcikge1xuICAgIGlmICghdGhpcy5wcm9jKSByZXR1cm47IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICBpZiAodGhpcy5leGl0TGlzdGVuZXIpIHtcbiAgICAgIHRoaXMucHJvYy5yZW1vdmVMaXN0ZW5lcignZXhpdCcsIHRoaXMuZXhpdExpc3RlbmVyKTtcbiAgICB9XG4gICAgdGhpcy5leGl0TGlzdGVuZXIgPSBleGl0TGlzdGVuZXI7XG4gICAgdGhpcy5wcm9jLm9uKCdleGl0JywgZXhpdExpc3RlbmVyKTtcbiAgfVxuXG4gIGtpbGxJbnN0cnVtZW50cyAoKSB7XG4gICAgaWYgKCF0aGlzLnByb2MpIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gICAgbG9nLmRlYnVnKGBLaWxsIEluc3RydW1lbnRzIHByb2Nlc3MgKHBpZDogJHt0aGlzLnByb2MucGlkfSlgKTtcbiAgICByZXR1cm4gbmV3IEIoYXN5bmMgKHJlc29sdmUpID0+IHtcbiAgICAgIGxldCB3YXNUZXJtaW5hdGVkID0gZmFsc2U7XG4gICAgICAvLyBtb25pdG9yaW5nIHByb2Nlc3MgdGVybWluYXRpb25cbiAgICAgIGxldCB0ZXJtRGVsYXkgPSBjYW5jZWxsYWJsZURlbGF5KHRoaXMudGVybVRpbWVvdXQpO1xuICAgICAgbGV0IHRlcm1Qcm9taXNlID0gdGVybURlbGF5LmNhdGNoKEIuQ2FuY2VsbGF0aW9uRXJyb3IsICgpID0+IHt9KTtcbiAgICAgIHRoaXMuc2V0RXhpdExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgICAgd2FzVGVybWluYXRlZCA9IHRydWU7XG4gICAgICAgIHRlcm1EZWxheS5jYW5jZWwoKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgICBsb2cuZGVidWcoJ1NlbmRpbmcgU0lHVEVSTScpO1xuICAgICAgdGhpcy5wcm9jLmtpbGwoJ1NJR1RFUk0nKTtcbiAgICAgIGF3YWl0IHRlcm1Qcm9taXNlO1xuICAgICAgaWYgKCF3YXNUZXJtaW5hdGVkKSB7XG4gICAgICAgIGxvZy53YXJuKGBJbnN0cnVtZW50cyBkaWQgbm90IHRlcm1pbmF0ZSBhZnRlciAke3RoaXMudGVybVRpbWVvdXQgLyAxMDAwfSBzZWNvbmRzIWApO1xuICAgICAgICBsb2cuZGVidWcoJ1NlbmRpbmcgU0lHS0lMTCcpO1xuICAgICAgICB0aGlzLnByb2Mua2lsbCgnU0lHS0lMTCcpO1xuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuZXhpdExpc3RlbmVyKSkge1xuICAgICAgICAgIHRoaXMuZXhpdExpc3RlbmVyKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qIFBST0NFU1MgTUFOQUdFTUVOVCAqL1xuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgbG9nLmRlYnVnKCdTdGFydGluZyBzaHV0ZG93bi4nKTtcbiAgICBhd2FpdCB0aGlzLmtpbGxJbnN0cnVtZW50cygpO1xuICAgIHRoaXMub25TaHV0ZG93bkRlZmVycmVkLnJlc29sdmUoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBJbnN0cnVtZW50cztcbiJdLCJmaWxlIjoibGliL2luc3RydW1lbnRzL2luc3RydW1lbnRzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
