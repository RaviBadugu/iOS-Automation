"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllInstruments = killAllInstruments;
exports.cleanAllTraces = cleanAllTraces;
exports.getInstrumentsPath = getInstrumentsPath;
exports.getAvailableDevices = getAvailableDevices;
exports.parseLaunchTimeout = parseLaunchTimeout;
exports.getIwdPath = getIwdPath;
exports.quickLaunch = quickLaunch;
exports.quickInstruments = quickInstruments;
exports.rootDir = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _instruments = _interopRequireDefault(require("./instruments"));

const rootDir = _path.default.resolve(__dirname, '../..');

exports.rootDir = rootDir;
const INST_STALL_TIMEOUT = 12000;

function getInstrumentsPath() {
  return _getInstrumentsPath.apply(this, arguments);
}

function _getInstrumentsPath() {
  _getInstrumentsPath = (0, _asyncToGenerator2.default)(function* () {
    let instrumentsPath;

    try {
      let _ref = yield (0, _teen_process.exec)('xcrun', ['-find', 'instruments']),
          stdout = _ref.stdout;

      instrumentsPath = (stdout || '').trim().replace('\n$', '');
    } catch (err) {
      if (err) {
        _logger.default.error(err.message);
      }
    }

    if (!instrumentsPath) {
      _logger.default.errorAndThrow('Could not find the instruments binary. Please ensure ' + '`xcrun -find instruments` can locate it.');
    }

    _logger.default.debug(`Instruments is at: ${instrumentsPath}`);

    return instrumentsPath;
  });
  return _getInstrumentsPath.apply(this, arguments);
}

function getAvailableDevices() {
  return _getAvailableDevices.apply(this, arguments);
}

function _getAvailableDevices() {
  _getAvailableDevices = (0, _asyncToGenerator2.default)(function* (timeout = INST_STALL_TIMEOUT) {
    _logger.default.debug('Getting list of devices instruments supports');

    let instrumentsPath = yield getInstrumentsPath();
    let opts = {
      timeout
    };
    let lines;

    try {
      let _ref2 = yield (0, _teen_process.exec)(instrumentsPath, ['-s', 'devices'], opts),
          stdout = _ref2.stdout;

      lines = stdout.split('\n');
    } catch (err) {
      _logger.default.errorAndThrow(`Failed getting devices, err: ${err}.`);
    }

    let devices = lines.filter(line => {
      return /^.+ \(\d+\.(\d+\.)?\d+( Simulator)?\) \[.+\]( \(Simulator\))?$/.test(line);
    });

    _logger.default.debug(`Available devices: ${devices}`);

    return devices;
  });
  return _getAvailableDevices.apply(this, arguments);
}

function killAllInstruments() {
  return _killAllInstruments.apply(this, arguments);
}

function _killAllInstruments() {
  _killAllInstruments = (0, _asyncToGenerator2.default)(function* () {
    _logger.default.debug('Killing all instruments');

    try {
      yield (0, _teen_process.exec)('pkill', ['-f', 'instruments']);
    } catch (ign) {}
  });
  return _killAllInstruments.apply(this, arguments);
}

function cleanAllTraces() {
  return _cleanAllTraces.apply(this, arguments);
}

function _cleanAllTraces() {
  _cleanAllTraces = (0, _asyncToGenerator2.default)(function* () {
    if (process.env.CLEAN_TRACES) {
      try {
        yield _appiumSupport.fs.rimraf('instrumentscli*.trace');
      } catch (ign) {}
    }
  });
  return _cleanAllTraces.apply(this, arguments);
}

function parseLaunchTimeout(launchTimeout) {
  if (_lodash.default.isString(launchTimeout)) {
    try {
      launchTimeout = JSON.parse(launchTimeout);
    } catch (err) {
      _logger.default.warn(`Invalid launch timeout: ${launchTimeout}`);
    }
  }

  if (_lodash.default.isNumber(launchTimeout)) {
    launchTimeout = {
      global: launchTimeout
    };
  }

  return launchTimeout;
}

function getIwdPath(_x) {
  return _getIwdPath.apply(this, arguments);
}

function _getIwdPath() {
  _getIwdPath = (0, _asyncToGenerator2.default)(function* (xcodeMajorVersion) {
    let thirdpartyPath = _path.default.resolve(rootDir, '..', 'instruments-iwd');

    let iwdPath = _path.default.resolve(thirdpartyPath, `iwd${xcodeMajorVersion}`);

    if (!(yield _appiumSupport.fs.exists(iwdPath))) {
      iwdPath = _path.default.resolve(thirdpartyPath, 'iwd');
    }

    _logger.default.debug(`Found Insruments-Without-Delay: ${iwdPath}`);

    return iwdPath;
  });
  return _getIwdPath.apply(this, arguments);
}

function quickLaunch(_x2) {
  return _quickLaunch.apply(this, arguments);
}

function _quickLaunch() {
  _quickLaunch = (0, _asyncToGenerator2.default)(function* (udid, appPath = _path.default.resolve(__dirname, '..', '..', 'assets', 'TestApp.app')) {
    let traceTemplatePath = yield _appiumXcode.default.getAutomationTraceTemplatePath();

    let scriptPath = _path.default.resolve(__dirname, '..', '..', 'assets', 'blank_instruments_test.js');

    let traceDocument = _path.default.resolve('/', 'tmp', 'testTrace.trace');

    let resultsPath = _path.default.resolve('/', 'tmp');

    yield _appiumSupport.fs.rimraf(traceDocument);
    let args = ['instruments', '-D', traceDocument, '-t', traceTemplatePath, '-w', udid, appPath, '-e', 'UIASCRIPT', scriptPath, '-e', 'UIARESULTSPATH', resultsPath];

    _logger.default.debug(`Running command: 'xcrun ${args.join(' ')}'`);

    yield (0, _teen_process.exec)('xcrun', args);
  });
  return _quickLaunch.apply(this, arguments);
}

function quickInstruments() {
  return _quickInstruments.apply(this, arguments);
}

function _quickInstruments() {
  _quickInstruments = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    opts = _lodash.default.cloneDeep(opts);
    let xcodeTraceTemplatePath = opts.xcodeTraceTemplatePath || (yield _appiumXcode.default.getAutomationTraceTemplatePath());

    _lodash.default.defaults(opts, {
      launchTimeout: 60000,
      template: xcodeTraceTemplatePath,
      withoutDelay: true,
      xcodeVersion: '8.1',
      webSocket: null,
      flakeyRetries: true,
      logNoColors: false
    });

    return new _instruments.default(opts);
  });
  return _quickInstruments.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0cnVtZW50cy91dGlscy5qcyJdLCJuYW1lcyI6WyJyb290RGlyIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJJTlNUX1NUQUxMX1RJTUVPVVQiLCJnZXRJbnN0cnVtZW50c1BhdGgiLCJpbnN0cnVtZW50c1BhdGgiLCJzdGRvdXQiLCJ0cmltIiwicmVwbGFjZSIsImVyciIsImxvZyIsImVycm9yIiwibWVzc2FnZSIsImVycm9yQW5kVGhyb3ciLCJkZWJ1ZyIsImdldEF2YWlsYWJsZURldmljZXMiLCJ0aW1lb3V0Iiwib3B0cyIsImxpbmVzIiwic3BsaXQiLCJkZXZpY2VzIiwiZmlsdGVyIiwibGluZSIsInRlc3QiLCJraWxsQWxsSW5zdHJ1bWVudHMiLCJpZ24iLCJjbGVhbkFsbFRyYWNlcyIsInByb2Nlc3MiLCJlbnYiLCJDTEVBTl9UUkFDRVMiLCJmcyIsInJpbXJhZiIsInBhcnNlTGF1bmNoVGltZW91dCIsImxhdW5jaFRpbWVvdXQiLCJfIiwiaXNTdHJpbmciLCJKU09OIiwicGFyc2UiLCJ3YXJuIiwiaXNOdW1iZXIiLCJnbG9iYWwiLCJnZXRJd2RQYXRoIiwieGNvZGVNYWpvclZlcnNpb24iLCJ0aGlyZHBhcnR5UGF0aCIsIml3ZFBhdGgiLCJleGlzdHMiLCJxdWlja0xhdW5jaCIsInVkaWQiLCJhcHBQYXRoIiwidHJhY2VUZW1wbGF0ZVBhdGgiLCJ4Y29kZSIsImdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCIsInNjcmlwdFBhdGgiLCJ0cmFjZURvY3VtZW50IiwicmVzdWx0c1BhdGgiLCJhcmdzIiwiam9pbiIsInF1aWNrSW5zdHJ1bWVudHMiLCJjbG9uZURlZXAiLCJ4Y29kZVRyYWNlVGVtcGxhdGVQYXRoIiwiZGVmYXVsdHMiLCJ0ZW1wbGF0ZSIsIndpdGhvdXREZWxheSIsInhjb2RlVmVyc2lvbiIsIndlYlNvY2tldCIsImZsYWtleVJldHJpZXMiLCJsb2dOb0NvbG9ycyIsIkluc3RydW1lbnRzIl0sIm1hcHBp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bSAncGF0aCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgSW5zdHJ1bWVudHMgZnJvbSAnLi9pbnN0cnVtZW50cyc7XG5cblxuY29uc3Qgcm9vdERpciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLicpO1xuY29uc3QgSU5TVF9TVEFMTF9USU1FT1VUID0gMTIwMDA7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEluc3RydW1lbnRzUGF0aCAoKSB7XG4gIGxldCBpbnN0cnVtZW50c1BhdGg7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNydW4nLCBbJy1maW5kJywgJ2luc3RydW1lbnRzJ10pO1xuICAgIGluc3RydW1lbnRzUGF0aCA9IChzdGRvdXQgfHwgJycpLnRyaW0oKS5yZXBsYWNlKCdcXG4kJywgJycpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuICBpZiAoIWluc3RydW1lbnRzUGF0aCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgZmluZCB0aGUgaW5zdHJ1bWVudHMgYmluYXJ5LiBQbGVhc2UgZW5zdXJlICcgK1xuICAgICAgICAgICAgICAgICAgICAgICdgeGNydW4gLWZpbmQgaW5zdHJ1bWVudHNgIGNhbiBsb2NhdGUgaXQuJyk7XG4gIH1cbiAgbG9nLmRlYnVnKGBJbnN0cnVtZW50cyBpcyBhdDogJHtpbnN0cnVtZW50c1BhdGh9YCk7XG4gIHJldHVybiBpbnN0cnVtZW50c1BhdGg7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEF2YWlsYWJsZURldmljZXMgKHRpbWVvdXQgPSBJTlNUX1NUQUxMX1RJTUVPVVQpIHtcbiAgbG9nLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgZGV2aWNlcyBpbnN0cnVtZW50cyBzdXBwb3J0cycpO1xuICBsZXQgaW5zdHJ1bWVudHNQYXRoID0gYXdhaXQgZ2V0SW5zdHJ1bWVudHNQYXRoKCk7XG4gIGxldCBvcHRzID0ge3RpbWVvdXR9O1xuICBsZXQgbGluZXM7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhpbnN0cnVtZW50c1BhdGgsIFsnLXMnLCAnZGV2aWNlcyddLCBvcHRzKTtcbiAgICBsaW5lcyA9IHN0ZG91dC5zcGxpdCgnXFxuJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBGYWlsZWQgZ2V0dGluZyBkZXZpY2VzLCBlcnI6ICR7ZXJyfS5gKTtcbiAgfVxuICBsZXQgZGV2aWNlcyA9IGxpbmVzLmZpbHRlcigobGluZSkgPT4ge1xuICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvYUU2YVMzLzZcbiAgICByZXR1cm4gL14uKyBcXChcXGQrXFwuKFxcZCtcXC4pP1xcZCsoIFNpbXVsYXRvcik/XFwpIFxcWy4rXFxdKCBcXChTaW11bGF0b3JcXCkpPyQvLnRlc3QobGluZSk7XG4gIH0pO1xuICBsb2cuZGVidWcoYEF2YWlsYWJsZSBkZXZpY2VzOiAke2RldmljZXN9YCk7XG4gIHJldHVybiBkZXZpY2VzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsSW5zdHJ1bWVudHMgKCkge1xuICBsb2cuZGVidWcoJ0tpbGxpbmcgYWxsIGluc3RydW1lbnRzJyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygncGtpbGwnLCBbJy1mJywgJ2luc3RydW1lbnRzJ10pO1xuICB9IGNhdGNoIChpZ24pIHt9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFuQWxsVHJhY2VzICgpIHtcbiAgaWYgKHByb2Nlc3MuZW52LkNMRUFOX1RSQUNFUykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYoJ2luc3RydW1lbnRzY2xpKi50cmFjZScpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUxhdW5jaFRpbWVvdXQgKGxhdW5jaFRpbWVvdXQpIHtcbiAgLy8gbnVtYmVyIG9yIG9iamVjdCBsaWtlIHsgZ2xvYmFsOiA0MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDUwMDAgfVxuICAvLyBtYXkgYWxzbyBwYXJzZSBKU09OIHN0cmluZ3MuXG4gIGlmIChfLmlzU3RyaW5nKGxhdW5jaFRpbWVvdXQpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxhdW5jaFRpbWVvdXQgPSBKU09OLnBhcnNlKGxhdW5jaFRpbWVvdXQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYEludmFsaWQgbGF1bmNoIHRpbWVvdXQ6ICR7bGF1bmNoVGltZW91dH1gKTtcbiAgICB9XG4gIH1cbiAgaWYgKF8uaXNOdW1iZXIobGF1bmNoVGltZW91dCkpIHtcbiAgICBsYXVuY2hUaW1lb3V0ID0ge1xuICAgICAgZ2xvYmFsOiBsYXVuY2hUaW1lb3V0XG4gICAgfTtcbiAgfVxuICByZXR1cm4gbGF1bmNoVGltZW91dDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0SXdkUGF0aCAoeGNvZGVNYWpvclZlcnNpb24pIHtcbiAgbGV0IHRoaXJkcGFydHlQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICcuLicsICdpbnN0cnVtZW50cy1pd2QnKTtcbiAgbGV0IGl3ZFBhdGggPSBwYXRoLnJlc29sdmUodGhpcmRwYXJ0eVBhdGgsIGBpd2Qke3hjb2RlTWFqb3JWZXJzaW9ufWApO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhpd2RQYXRoKSkge1xuICAgIGl3ZFBhdGggPSBwYXRoLnJlc29sdmUodGhpcmRwYXJ0eVBhdGgsICdpd2QnKTtcbiAgfVxuICBsb2cuZGVidWcoYEZvdW5kIEluc3J1bWVudHMtV2l0aG91dC1EZWxheTogJHtpd2RQYXRofWApO1xuICByZXR1cm4gaXdkUGF0aDtcbn1cblxuLy8gdGhpcyBmdW5jdGlvbiBsYXVuY2hlcyBhbiBpbnN0cnVtZW50cyB0ZXN0IHdpdGggYSBkZWZhdWx0IHRlc3Rcbi8vIHRoYXQgaW1tZWRpYXRlbHkgcGFzc2VzLiBJbiB0aGlzIHdheSB3ZSBjYW4gc3RhcnQgYSBzaW11bGF0b3Jcbi8vIGFuZCBiZSBub3RpZmllZCB3aGVuIGl0IGNvbXBsZXRlbHkgbGF1bmNoZXNcbmFzeW5jIGZ1bmN0aW9uIHF1aWNrTGF1bmNoICh1ZGlkLCBhcHBQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2Fzc2V0cycsICdUZXN0QXBwLmFwcCcpKSB7XG4gIGxldCB0cmFjZVRlbXBsYXRlUGF0aCA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICBsZXQgc2NyaXB0UGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdhc3NldHMnLCAnYmxhbmtfaW5zdHJ1bWVudHNfdGVzdC5qcycpO1xuICBsZXQgdHJhY2VEb2N1bWVudCA9IHBhdGgucmVzb2x2ZSgnLycsICd0bXAnLCAndGVzdFRyYWNlLnRyYWNlJyk7XG4gIGxldCByZXN1bHRzUGF0aCA9IHBhdGgucmVzb2x2ZSgnLycsICd0bXAnKTtcblxuICAvLyB0aGUgdHJhY2UgZG9jdW1lbnQgY2FuIGJlIGluIGEgd2VpcmQgc3RhdGVcbiAgLy8gYnV0IHdlIG5ldmVyIGRvIGFueXRoaW5nIHdpdGggaXQsIHNvIGRlbGV0ZVxuICBhd2FpdCBmcy5yaW1yYWYodHJhY2VEb2N1bWVudCk7XG5cbiAgbGV0IGFyZ3MgPSBbXG4gICAgJ2luc3RydW1lbnRzJyxcbiAgICAnLUQnLCB0cmFjZURvY3VtZW50LFxuICAgICctdCcsIHRyYWNlVGVtcGxhdGVQYXRoLFxuICAgICctdycsIHVkaWQsXG4gICAgYXBwUGF0aCxcbiAgICAnLWUnLCAnVUlBU0NSSVBUJywgc2NyaXB0UGF0aCxcbiAgICAnLWUnLCAnVUlBUkVTVUxUU1BBVEgnLCByZXN1bHRzUGF0aF07XG4gIGxvZy5kZWJ1ZyhgUnVubmluZyBjb21tYW5kOiAneGNydW4gJHthcmdzLmpvaW4oJyAnKX0nYCk7XG4gIGF3YWl0IGV4ZWMoJ3hjcnVuJywgYXJncyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHF1aWNrSW5zdHJ1bWVudHMgKG9wdHMgPSB7fSkge1xuICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gIGxldCB4Y29kZVRyYWNlVGVtcGxhdGVQYXRoID0gb3B0cy54Y29kZVRyYWNlVGVtcGxhdGVQYXRoIHx8XG4gICAgICBhd2FpdCB4Y29kZS5nZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgoKTtcbiAgXy5kZWZhdWx0cyhvcHRzLCB7XG4gICAgbGF1bmNoVGltZW91dDogNjAwMDAsXG4gICAgdGVtcGxhdGU6IHhjb2RlVHJhY2VUZW1wbGF0ZVBhdGgsXG4gICAgd2l0aG91dERlbGF5OiB0cnVlLFxuICAgIHhjb2RlVmVyc2lvbjogJzguMScsXG4gICAgd2ViU29ja2V0OiBudWxsLFxuICAgIGZsYWtleVJldHJpZXM6IHRydWUsXG4gICAgbG9nTm9Db2xvcnM6IGZhbHNlLFxuICB9KTtcbiAgcmV0dXJuIG5ldyBJbnN0cnVtZW50cyhvcHRzKTtcbn1cblxuZXhwb3J0IHtcbiAgcm9vdERpciwga2lsbEFsbEluc3RydW1lbnRzLCBjbGVhbkFsbFRyYWNlcywgZ2V0SW5zdHJ1bWVudHNQYXRoLFxuICBnZXRBdmFpbGFibGVEZXZpY2VzLCBwYXJzZUxhdW5jaFRpbWVvdXQsIGdldEl3ZFBhdGgsIHF1aWNrTGF1bmNoLFxuICBxdWlja0luc3RydW1lbnRzLFxufTtcbiJdLCJmaWxlIjoibGliL2luc3RydW1lbnRzL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
