"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocale = setLocale;
exports.setPreferences = setPreferences;
exports.setLocaleAndPreferences = setLocaleAndPreferences;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

function launchAndQuitSimulator(_x, _x2) {
  return _launchAndQuitSimulator.apply(this, arguments);
}

function _launchAndQuitSimulator() {
  _launchAndQuitSimulator = (0, _asyncToGenerator2.default)(function* (sim, safari) {
    _logger.default.debug('No simulator directories found.');

    return yield sim.launchAndQuit(safari);
  });
  return _launchAndQuitSimulator.apply(this, arguments);
}

function checkPreferences(settings, opts = {}) {
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = settings[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      let setting = _step.value;

      if (_lodash.default.has(opts, setting)) {
        return true;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return != null) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return false;
}

function setLocaleAndPreferences(_x3, _x4) {
  return _setLocaleAndPreferences.apply(this, arguments);
}

function _setLocaleAndPreferences() {
  _setLocaleAndPreferences = (0, _asyncToGenerator2.default)(function* (sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
    const localConfig = yield setLocale(sim, opts, {}, safari);
    const prefsUpdated = yield setPreferences(sim, opts, safari);

    if (localConfig._updated || prefsUpdated) {
      _logger.default.debug("Updated settings. Rebooting the simulator if it's already open");

      yield shutdownFn(sim);
    }

    delete localConfig._updated;
    return localConfig;
  });
  return _setLocaleAndPreferences.apply(this, arguments);
}

function setLocale(_x5, _x6) {
  return _setLocale.apply(this, arguments);
}

function _setLocale() {
  _setLocale = (0, _asyncToGenerator2.default)(function* (sim, opts, localeConfig = {}, safari = false) {
    if (!opts.language && !opts.locale && !opts.calendarFormat) {
      _logger.default.debug("No reason to set locale");

      return {
        _updated: false
      };
    }

    if (yield sim.isFresh()) {
      yield launchAndQuitSimulator(sim, safari);
    }

    _logger.default.debug('Setting locale information');

    localeConfig = {
      language: opts.language || localeConfig.language,
      locale: opts.locale || localeConfig.locale,
      calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
      _updated: false
    };

    try {
      let updated = yield sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

      if (updated) {
        localeConfig._updated = true;
      }
    } catch (e) {
      _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
    }

    return localeConfig;
  });
  return _setLocale.apply(this, arguments);
}

function setPreferences(_x7, _x8) {
  return _setPreferences.apply(this, arguments);
}

function _setPreferences() {
  _setPreferences = (0, _asyncToGenerator2.default)(function* (sim, opts, safari = false) {
    let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
    let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

    if (!needToSetPrefs && !needToSetSafariPrefs) {
      _logger.default.debug("No iOS / app preferences to set");

      return false;
    }

    _logger.default.debug("Setting iOS and app preferences");

    if (yield sim.isFresh()) {
      yield launchAndQuitSimulator(sim, safari);
    }

    try {
      if (needToSetPrefs) {
        yield setLocServicesPrefs(sim, opts);
      }
    } catch (e) {
      _logger.default.error("Error setting location services preferences, prefs will not work");

      _logger.default.error(e);
    }

    try {
      if (needToSetSafariPrefs) {
        yield setSafariPrefs(sim, opts);
      }
    } catch (e) {
      _logger.default.error("Error setting safari preferences, prefs will not work");

      _logger.default.error(e);
    }

    return true;
  });
  return _setPreferences.apply(this, arguments);
}

function setLocServicesPrefs(_x9) {
  return _setLocServicesPrefs.apply(this, arguments);
}

function _setLocServicesPrefs() {
  _setLocServicesPrefs = (0, _asyncToGenerator2.default)(function* (sim, opts = {}) {
    let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => {
      return !_lodash.default.isUndefined(c);
    });

    if (!_lodash.default.isUndefined(locServ)) {
      locServ = locServ ? 1 : 0;

      _logger.default.debug(`Setting location services to ${locServ}`);

      yield sim.updateSettings('locationServices', {
        LocationServicesEnabled: locServ,
        'LocationServicesEnabledIn7.0': locServ,
        'LocationServicesEnabledIn8.0': locServ
      });
    }

    if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
      if (!opts.bundleId) {
        let msg = "Can't set location services for app without bundle ID";

        _logger.default.errorAndThrow(msg);
      }

      let locAuth = !!opts.locationServicesAuthorized;

      if (locAuth) {
        _logger.default.debug("Authorizing location services for app");
      } else {
        _logger.default.debug("De-authorizing location services for app");
      }

      yield sim.updateLocationSettings(opts.bundleId, locAuth);
    }
  });
  return _setLocServicesPrefs.apply(this, arguments);
}

function setSafariPrefs(_x10) {
  return _setSafariPrefs.apply(this, arguments);
}

function _setSafariPrefs() {
  _setSafariPrefs = (0, _asyncToGenerator2.default)(function* (sim, opts = {}) {
    let safariSettings = {};

    if (_lodash.default.has(opts, 'safariAllowPopups')) {
      let val = !!opts.safariAllowPopups;

      _logger.default.debug(`Setting javascript window opening to '${val}'`);

      safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
      safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
    }

    if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
      let val = !opts.safariIgnoreFraudWarning;

      _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

      safariSettings.WarnAboutFraudulentWebsites = val;
    }

    if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
      let val = opts.safariOpenLinksInBackground ? 1 : 0;

      _logger.default.debug(`Setting opening links in background to '${!!val}'`);

      safariSettings.OpenLinksInBackground = val;
    }

    if (_lodash.default.size(safariSettings) > 0) {
      yield sim.updateSafariSettings(safariSettings);
    }
  });
  return _setSafariPrefs.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJTRVRUSU5HU19DQVBTIiwiU0FGQVJJX1NFVFRJTkdTX0NBUFMiLCJsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIiwic2ltIiwic2FmYXJpIiwibG9nZ2VyIiwiZGVidWciLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwib3B0cyIsInNldHRpbmciLCJfIiwiaGFzIiwic2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMiLCJzaHV0ZG93bkZuIiwibm9vcCIsImxvY2FsQ29uZmlnIiwic2V0TG9jYWxlIiwicHJlZnNVcGRhdGVkIiwic2V0UHJlZmVyZW5jZXMiLCJfdXBkYXRlZCIsImxvY2FsZUNvbmZpZyIsImxhbmd1YWdlIiwibG9jYWxlIiwiY2FsZW5kYXJGb3JtYXQiLCJpc0ZyZXNoIiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImUiLCJlcnJvckFuZFRocm93IiwibmVlZFRvU2V0UHJlZnMiLCJuZWVkVG9TZXRTYWZhcmlQcmVmcyIsInNldExvY1NlcnZpY2VzUHJlZnMiLCJlcnJvciIsInNldFNhZmFyaVByZWZzIiwibG9jU2VydiIsImZpbmQiLCJsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkIiwiYyIsImlzVW5kZWZpbmVkIiwidXBkYXRlU2V0dGluZ3MiLCJMb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImJ1bmRsZUlkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUcsQ0FDcEIseUJBRG9CLEVBRXBCLDRCQUZvQixDQUF0QjtBQUlBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCLG1CQUQyQixFQUUzQiwwQkFGMkIsRUFHM0IsNkJBSDJCLENBQTdCOztTQU1lQyxzQjs7Ozs7NERBQWYsV0FBdUNDLEdBQXZDLEVBQTRDQyxNQUE1QyxFQUFvRDtBQUNsREMsb0JBQU9DLEtBQVAsQ0FBYSxpQ0FBYjs7QUFDQSxpQkFBYUgsR0FBRyxDQUFDSSxhQUFKLENBQWtCSCxNQUFsQixDQUFiO0FBQ0QsRzs7OztBQUVELFNBQVNJLGdCQUFULENBQTJCQyxRQUEzQixFQUFxQ0MsSUFBSSxHQUFHLEVBQTVDLEVBQWdEO0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQzlDLHlCQUFvQkQsUUFBcEIsOEhBQThCO0FBQUEsVUFBckJFLE9BQXFCOztBQUM1QixVQUFJQyxnQkFBRUMsR0FBRixDQUFNSCxJQUFOLEVBQVlDLE9BQVosQ0FBSixFQUEwQjtBQUN4QixlQUFPLElBQVA7QUFDRDtBQUNGO0FBTDZDO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBTTlDLFNBQU8sS0FBUDtBQUNEOztTQUVjRyx1Qjs7Ozs7NkRBQWYsV0FBd0NYLEdBQXhDLEVBQTZDTyxJQUE3QyxFQUFtRE4sTUFBTSxHQUFHLEtBQTVELEVBQW1FVyxVQUFVLEdBQUdILGdCQUFFSSxJQUFsRixFQUF3RjtBQUN0RixVQUFNQyxXQUFXLFNBQVNDLFNBQVMsQ0FBQ2YsR0FBRCxFQUFNTyxJQUFOLEVBQVksRUFBWixFQUFnQk4sTUFBaEIsQ0FBbkM7QUFDQSxVQUFNZSxZQUFZLFNBQVNDLGNBQWMsQ0FB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Q0FBYywyQ0FBMEMsQ0FBQyxDQUFDMkMsR0FBSSxHQUE5RDs7QUFDQUQsTUFBQUEsY0FBYyxDQUFDUSxxQkFBZixHQUF1Q1AsR0FBdkM7QUFDRDs7QUFDRCxRQUFJckMsZ0JBQUU2QyxJQUFGLENBQU9ULGNBQVAsSUFBeUIsQ0FBN0IsRUFBZ0M7QUFDOUIsWUFBTTdDLEdBQUcsQ0FBQ3VELG9CQUFKLENBQXlCVixjQUF6QixDQUFOO0FBQ0Q7QUFDRixHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IFNFVFRJTkdTX0NBUFMgPSBbXG4gICdsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCcsXG4gICdsb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCcsXG5dO1xuY29uc3QgU0FGQVJJX1NFVFRJTkdTX0NBUFMgPSBbXG4gICdzYWZhcmlBbGxvd1BvcHVwcycsXG4gICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnLFxuICAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJyxcbl07XG5cbmFzeW5jIGZ1bmN0aW9uIGxhdW5jaEFuZFF1aXRTaW11bGF0b3IgKHNpbSwgc2FmYXJpKSB7XG4gIGxvZ2dlci5kZWJ1ZygnTm8gc2ltdWxhdG9yIGRpcmVjdG9yaWVzIGZvdW5kLicpO1xuICByZXR1cm4gYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoc2FmYXJpKTtcbn1cblxuZnVuY3Rpb24gY2hlY2tQcmVmZXJlbmNlcyAoc2V0dGluZ3MsIG9wdHMgPSB7fSkge1xuICBmb3IgKGxldCBzZXR0aW5nIG9mIHNldHRpbmdzKSB7XG4gICAgaWYgKF8uaGFzKG9wdHMsIHNldHRpbmcpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGVBbmRQcmVmZXJlbmNlcyAoc2ltLCBvcHRzLCBzYWZhcmkgPSBmYWxzZSwgc2h1dGRvd25GbiA9IF8ubm9vcCkge1xuICBjb25zdCBsb2NhbENvbmZpZyA9IGF3YWl0IHNldExvY2FsZShzaW0sIG9wdHMsIHt9LCBzYWZhcmkpO1xuICBjb25zdCBwcmVmc1VwZGF0ZWQgPSBhd2FpdCBzZXRQcmVmZXJlbmNlcyhzaW0sIG9wdHMsIHNhZmFyaSk7XG4gIGlmIChsb2NhbENvbmZpZy5fdXBkYXRlZCB8fCBwcmVmc1VwZGF0ZWQpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJVcGRhdGVkIHNldHRpbmdzLiBSZWJvb3RpbmcgdGhlIHNpbXVsYXRvciBpZiBpdCdzIGFscmVhZHkgb3BlblwiKTtcbiAgICBhd2FpdCBzaHV0ZG93bkZuKHNpbSk7XG4gIH1cbiAgZGVsZXRlIGxvY2FsQ29uZmlnLl91cGRhdGVkO1xuICByZXR1cm4gbG9jYWxDb25maWc7XG59XG5cbi8vIHBhc3MgaW4gdGhlIHNpbXVsYXRvciBzbyB0aGF0IG90aGVyIHN5c3RlbXMgdGhhdCB1c2UgdGhlIGZ1bmN0aW9uIGNhbiBzdXBwbHlcbi8vIHdoYXRldmVyIHRoZXkgaGF2ZVxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYWxlIChzaW0sIG9wdHMsIGxvY2FsZUNvbmZpZyA9IHt9LCBzYWZhcmkgPSBmYWxzZSkge1xuICBpZiAoIW9wdHMubGFuZ3VhZ2UgJiYgIW9wdHMubG9jYWxlICYmICFvcHRzLmNhbGVuZGFyRm9ybWF0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiTm8gcmVhc29uIHRvIHNldCBsb2NhbGVcIik7XG4gICAgcmV0dXJuIHtcbiAgICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgLy8gd2UgbmVlZCB0aGUgc2ltdWxhdG9yIHRvIGhhdmUgaXRzIGRpcmVjdG9yaWVzIGluIHBsYWNlXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHNhZmFyaSk7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1NldHRpbmcgbG9jYWxlIGluZm9ybWF0aW9uJyk7XG4gIGxvY2FsZUNvbmZpZyA9IHtcbiAgICBsYW5ndWFnZTogb3B0cy5sYW5ndWFnZSB8fCBsb2NhbGVDb25maWcubGFuZ3VhZ2UsXG4gICAgbG9jYWxlOiBvcHRzLmxvY2FsZSB8fCBsb2NhbGVDb25maWcubG9jYWxlLFxuICAgIGNhbGVuZGFyRm9ybWF0OiBvcHRzLmNhbGVuZGFyRm9ybWF0IHx8IGxvY2FsZUNvbmZpZy5jYWxlbmRhckZvcm1hdCxcbiAgICBfdXBkYXRlZDogZmFsc2UsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBsZXQgdXBkYXRlZCA9IGF3YWl0IHNpbS51cGRhdGVMb2NhbGUob3B0cy5sYW5ndWFnZSwgb3B0cy5sb2NhbGUsIG9wdHMuY2FsZW5kYXJGb3JtYXQpO1xuICAgIGlmICh1cGRhdGVkKSB7XG4gICAgICBsb2NhbGVDb25maWcuX3VwZGF0ZWQgPSB0cnVlO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBBcHBpdW0gd2FzIHVuYWJsZSB0byBzZXQgbG9jYWxlIGluZm86ICR7ZX1gKTtcbiAgfVxuXG4gIHJldHVybiBsb2NhbGVDb25maWc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGxldCBuZWVkVG9TZXRQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGxldCBuZWVkVG9TZXRTYWZhcmlQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0FGQVJJX1NFVFRJTkdTX0NBUFMsIG9wdHMpO1xuICBpZiAoIW5lZWRUb1NldFByZWZzICYmICFuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIk5vIGlPUyAvIGFwcCBwcmVmZXJlbmNlcyB0byBzZXRcIik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKFwiU2V0dGluZyBpT1MgYW5kIGFwcCBwcmVmZXJlbmNlc1wiKTtcblxuICBpZiAoYXdhaXQgc2ltLmlzRnJlc2goKSkge1xuICAgIGF3YWl0IGxhdW5jaEFuZFF1aXRTaW11bGF0b3Ioc2ltLCBzYWZhcmkpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBpZiAobmVlZFRvU2V0UHJlZnMpIHtcbiAgICAgIGF3YWl0IHNldExvY1NlcnZpY2VzUHJlZnMoc2ltLCBvcHRzKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBzZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrXCIpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICBhd2FpdCBzZXRTYWZhcmlQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHNldHRpbmcgc2FmYXJpIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrXCIpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NTZXJ2aWNlc1ByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgbG9jU2VydiA9IF8uZmluZChbb3B0cy5sb2NhdGlvblNlcnZpY2VzRW5hYmxlZCwgb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZF0sIChjKSA9PiB7XG4gICAgcmV0dXJuICFfLmlzVW5kZWZpbmVkKGMpO1xuICB9KTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKGxvY1NlcnYpKSB7XG4gICAgbG9jU2VydiA9IGxvY1NlcnYgPyAxIDogMDtcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgdG8gJHtsb2NTZXJ2fWApO1xuICAgIGF3YWl0IHNpbS51cGRhdGVTZXR0aW5ncygnbG9jYXRpb25TZXJ2aWNlcycsIHtcbiAgICAgIExvY2F0aW9uU2VydmljZXNFbmFibGVkOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW43LjAnOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW44LjAnOiBsb2NTZXJ2XG4gICAgfSk7XG4gIH1cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQpKSB7XG4gICAgaWYgKCFvcHRzLmJ1bmRsZUlkKSB7XG4gICAgICBsZXQgbXNnID0gXCJDYW4ndCBzZXQgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCB3aXRob3V0IGJ1bmRsZSBJRFwiO1xuICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICB9XG4gICAgbGV0IGxvY0F1dGggPSAhIW9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQ7XG4gICAgaWYgKGxvY0F1dGgpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkF1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHBcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkRlLWF1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHBcIik7XG4gICAgfVxuICAgIGF3YWl0IHNpbS51cGRhdGVMb2NhdGlvblNldHRpbmdzKG9wdHMuYnVuZGxlSWQsIGxvY0F1dGgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFNhZmFyaVByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgc2FmYXJpU2V0dGluZ3MgPSB7fTtcblxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUFsbG93UG9wdXBzJykpIHtcbiAgICBsZXQgdmFsID0gISFvcHRzLnNhZmFyaUFsbG93UG9wdXBzO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBqYXZhc2NyaXB0IHdpbmRvdyBvcGVuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgICBzYWZhcmlTZXR0aW5ncy5KYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nJykpIHtcbiAgICBsZXQgdmFsID0gIW9wdHMuc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBmcmF1ZHVsZW50IHdlYnNpdGUgd2FybmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldhcm5BYm91dEZyYXVkdWxlbnRXZWJzaXRlcyA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCcpKSB7XG4gICAgbGV0IHZhbCA9IG9wdHMuc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIG9wZW5pbmcgbGlua3MgaW4gYmFja2dyb3VuZCB0byAnJHshIXZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID0gdmFsO1xuICB9XG4gIGlmIChfLnNpemUoc2FmYXJpU2V0dGluZ3MpID4gMCkge1xuICAgIGF3YWl0IHNpbS51cGRhdGVTYWZhcmlTZXR0aW5ncyhzYWZhcmlTZXR0aW5ncyk7XG4gIH1cbn1cblxuZXhwb3J0IHsgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMgfTtcbiJdLCJmaWxlIjoibGliL3NldHRpbmdzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
