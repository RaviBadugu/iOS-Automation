"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _xmldom = _interopRequireDefault(require("xmldom"));

var _xpath = _interopRequireDefault(require("xpath"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _utils = require("../utils");

const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible ?= ?('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable ?= ?('|")true\1\]/;
let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

helpers.findElOrEls = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (strategy, selector, mult, context) {
    context = (0, _utils.unwrapEl)(context);

    if (this.isWebContext()) {
      return yield this.findWebElementOrElements(strategy, selector, mult, context);
    } else {
      return yield this.findUIElementOrElements(strategy, selector, mult, context);
    }
  });

  return function (_x, _x2, _x3, _x4) {
    return _ref.apply(this, arguments);
  };
}();

helpers.findUIElementOrElements = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (strategy, selector, mult, context) {
    var _this = this;

    if (strategy !== "xpath") {
      selector = _appiumSupport.util.escapeSpecialChars(selector, "'");
    }

    if (typeof context === "undefined" || !context) {
      context = '';
    } else if (typeof context === "string") {
      context = _appiumSupport.util.escapeSpecialChars(context, "'");
    }

    if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
      return yield this.findScrollableElOrEls(mult, context);
    }

    if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
      if (mult) {
        throw new Error("Cannot get multiple first children");
      }

      return yield this.getFirstVisibleChild(context);
    }

    if (strategy === 'class name' && selector.indexOf('UIA') !== 0) {
      throw new _appiumBaseDriver.errors.InvalidSelectorError(`The class name selector must use full UIA class names. Try 'UIA${selector}' instead.`);
    }

    if (!selector) new _appiumBaseDriver.errors.InvalidSelectorError('Missing selector');

    let createGetElementCommand = function createGetElementCommand(strategy, selector, mult, context) {
      let ext = mult ? 's' : '';
      let command = "";
      context = !context ? context : `, '${context}'`;

      switch (strategy) {
        case "name":
          command = `au.getElement${ext}ByName('${selector}'${context})`;
          break;

        case "accessibility id":
          command = `au.getElement${ext}ByAccessibilityId('${selector}'${context})`;
          break;

        case "id":
          command = `au.getElement${ext}ById('${selector}')`;
          break;

        case "-ios uiautomation":
          command = `au.getElement${ext}ByUIAutomation('${selector}'${context})`;
          break;

        default:
          command = `au.getElement${ext}ByType('${selector}'${context})`;
      }

      return command;
    };

    let getLocalizedStringForSelector = function getLocalizedStringForSelector(selector, strings) {
      let newSelector = selector;

      if (strings) {
        let localizedSelector = strings[selector];

        if (localizedSelector) {
          newSelector = localizedSelector;
        } else {
          _logger.default.debug(`Id selector, '${selector}', not found in Localizable.strings.`);
        }
      }

      return newSelector;
    };

    let res;

    let doFind = function () {
      var _ref3 = (0, _asyncToGenerator2.default)(function* () {
        if (strategy === "xpath") {
          res = yield _this.findUIElementsByXpath(selector, mult, context);
        } else if (strategy === "id") {
          let findByAxIdCmd = createGetElementCommand("accessibility id", selector, mult, context);
          res = yield _this.uiAutoClient.sendCommand(findByAxIdCmd);

          if (!(res && _lodash.default.size(res) > 0)) {
            let findByIdCmd = createGetElementCommand("id", getLocalizedStringForSelector(selector, _this.opts.localizableStrings), mult, context);
            res = yield _this.uiAutoClient.sendCommand(findByIdCmd);
          }
        } else {
          let command = createGetElementCommand(strategy, selector, mult, context);
          res = yield _this.uiAutoClient.sendCommand(command);
        }

        return _lodash.default.size(res) > 0;
      });

      return function doFind() {
        return _ref3.apply(this, arguments);
      };
    }();

    try {
      yield this.implicitWaitForCondition(doFind);
    } catch (err) {
      if (err.message && err.message.match(/Condition unmet/)) {
        res = [];
      } else {
        throw err;
      }
    }

    if (mult) {
      return res;
    } else {
      if (!res || _lodash.default.size(res) === 0) {
        throw new _appiumBaseDriver.errors.NoSuchElementError();
      }

      return res;
    }
  });

  return function (_x5, _x6, _x7, _x8) {
    return _ref2.apply(this, arguments);
  };
}();

let _pathFromDomNode = function _pathFromDomNode(node) {
  let path = null;
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _lodash.default.values(node.attributes)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      let attrObj = _step.value;

      if (attrObj.name === "path") {
        path = attrObj.value;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return != null) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return path;
};

let _xmlSourceFromJson = function _xmlSourceFromJson(jsonSource) {
  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }

  return (0, _js2xmlparser.default)("AppiumAUT", jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: "element"
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: "    "
    }
  });
};

let _performXpathQueryOnJson = function _performXpathQueryOnJson(selector, jsonSource) {
  let xmlSource = _xmlSourceFromJson(jsonSource);

  let dom = new _xmldom.default.DOMParser().parseFromString(xmlSource);
  return _xpath.default.select(selector, dom);
};

commands.findUIElementsByXpath = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (selector, mult, context = null, curRetry = 1) {
    let sourceXml;

    try {
      sourceXml = yield this.getSourceForElementForXML(context);
    } catch (err) {
      _logger.default.warn("Error getting source, can't continue finding element by XPath");

      throw err;
    }

    let selectedNodes = _performXpathQueryOnJson(selector, sourceXml);

    if (!mult) {
      selectedNodes = selectedNodes.slice(0, 1);
    }

    let indexPaths = [];
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = selectedNodes[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        let node = _step2.value;

        let ip = _pathFromDomNode(node);

        if (ip !== null) {
          indexPaths.push(ip);
        }
      }
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
          _iterator2.return();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    if (indexPaths.length < 1) {
      return [];
    }

    let methodName;
    let methodArgs = [];

    if (!mult) {
      methodName = "getElementByIndexPath";
      methodArgs[0] = `'${indexPaths[0]}'`;
    } else {
      methodName = "getElementsByIndexPaths";
      methodArgs[0] = JSON.stringify(indexPaths);
    }

    if (context) {
      methodArgs[1] = `au.getElement('${context}')`;
    }

    let proxyCmd = `au.${methodName}(${methodArgs.join(", ")})`;
    let res;

    try {
      res = yield this.uiAutoClient.sendCommand(proxyCmd);
    } catch (err) {
      if (curRetry < 3) {
        _logger.default.debug("Got a warning from uiauto that some index paths " + "could not be resolved, trying again");

        yield _bluebird.default.delay(300);
        return yield this.findUIElementsByXpath(selector, mult, context, curRetry + 1);
      }

      throw err;
    }

    return res;
  });

  return function (_x9, _x10) {
    return _ref4.apply(this, arguments);
  };
}();

helpers.findScrollableElOrEls = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (mult, context) {
    const scrollTypes = ['UIAScrollView', 'UIATableView', 'UIACollectionView', 'UIAWebView'];
    let res = [];
    const ext = mult ? 's' : '';

    for (var _i = 0; _i < scrollTypes.length; _i++) {
      const scrollType = scrollTypes[_i];
      const command = `au.getElement${ext}ByType('${scrollType}'${context})`;

      if (mult) {
        let elements = yield this.uiAutoClient.sendCommand(command);

        if (!_lodash.default.isEmpty(elements)) {
          res.push(...elements);
        }
      } else {
        let element = yield this.uiAutoClient.sendCommand(command);

        if (element) {
          return element;
        }
      }
    }

    if (mult) {
      return res;
    }

    throw new _appiumBaseDriver.errors.NoSuchElementError();
  });

  return function (_x11, _x12) {
    return _ref5.apply(this, arguments);
  };
}();

helpers.getFirstVisibleChild = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (elementId) {
    let visibleEls = yield this.findElementsFromElement('-ios uiautomation', '.elements().withPredicate("isVisible == 1");', elementId);
    return _lodash.default.first(visibleEls);
  });

  return function (_x13) {
    return _ref6.apply(this, arguments);
  };
}();

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maW5kLmpzIl0sIm5hbWVzIjpbIk1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwiLCJNQUdJQ19TQ1JPTExBQkxFX1NFTCIsImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJmaW5kRWxPckVscyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsImlzV2ViQ29udGV4dCIsImZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyIsImZpbmRVSUVsZW1lbnRPckVsZW1lbnRzIiwidXRpbCIsImVzY2FwZVNwZWNpYWxDaGFycyIsInRlc3QiLCJmaW5kU2Nyb2xsYWJsZUVsT3JFbHMiLCJFcnJvciIsImdldEZpcnN0VmlzaWJsZUNoaWxkIiwiaW5kZXhPZiIsImVycm9ycyIsIkludmFsaWRTZWxlY3RvckVycm9yIiwiY3JlYXRlR2V0RWxlbWVudENvbW1hbmQiLCJleHQiLCJjb21tYW5kIiwiZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3IiLCJzdHJpbmdzIiwibmV3U2VsZWN0b3IiLCJsb2NhbGl6ZWRTZWxlY3RvciIsImxvZ2dlciIsImRlYnVnIiwicmVzIiwiZG9GaW5kIiwiZmluZFVJRWxlbWVudHNCeVhwYXRoIiwiZmluZEJ5QXhJZENtZCIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiXyIsInNpemUiLCJmaW5kQnlJZENtZCIsIm9wdHMiLCJsb2NhbGl6YWJsZVN0cmluZ3MiLCJpbXBsaWNpdFdhaXRGb3JDb25kaXRpb24iLCJlcnIiLCJtZXNzYWdlIiwibWF0Y2giLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJfcGF0aEZyb21Eb21Ob2RlIiwibm9kZSIsInBhdGgiLCJ2YWx1ZXMiLCJhdHRyaWJ1dGVzIiwiYXR0ck9iaiIsIm5hbWUiLCJ2YWx1ZSIsIl94bWxTb3VyY2VGcm9tSnNvbiIsImpzb25Tb3VyY2UiLCJKU09OIiwicGFyc2UiLCJ3cmFwQXJyYXkiLCJlbmFibGVkIiwiZWxlbWVudE5hbWUiLCJkZWNsYXJhdGlvbiIsImluY2x1ZGUiLCJwcmV0dHlQcmludGluZyIsImluZGVudFN0cmluZyIsIl9wZXJmb3JtWHBhdGhRdWVyeU9uSnNvbiIsInhtbFNvdXJjZSIsImRvbSIsIlhNTERvbSIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsInhwYXRoIiwic2VsZWN0IiwiY3VyUmV0cnkiLCJzb3VyY2VYbWwiLCJnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIiwid2FybiIsInNlbGVjdGVkTm9kZXMiLCJzbGljZSIsImluZGV4UGF0aHMiLCJpcCIsInB1c2giLCJsZW5ndGgiLCJtZXRob2ROYW1lIiwibWV0aG9kQXJncyIsInN0cmluZ2lmeSIsInByb3h5Q21kIiwiam9pbiIsIkIiLCJkZWxheSIsInNjcm9sbFR5cGVzIiwic2Nyb2xsVHlwZSIsImVsZW1lbnRzIiwiaXNFbXB0eSIsImVsZW1lbnQiLCJlbGVtZW50SWQiLCJ2aXNpYmxlRWxzIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJmaXJzdCIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQSxNQUFNQSx5QkFBeUIsR0FBRyx1Q0FBbEM7QUFJQSxNQUFNQyxvQkFBb0IsR0FBRyx1Q0FBN0I7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFELE9BQU8sQ0FBQ0UsV0FBUjtBQUFBLDZDQUFzQixXQUFnQkMsUUFBaEIsRUFBMEJDLFFBQTFCLEVBQW9DQyxJQUFwQyxFQUEwQ0MsT0FBMUMsRUFBbUQ7QUFDdkVBLElBQUFBLE9BQU8sR0FBRyxxQkFBU0EsT0FBVCxDQUFWOztBQUNBLFFBQUksS0FBS0MsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLG1CQUFhLEtBQUtDLHdCQUFMLENBQThCTCxR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QVFGLFVBQVIsQ0FBUDtBQUNELEdBSEQ7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBS0FHLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjakcsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gJ2pzMnhtbHBhcnNlcjInO1xuaW1wb3J0IFhNTERvbSBmcm9tICd4bWxkb20nO1xuaW1wb3J0IHhwYXRoIGZyb20gJ3hwYXRoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHVud3JhcEVsIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG4vLyB3ZSBvdmVycmlkZSB0aGUgeHBhdGggc2VhcmNoIGZvciB0aGlzIGZpcnN0LXZpc2libGUtY2hpbGQgc2VsZWN0b3IsIHdoaWNoXG4vLyBsb29rcyBsaWtlIC8qW0BmaXJzdFZpc2libGU9XCJ0cnVlXCJdXG5jb25zdCBNQUdJQ19GSVJTVF9WSVNfQ0hJTERfU0VMID0gL1xcL1xcKlxcW0BmaXJzdFZpc2libGUgPz0gPygnfFwiKXRydWVcXDFcXF0vO1xuXG4vLyB3ZSBsaWtld2lzZSBvdmVycmlkZSB4cGF0aCBzZWFyY2ggdG8gcHJvdmlkZSBhIHNob3J0Y3V0IGZvciBmaW5kaW5nIGFsbFxuLy8gc2Nyb2xsYWJsZSBlbGVtZW50c1xuY29uc3QgTUFHSUNfU0NST0xMQUJMRV9TRUwgPSAvXFwvXFwvXFwqXFxbQHNjcm9sbGFibGUgPz0gPygnfFwiKXRydWVcXDFcXF0vO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnRleHQgPSB1bndyYXBFbChjb250ZXh0KTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kV2ViRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kVUlFbGVtZW50T3JFbGVtZW50cyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9XG59O1xuXG5oZWxwZXJzLmZpbmRVSUVsZW1lbnRPckVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBpZiAoc3RyYXRlZ3kgIT09IFwieHBhdGhcIikge1xuICAgIHNlbGVjdG9yID0gdXRpbC5lc2NhcGVTcGVjaWFsQ2hhcnMoc2VsZWN0b3IsIFwiJ1wiKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY29udGV4dCA9PT0gXCJ1bmRlZmluZWRcIiB8fCAhY29udGV4dCkge1xuICAgIGNvbnRleHQgPSAnJztcbiAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PT0gXCJzdHJpbmdcIikge1xuICAgIGNvbnRleHQgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhjb250ZXh0LCBcIidcIik7XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcgJiYgTUFHSUNfU0NST0xMQUJMRV9TRUwudGVzdChzZWxlY3RvcikpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kU2Nyb2xsYWJsZUVsT3JFbHMobXVsdCwgY29udGV4dCk7XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcgJiYgTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIGlmIChtdWx0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZ2V0IG11bHRpcGxlIGZpcnN0IGNoaWxkcmVuXCIpO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRGaXJzdFZpc2libGVDaGlsZChjb250ZXh0KTtcbiAgfVxuXG4gIC8vIHByZXZpb3VzbHkgZ2V0U2VsZWN0b3JGb3JTdHJhdGVneVxuICBpZiAoc3RyYXRlZ3kgPT09ICdjbGFzcyBuYW1lJyAmJiBzZWxlY3Rvci5pbmRleE9mKCdVSUEnKSAhPT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoXG4gICAgICBgVGhlIGNsYXNzIG5hbWUgc2VsZWN0b3IgbXVzdCB1c2UgZnVsbCBVSUEgY2xhc3MgbmFtZXMuIFRyeSAnVUlBJHtzZWxlY3Rvcn0nIGluc3RlYWQuYCk7XG4gIH1cblxuICBpZiAoIXNlbGVjdG9yKSBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKCdNaXNzaW5nIHNlbGVjdG9yJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICBsZXQgY3JlYXRlR2V0RWxlbWVudENvbW1hbmQgPSBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gICAgbGV0IGV4dCA9IG11bHQgPyAncycgOiAnJztcbiAgICBsZXQgY29tbWFuZCA9IFwiXCI7XG4gICAgY29udGV4dCA9ICFjb250ZXh0ID8gY29udGV4dCA6IGAsICcke2NvbnRleHR9J2AgO1xuICAgIHN3aXRjaCAoc3RyYXRlZ3kpIHtcbiAgICAgIGNhc2UgXCJuYW1lXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5TmFtZSgnJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJhY2Nlc3NpYmlsaXR5IGlkXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5QWNjZXNzaWJpbGl0eUlkKCcke3NlbGVjdG9yfScke2NvbnRleHR9KWA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImlkXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5SWQoJyR7c2VsZWN0b3J9JylgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCItaW9zIHVpYXV0b21hdGlvblwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVVJQXV0b21hdGlvbignJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5VHlwZSgnJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgIH1cblxuICAgIHJldHVybiBjb21tYW5kO1xuICB9O1xuXG4gIGxldCBnZXRMb2NhbGl6ZWRTdHJpbmdGb3JTZWxlY3RvciA9IGZ1bmN0aW9uIChzZWxlY3Rvciwgc3RyaW5ncykge1xuICAgIGxldCBuZXdTZWxlY3RvciA9IHNlbGVjdG9yO1xuICAgIGlmIChzdHJpbmdzKSB7XG4gICAgICBsZXQgbG9jYWxpemVkU2VsZWN0b3IgPSBzdHJpbmdzW3NlbGVjdG9yXTtcbiAgICAgIGlmIChsb2NhbGl6ZWRTZWxlY3Rvcikge1xuICAgICAgICBuZXdTZWxlY3RvciA9IGxvY2FsaXplZFNlbGVjdG9yO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBJZCBzZWxlY3RvciwgJyR7c2VsZWN0b3J9Jywgbm90IGZvdW5kIGluIExvY2FsaXphYmxlLnN0cmluZ3MuYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1NlbGVjdG9yO1xuICB9O1xuXG4gIGxldCByZXM7XG4gIGxldCBkb0ZpbmQgPSBhc3luYyAoKSA9PiB7XG4gICAgaWYgKHN0cmF0ZWd5ID09PSBcInhwYXRoXCIpIHtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudHNCeVhwYXRoKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSBcImlkXCIpIHtcbiAgICAgIC8vIEZvciB0aGUgSUQgc3RyYXRlZ3ksIHdlIGZpcnN0IHdhbnQgdG8gaGFuZGxlIHRoZSBzZWxlY3RvciBhcyBhblxuICAgICAgLy8gYWNjZXNzaWJpbGl0eSBpZC4gSWYgbm8gZWxlbWVudCBpcyBmb3VuZCBieSB0aGF0IHN0cmF0ZWd5LCB3ZSBmYWxsXG4gICAgICAvLyBiYWNrIHRvIHNlYXJjaGluZyBmb3IgdGhlIHN0cmluZy5cbiAgICAgIGxldCBmaW5kQnlBeElkQ21kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoXCJhY2Nlc3NpYmlsaXR5IGlkXCIsIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGZpbmRCeUF4SWRDbWQpO1xuICAgICAgaWYgKCEocmVzICYmIF8uc2l6ZShyZXMpID4gMCkpIHtcbiAgICAgICAgLy8gU2luY2Ugbm8gZWxlbWVudCB3YXMgZm91bmQgdXNpbmcgdGhlIGFjY2Vzc2liaWxpdHkgaWQsIHdlIGZhbGxcbiAgICAgICAgLy8gYmFjayB0byBzZWFyY2ggYnkgc3RyaW5nLlxuICAgICAgICBsZXQgZmluZEJ5SWRDbWQgPSBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZChcImlkXCIsIGdldExvY2FsaXplZFN0cmluZ0ZvclNlbGVjdG9yKHNlbGVjdG9yLFxuICAgICAgICAgIHRoaXMub3B0cy5sb2NhbGl6YWJsZVN0cmluZ3MpLCBtdWx0LCBjb250ZXh0KTtcbiAgICAgICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoZmluZEJ5SWRDbWQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgY29tbWFuZCA9IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgICB9XG4gICAgcmV0dXJuIF8uc2l6ZShyZXMpID4gMDtcbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGRvRmluZCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxuICAgICAgcmVzID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gcmVzO1xuICB9IGVsc2Uge1xuICAgIGlmICghcmVzIHx8IF8uc2l6ZShyZXMpID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG59O1xuXG5sZXQgX3BhdGhGcm9tRG9tTm9kZSA9IGZ1bmN0aW9uIChub2RlKSB7XG4gIGxldCBwYXRoID0gbnVsbDtcbiAgZm9yIChsZXQgYXR0ck9iaiBvZiBfLnZhbHVlcyhub2RlLmF0dHJpYnV0ZXMpKSB7XG4gICAgaWYgKGF0dHJPYmoubmFtZSA9PT0gXCJwYXRoXCIpIHtcbiAgICAgIHBhdGggPSBhdHRyT2JqLnZhbHVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGF0aDtcbn07XG5cbmxldCBfeG1sU291cmNlRnJvbUpzb24gPSBmdW5jdGlvbiAoanNvblNvdXJjZSkge1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09IFwic3RyaW5nXCIpIHtcbiAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgfVxuICByZXR1cm4ganMyeG1sKFwiQXBwaXVtQVVUXCIsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiBcIiAgICBcIn1cbiAgfSk7XG59O1xuXG5sZXQgX3BlcmZvcm1YcGF0aFF1ZXJ5T25Kc29uID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBqc29uU291cmNlKSB7XG4gIGxldCB4bWxTb3VyY2UgPSBfeG1sU291cmNlRnJvbUpzb24oanNvblNvdXJjZSk7XG4gIGxldCBkb20gPSBuZXcgWE1MRG9tLkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh4bWxTb3VyY2UpO1xuICByZXR1cm4geHBhdGguc2VsZWN0KHNlbGVjdG9yLCBkb20pO1xufTtcblxuY29tbWFuZHMuZmluZFVJRWxlbWVudHNCeVhwYXRoID0gYXN5bmMgZnVuY3Rpb24gKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0ID0gbnVsbCwgY3VyUmV0cnkgPSAxKSB7XG4gIGxldCBzb3VyY2VYbWw7XG4gIHRyeSB7XG4gICAgc291cmNlWG1sID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MKGNvbnRleHQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIud2FybihcIkVycm9yIGdldHRpbmcgc291cmNlLCBjYW4ndCBjb250aW51ZSBmaW5kaW5nIGVsZW1lbnQgYnkgWFBhdGhcIik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIGxldCBzZWxlY3RlZE5vZGVzID0gX3BlcmZvcm1YcGF0aFF1ZXJ5T25Kc29uKHNlbGVjdG9yLCBzb3VyY2VYbWwpO1xuXG4gIGlmICghbXVsdCkge1xuICAgIHNlbGVjdGVkTm9kZXMgPSBzZWxlY3RlZE5vZGVzLnNsaWNlKDAsIDEpO1xuICB9XG4gIGxldCBpbmRleFBhdGhzID0gW107XG4gIC8vIGZpbHRlciBvdXQgZWxlbWVudHMgd2l0aG91dCAncGF0aCcgYXR0cmlidXRlXG4gIGZvciAobGV0IG5vZGUgb2Ygc2VsZWN0ZWROb2Rlcykge1xuICAgIGxldCBpcCA9IF9wYXRoRnJvbURvbU5vZGUobm9kZSk7XG4gICAgaWYgKGlwICE9PSBudWxsKSB7XG4gICAgICBpbmRleFBhdGhzLnB1c2goaXApO1xuICAgIH1cbiAgfVxuXG4gIGlmIChpbmRleFBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAvLyBhbmQgaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgbWF0Y2hpbmcgbm9kZXMsIHJldHVybiB0aGUgZW1wdHkgYXJyYXlcbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvLyBvdGhlcndpc2UgbG9vayB1cCB0aGUgYWN0dWFsIGVsZW1lbnQgYnkgaXRzIGluZGV4IHBhdGhcbiAgbGV0IG1ldGhvZE5hbWU7XG4gIGxldCBtZXRob2RBcmdzID0gW107XG5cbiAgaWYgKCFtdWx0KSB7XG4gICAgbWV0aG9kTmFtZSA9IFwiZ2V0RWxlbWVudEJ5SW5kZXhQYXRoXCI7XG4gICAgbWV0aG9kQXJnc1swXSA9IGAnJHtpbmRleFBhdGhzWzBdfSdgO1xuICB9IGVsc2Uge1xuICAgIG1ldGhvZE5hbWUgPSBcImdldEVsZW1lbnRzQnlJbmRleFBhdGhzXCI7XG4gICAgbWV0aG9kQXJnc1swXSA9IEpTT04uc3RyaW5naWZ5KGluZGV4UGF0aHMpO1xuICB9XG5cbiAgaWYgKGNvbnRleHQpIHtcbiAgICBtZXRob2RBcmdzWzFdID0gYGF1LmdldEVsZW1lbnQoJyR7Y29udGV4dH0nKWA7XG4gIH1cblxuICBsZXQgcHJveHlDbWQgPSBgYXUuJHttZXRob2ROYW1lfSgke21ldGhvZEFyZ3Muam9pbihcIiwgXCIpfSlgO1xuXG4gIC8vIGhhdmluZyBpbmRleCBwYXRocyBtZWFucyB3ZSB0aGluayBlbGVtZW50cyBzaG91bGQgYmUgdGhlcmUuIFNvbWV0aW1lc1xuICAvLyB1aWF1dG8gbGFncyBpbiBlbmFibGluZyB1cyB0byBnZXQgZWxlbWVudHMsIHNvIHdlIHJldHJ5IGEgZmV3IHRpbWVzIGlmXG4gIC8vIGl0IGNhbid0IGZpbmQgZWxlbWVudHMgd2Uga25vdyBzaG91bGQgYmUgdGhlcmUuIHNlZSB1aWF1dG8gY29kZVxuICAvLyBmb3IgbW9yZSBsb2dpY1xuICBsZXQgcmVzO1xuICB0cnkge1xuICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHByb3h5Q21kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gd2UgZ2V0IGEgU3RhbGVFbGVtZW50UmVmZXJlbmNlIGlmIHVpYXV0byBjYW4ndCBmaW5kIGFuIGVsZW1lbnRcbiAgICAvLyBieSB0aGUgcGF0aCB3ZSBtZW50aW9uZWRcbiAgICBpZiAoY3VyUmV0cnkgPCAzKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJHb3QgYSB3YXJuaW5nIGZyb20gdWlhdXRvIHRoYXQgc29tZSBpbmRleCBwYXRocyBcIiArXG4gICAgICAgICAgICAgICAgICAgXCJjb3VsZCBub3QgYmUgcmVzb2x2ZWQsIHRyeWluZyBhZ2FpblwiKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoMzAwKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRzQnlYcGF0aChzZWxlY3RvciwgbXVsdCwgY29udGV4dCwgY3VyUmV0cnkgKyAxKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIHJldHVybiByZXM7XG59O1xuXG5oZWxwZXJzLmZpbmRTY3JvbGxhYmxlRWxPckVscyA9IGFzeW5jIGZ1bmN0aW9uIChtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnN0IHNjcm9sbFR5cGVzID0gWydVSUFTY3JvbGxWaWV3JywgJ1VJQVRhYmxlVmlldycsICdVSUFDb2xsZWN0aW9uVmlldycsICdVSUFXZWJWaWV3J107XG4gIGxldCByZXMgPSBbXTtcbiAgY29uc3QgZXh0ID0gbXVsdCA/ICdzJyA6ICcnO1xuICBmb3IgKGNvbnN0IHNjcm9sbFR5cGUgb2Ygc2Nyb2xsVHlwZXMpIHtcbiAgICBjb25zdCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVR5cGUoJyR7c2Nyb2xsVHlwZX0nJHtjb250ZXh0fSlgO1xuXG4gICAgaWYgKG11bHQpIHtcbiAgICAgIGxldCBlbGVtZW50cyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoZWxlbWVudHMpKSB7XG4gICAgICAgIHJlcy5wdXNoKC4uLmVsZW1lbnRzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGVsZW1lbnQgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgICAgIGlmIChlbGVtZW50KSB7XG4gICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChtdWx0KSB7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG59O1xuXG5oZWxwZXJzLmdldEZpcnN0VmlzaWJsZUNoaWxkID0gYXN5bmMgZnVuY3Rpb24gKGVsZW1lbnRJZCkge1xuICBsZXQgdmlzaWJsZUVscyA9IGF3YWl0IHRoaXMuZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQoJy1pb3MgdWlhdXRvbWF0aW9uJywgJy5lbGVtZW50cygpLndpdGhQcmVkaWNhdGUoXCJpc1Zpc2libGUgPT0gMVwiKTsnLCBlbGVtZW50SWQpO1xuICByZXR1cm4gXy5maXJzdCh2aXNpYmxlRWxzKTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9maW5kLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
