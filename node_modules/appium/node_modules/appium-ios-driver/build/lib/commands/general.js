"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var utils = _interopRequireWildcard(require("../utils"));

var _nodeSimctl = require("node-simctl");

var _moment = _interopRequireDefault(require("moment"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';
commands.active = (0, _asyncToGenerator2.default)(function* () {
  if (this.isWebContext()) {
    return yield this.executeAtom('active_element', []);
  } else {
    return yield this.uiAutoClient.sendCommand("au.getActiveElement()");
  }
});

commands.getDeviceTime = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (format = MOMENT_FORMAT_ISO8601) {
    _logger.default.info('Attempting to capture iOS device date and time');

    let cmd;
    let args;
    let inputFormat;

    if (this.isRealDevice()) {
      try {
        cmd = yield _appiumSupport.fs.which('idevicedate');
      } catch (err) {
        _logger.default.errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');
      }

      _logger.default.info(`Found idevicedate: '${cmd}'`);

      args = ['-u', this.opts.udid];
      inputFormat = 'ddd MMM DD HH:mm:ss z YYYY';
    } else {
      _logger.default.warn('On simulator. Assuming device time is the same as host time');

      cmd = 'date';
      args = ['+%Y-%m-%dT%H:%M:%S%z'];
      inputFormat = MOMENT_FORMAT_ISO8601;
    }

    const stdout = (yield (0, _teen_process.exec)(cmd, args)).stdout.trim();

    _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

    const parsedTimestamp = (0, _moment.default)(stdout, inputFormat);

    if (!parsedTimestamp.isValid()) {
      _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

      return stdout;
    }

    return parsedTimestamp.format(format);
  });

  return function () {
    return _ref2.apply(this, arguments);
  };
}();

commands.hideKeyboard = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (strategy, ...possibleKeys) {
    possibleKeys.pop();
    let cmd;

    let key = _lodash.default.find(possibleKeys, k => {
      return k;
    });

    if (key) {
      strategy = strategy || 'pressKey';
      cmd = `au.hideKeyboard('${strategy}', '${key}')`;
    } else {
      strategy = strategy || 'default';
      cmd = `au.hideKeyboard('${strategy}')`;
    }

    yield this.uiAutoClient.sendCommand(cmd);
  });

  return function (_x) {
    return _ref3.apply(this, arguments);
  };
}();

commands.getPageSource = (0, _asyncToGenerator2.default)(function* () {
  if (this.isWebContext()) {
    const script = 'return document.documentElement.outerHTML';
    return yield this.executeAtom('execute_script', [script, []]);
  } else {
    return yield this.getNativePageSource();
  }
});
helpers.getNativePageSource = (0, _asyncToGenerator2.default)(function* () {
  let jsonSource = yield this.getSourceForElementForXML();

  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }

  let xmlSource = (0, _js2xmlparser.default)("AppiumAUT", jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: "element"
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: "    "
    }
  });
  return xmlSource;
});

commands.background = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (secs) {
    yield this.uiAutoClient.sendCommand(`au.background(${secs})`);
  });

  return function (_x2) {
    return _ref6.apply(this, arguments);
  };
}();

commands.lock = function () {
  var _ref7 = (0, _asyncToGenerator2.default)(function* (secs) {
    if (!secs) {
      _logger.default.debug('No seconds parameter. Using 0 seconds');

      secs = 0;
    }

    yield this.uiAutoClient.sendCommand(`au.lock(${secs})`);
  });

  return function (_x3) {
    return _ref7.apply(this, arguments);
  };
}();

commands.closeApp = (0, _asyncToGenerator2.default)(function* () {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    yield this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
});
commands.launchApp = (0, _asyncToGenerator2.default)(function* () {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    yield this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
});

commands.removeApp = function () {
  var _ref10 = (0, _asyncToGenerator2.default)(function* (bundleId) {
    if (this.isRealDevice()) {
      yield this.realDevice.remove(bundleId);
    } else {
      yield this.sim.removeApp(bundleId);
    }
  });

  return function (_x4) {
    return _ref10.apply(this, arguments);
  };
}();

commands.keys = function () {
  var _ref11 = (0, _asyncToGenerator2.default)(function* (keys) {
    if (this.isWebContext()) {
      let el = yield this.active();

      if (_lodash.default.isUndefined(el.ELEMENT)) {
        throw new _appiumBaseDriver.errors.NoSuchElementError();
      }

      yield this.setValue(keys, el.ELEMENT);
    } else {
      if (_lodash.default.isArray(keys)) {
        keys = keys.join('');
      }

      if (!_lodash.default.isString(keys)) {
        keys = keys.toString();
      }

      keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
      let command = `au.sendKeysToActiveElement('${keys}')`;
      yield this.uiAutoClient.sendCommand(command);
    }
  });

  return function (_x5) {
    return _ref11.apply(this, arguments);
  };
}();

commands.setGeoLocation = function () {
  var _ref12 = (0, _asyncToGenerator2.default)(function* (location) {
    yield this.uiAutoClient.sendCommand(`target.setLocation(${JSON.stringify(location)})`);
  });

  return function (_x6) {
    return _ref12.apply(this, arguments);
  };
}();

commands.getWindowSize = function () {
  var _ref13 = (0, _asyncToGenerator2.default)(function* (windowHandle = "current") {
    if (windowHandle !== "current") {
      throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");
    }

    if (this.isWebContext()) {
      return yield this.executeAtom('get_window_size', []);
    } else {
      return yield this.uiAutoClient.sendCommand("au.getWindowSize()");
    }
  });

  return function () {
    return _ref13.apply(this, arguments);
  };
}();

commands.getWindowRect = (0, _asyncToGenerator2.default)(function* () {
  const _ref15 = yield this.getWindowSize(),
        width = _ref15.width,
        height = _ref15.height;

  return {
    width,
    height,
    x: 0,
    y: 0
  };
});

commands.getStrings = function () {
  var _ref16 = (0, _asyncToGenerator2.default)(function* (language, stringFile = null) {
    _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

    return yield utils.parseLocalizableStrings(Object.assign({}, this.opts, {
      language,
      stringFile,
      strictMode: true
    }));
  });

  return function (_x7) {
    return _ref16.apply(this, arguments);
  };
}();

commands.setUrl = function () {
  var _ref17 = (0, _asyncToGenerator2.default)(function* (url) {
    _logger.default.debug(`Attempting to set url '${url}'`);

    if (!this.isWebContext()) {
      yield (0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url);
      return;
    }

    this.setCurrentUrl(url);
    this.curWebFrames = [];
    yield this.remote.navToUrl(url);
  });

  return function (_x8) {
    return _ref17.apply(this, arguments);
  };
}();

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiZ2V0RGV2aWNlVGltZSIsImZvcm1hdCIsImxvZyIsImluZm8iLCJjbWQiLCJhcmdzIiwiaW5wdXRGb3JtYXQiLCJpc1JlYWxEZXZpY2UiLCJmcyIsIndoaWNoIiwiZXJyIiwiZXJyb3JBbmRUaHJvdyIsIm9wdHMiLCJ1ZGlkIiwid2FybiIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJpc1ZhbGlkIiwiaGlkZUtleWJvYXJkIiwic3RyYXRlZ3kiLCJwb3NzaWJsZUtleXMiLCJwb3AiLCJrZXkiLCJfIiwiZmluZCIsImsiLCJnZXRQYWdlU291cmNlIiwic2NyaXB0IiwiZ2V0TmF0aXZlUGFnZVNvdXJjZSIsImpzb25Tb3VyY2UiLCJnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIiwiSlNPTiIsInBhcnNlIiwieG1sU291cmNlIiwid3JhcEFycmF5IiwiZW5hYmxlZCIsImVsZW1lbnROYW1lIiwiZGVjbGFyYXRpb24iLCJpbmNsdWRlIiwicHJldHR5UHJpbnRpbmciLCJpbmRlbnRTdHJpbmciLCJiYWNrZ3JvdW5kIiwic2VjcyIsImxvY2siLCJjbG9zZUFwcCIsImFwcE5hbWUiLCJhcHAiLCJidW5kbGVJZCIsInN0b3AiLCJsYXVuY2hBcHAiLCJzdGFydCIsInJlbW92ZUFwcCIsInJlYWxEZXZpY2UiLCJyZW1vdmUiLCJzaW0iLCJrZXlzIiwiZWwiLCJpc1VuZGVmaW5lZCIsIkVMRU1FTlQiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJzZXRWYWx1ZSIsImlzQXJyYXkiLCJpc1N0cmluZyIsInRvU3RyaW5nIiwidXRpbCIsImVzY2FwZVNwZWNpYWxDaGFycyIsImNvbW1hbmQiLCJzZXRHZW9Mb2NhdGlvbiIsImxvY2F0aW9uIiwic3RyaW5naWZ5IiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXRXaW5kb3dSZWN0Iiwid2lkdGgiLCJoZWlnaHQiLCJ4IiwieSIsImdldFN0cmluZ3MiLCJsYW5ndWFnZSIsInN0cmluZ0ZpbGUiLCJ1dGlscyIsInBhcnNlTG9jYWxpemFibGVTdHJpbmdzIiwiT2JqZWN0IiwiYXNzaWduIiwic3RyaWN0TW9kZSIsInNldFVybCIsInVybCIsInNldEN1cnJlbnRVcmwiLCJjdXJXZWJGcmFtZXMiLCJyZW1vdGUiLCJuYXZUb1VybCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7OztBQUVBLE1BQU1DLHFCQUFxQixHQUFHLHNCQUE5QjtBQUVBSCxRQUFRLENBQUNJLE1BQVQsbUNBQWtCLGFBQWtCO0FBQ2xDLE1BQUksS0FBS0MsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLGlCQUFhLEtBQUtDLFdBQUwsQ0FBaUIsZ0JBQWpCLEVBQW1DLEVBQW5DLENBQWI7QUFDRCxHQUZELE1BRU87QUFDTCxpQkFBYSxLQUFLQyxZQUFMLENBQWtCQyxXQUFsQixDQUE4Qix1QkFBOUIsQ0FBYjtBQUNEO0FBQ0YsQ0FORDs7QUFpQkFSLFFBQVEsQ0FBQ1MsYUFBVDtBQUFBLDhDQUF5QixXQUFnQkMsTUFBTSxHQUFHUCxxQkFBekIsRUFBZ0Q7QUFDdkVRLG9CQUFJQyxJQUFKLENBQVMsZ0RBQVQ7O0FBQ0EsUUFBSUMsR0FBSjtBQUNBLFFBQUlDLElBQUo7QUFDQSxRQUFJQyxXQUFKOztBQUNBLFFBQUksS0FBS0Ms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OztBQUNELFNBQUtDLGFBQUwsQ0FBbUJELEdBQW5CO0FBRUEsU0FBS0UsWUFBTCxHQUFvQixFQUFwQjtBQUNBLFVBQU0sS0FBS0MsTUFBTCxDQUFZQyxRQUFaLENBQXFCSixHQUFyQixDQUFOO0FBQ0QsR0FYRDs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFjQUosTUFBTSxDQUFDQyxNQUFQLENBQWMvRixVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGpzMnhtbCBmcm9tIFwianMyeG1scGFyc2VyMlwiO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IG9wZW5VcmwgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgTU9NRU5UX0ZPUk1BVF9JU084NjAxID0gJ1lZWVktTU0tRERUSEg6bW06c3NaJztcblxuY29tbWFuZHMuYWN0aXZlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdhY3RpdmVfZWxlbWVudCcsIFtdKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoXCJhdS5nZXRBY3RpdmVFbGVtZW50KClcIik7XG4gIH1cbn07XG5cbi8qKlxuICogUmV0cmlldmVzIHRoZSBjdXJyZW50IGRldmljZSdzIHRpbWVzdGFtcC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZm9ybWF0IC0gVGhlIHNldCBvZiBmb3JtYXQgc3BlY2lmaWVycy4gUmVhZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBzOi8vbW9tZW50anMuY29tL2RvY3MvIHRvIGdldCB0aGUgZnVsbCBsaXN0IG9mIHN1cHBvcnRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGV0aW1lIGZvcm1hdCBzcGVjaWZpZXJzLiBUaGUgZGVmYXVsdCBmb3JtYXQgaXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBgWVlZWS1NTS1ERFRISDptbTpzc1pgLCB3aGljaCBjb21wbGllcyB0byBJU08tODYwMVxuICogQHJldHVybnMgRm9ybWF0dGVkIGRhdGV0aW1lIHN0cmluZyBvciB0aGUgcmF3IGNvbW1hbmQgb3V0cHV0IGlmIGZvcm1hdHRpbmcgZmFpbHNcbiAqL1xuY29tbWFuZHMuZ2V0RGV2aWNlVGltZSA9IGFzeW5jIGZ1bmN0aW9uIChmb3JtYXQgPSBNT01FTlRfRk9STUFUX0lTTzg2MDEpIHtcbiAgbG9nLmluZm8oJ0F0dGVtcHRpbmcgdG8gY2FwdHVyZSBpT1MgZGV2aWNlIGRhdGUgYW5kIHRpbWUnKTtcbiAgbGV0IGNtZDtcbiAgbGV0IGFyZ3M7XG4gIGxldCBpbnB1dEZvcm1hdDtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0cnkge1xuICAgICAgY21kID0gYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VkYXRlJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGNhcHR1cmUgZGV2aWNlIGRhdGUgYW5kIHRpbWUgdXNpbmcgbGliaW1vYmlsZWRldmljZSBpZGV2aWNlZGF0ZS4gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnTGliaW1vYmlsZWRldmljZSBpcyBwcm9iYWJseSBub3QgaW5zdGFsbGVkJyk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBGb3VuZCBpZGV2aWNlZGF0ZTogJyR7Y21kfSdgKTtcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbGliaW1vYmlsZWRldmljZS9saWJpbW9iaWxlZGV2aWNlL2Jsb2IvMjYzNzNiMzM0ODg5ZjVhZTJlMjczN2ZmNDQ3ZWIyNWIxNzAwZmEyZi90b29scy9pZGV2aWNlZGF0ZS5jI0wxMjlcbiAgICBhcmdzID0gWyctdScsIHRoaXMub3B0cy51ZGlkXTtcbiAgICBpbnB1dEZvcm1hdCA9ICdkZGQgTU1NIEREIEhIOm1tOnNzIHogWVlZWSc7XG4gIH0gZWxzZSB7XG4gICAgbG9nLndhcm4oJ09uIHNpbXVsYXRvci4gQXNzdW1pbmcgZGV2aWNlIHRpbWUgaXMgdGhlIHNhbWUgYXMgaG9zdCB0aW1lJyk7XG4gICAgY21kID0gJ2RhdGUnO1xuICAgIGFyZ3MgPSBbJyslWS0lbS0lZFQlSDolTTolUyV6J107XG4gICAgaW5wdXRGb3JtYXQgPSBNT01FTlRfRk9STUFUX0lTTzg2MDE7XG4gIH1cbiAgY29uc3Qgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoY21kLCBhcmdzKSkuc3Rkb3V0LnRyaW0oKTtcbiAgbG9nLmRlYnVnKGBHb3QgdGhlIGZvbGxvd2luZyBvdXRwdXQgb3V0IG9mICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nOiAke3N0ZG91dH1gKTtcbiAgY29uc3QgcGFyc2VkVGltZXN0YW1wID0gbW9tZW50KHN0ZG91dCwgaW5wdXRGb3JtYXQpO1xuICBpZiAoIXBhcnNlZFRpbWVzdGFtcC5pc1ZhbGlkKCkpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHBhcnNlIHRoZSB0aW1lc3RhbXAgJyR7c3Rkb3V0fScgcmV0dXJuZWQgYnkgJyR7Y21kfScgY29tbWFuZC4gUmV0dXJuaW5nIGl0IGFzIGlzYCk7XG4gICAgcmV0dXJuIHN0ZG91dDtcbiAgfVxuICByZXR1cm4gcGFyc2VkVGltZXN0YW1wLmZvcm1hdChmb3JtYXQpO1xufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBsZXQgY21kO1xuICBsZXQga2V5ID0gXy5maW5kKHBvc3NpYmxlS2V5cywgKGspID0+IHtyZXR1cm4gazt9KTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3Qgc2NyaXB0ID0gJ3JldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MJztcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE5hdGl2ZVBhZ2VTb3VyY2UoKTtcbiAgfVxufTtcblxuaGVscGVycy5nZXROYXRpdmVQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQganNvblNvdXJjZSA9IGF3YWl0IHRoaXMuZ2V0U291cmNlRm9yRWxlbWVudEZvclhNTCgpO1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09IFwic3RyaW5nXCIpIHtcbiAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgfVxuICBsZXQgeG1sU291cmNlID0ganMyeG1sKFwiQXBwaXVtQVVUXCIsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiBcIiAgICBcIn1cbiAgfSk7XG4gIHJldHVybiB4bWxTb3VyY2U7XG59O1xuXG5jb21tYW5kcy5iYWNrZ3JvdW5kID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmJhY2tncm91bmQoJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmxvY2sgPSBhc3luYyBmdW5jdGlvbiAoc2Vjcykge1xuICBpZiAoIXNlY3MpIHtcbiAgICBsb2cuZGVidWcoJ05vIHNlY29uZHMgcGFyYW1ldGVyLiBVc2luZyAwIHNlY29uZHMnKTtcbiAgICBzZWNzID0gMDtcbiAgfVxuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgYXUubG9jaygke3NlY3N9KWApO1xufTtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBhcHBOYW1lID0gdGhpcy5vcHRzLmFwcCB8fCB0aGlzLm9wdHMuYnVuZGxlSWQ7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBjbG9zZWQgdGhlICcke2FwcE5hbWV9JyBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBjbG9zaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RhcnQoKTtcbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGxhdW5jaGVkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgbGF1bmNoaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMucmVtb3ZlQXBwID0gYXN5bmMgZnVuY3Rpb24gKGJ1bmRsZUlkKSB7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgYXdhaXQgdGhpcy5yZWFsRGV2aWNlLnJlbW92ZShidW5kbGVJZCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5zaW0ucmVtb3ZlQXBwKGJ1bmRsZUlkKTtcbiAgfVxufTtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIChrZXlzKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGVsID0gYXdhaXQgdGhpcy5hY3RpdmUoKTtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChlbC5FTEVNRU5UKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5zZXRWYWx1ZShrZXlzLCBlbC5FTEVNRU5UKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoXy5pc0FycmF5KGtleXMpKSB7XG4gICAgICBrZXlzID0ga2V5cy5qb2luKCcnKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzU3RyaW5nKGtleXMpKSB7XG4gICAgICBrZXlzID0ga2V5cy50b1N0cmluZygpO1xuICAgIH1cbiAgICBrZXlzID0gdXRpbC5lc2NhcGVTcGVjaWFsQ2hhcnMoa2V5cywgXCInXCIpO1xuICAgIGxldCBjb21tYW5kID0gYGF1LnNlbmRLZXlzVG9BY3RpdmVFbGVtZW50KCcke2tleXN9JylgO1xuICAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5zZXRHZW9Mb2NhdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIChsb2NhdGlvbikge1xuICAvLyBUT0RPOiBjaGVjayB0aGUgaGFzT3B0aW9ucyBiaXQsIHRoZSBtZXRob2Qgc2lnbmF0dXJlIHNob3VsZCBiZSBsb2NhdGlvbiwgb3B0aW9uXG5cbiAgLy8gbGV0IGhhc09wdGlvbnMgPSBhbHRpdHVkZSAhPT0gbnVsbCB8fCBob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwgfHwgdmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCB8fCBjb3Vyc2UgIT09IG51bGwgfHwgc3BlZWQgIT09IG51bGw7XG4gIC8vIGlmIChoYXNPcHRpb25zKSB7XG4gIC8vICAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgLy8gICBpZiAoYWx0aXR1ZGUgIT09IG51bGwpIHtcbiAgLy8gICAgIG9wdGlvbnMuYWx0aXR1ZGUgPSBhbHRpdHVkZTtcbiAgLy8gICB9XG4gIC8vICAgaWYgKGhvcml6b250YWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5ob3Jpem9udGFsQWNjdXJhY3kgPSBob3Jpem9udGFsQWNjdXJhY3k7XG4gIC8vICAgfVxuICAvLyAgIGlmICh2ZXJ0aWNhbEFjY3VyYWN5ICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLnZlcnRpY2FsQWNjdXJhY3kgPSB2ZXJ0aWNhbEFjY3VyYWN5O1xuICAvLyAgIH1cbiAgLy8gICBpZiAoY291cnNlICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLmNvdXJzZSA9IGNvdXJzZTtcbiAgLy8gICB9XG4gIC8vICAgaWYgKHNwZWVkICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLnNwZWVkID0gc3BlZWQ7XG4gIC8vICAgfVxuICAvLyAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFxuICAvLyAgICAgYHRhcmdldC5zZXRMb2NhdGlvbldpdGhPcHRpb25zKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRpbmF0ZXMpfSwgJHtKU09OLnN0cmluZ2lmeShvcHRpb25zKX0pYCk7XG4gIC8vIH0gZWxzZSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGB0YXJnZXQuc2V0TG9jYXRpb24oJHtKU09OLnN0cmluZ2lmeShsb2NhdGlvbil9KWApO1xuICAvLyB9XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKHdpbmRvd0hhbmRsZSA9IFwiY3VycmVudFwiKSB7XG4gIGlmICh3aW5kb3dIYW5kbGUgIT09IFwiY3VycmVudFwiKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKFwiQ3VycmVudGx5IG9ubHkgZ2V0dGluZyBjdXJyZW50IHdpbmRvdyBzaXplIGlzIHN1cHBvcnRlZC5cIik7XG4gIH1cblxuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfd2luZG93X3NpemUnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFwiYXUuZ2V0V2luZG93U2l6ZSgpXCIpO1xuICB9XG59O1xuXG4vLyBGb3IgVzNDXG5jb21tYW5kcy5nZXRXaW5kb3dSZWN0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwXG4gIH07XG59O1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gKGxhbmd1YWdlLCBzdHJpbmdGaWxlID0gbnVsbCkge1xuICBsb2cuZGVidWcoYEdldHRpbmdzIHN0cmluZ3MgZm9yIGxhbmd1YWdlICcke2xhbmd1YWdlfScgYW5kIHN0cmluZyBmaWxlICcke3N0cmluZ0ZpbGV9J2ApO1xuICByZXR1cm4gYXdhaXQgdXRpbHMucGFyc2VMb2NhbGl6YWJsZVN0cmluZ3MoT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5vcHRzLCB7XG4gICAgbGFuZ3VhZ2UsXG4gICAgc3RyaW5nRmlsZSxcbiAgICBzdHJpY3RNb2RlOiB0cnVlLFxuICB9KSk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIC8vIHVzZSB4Y3J1biB0byBvcGVuIGRlZXBsaW5rXG4gICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCB1cmwpO1xuICAgIHJldHVybjtcbiAgfVxuICB0aGlzLnNldEN1cnJlbnRVcmwodXJsKTtcbiAgLy8gbWFrZSBzdXJlIHRvIGNsZWFyIG91dCBhbnkgbGVmdG92ZXIgd2ViIGZyYW1lc1xuICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICBhd2FpdCB0aGlzLnJlbW90ZS5uYXZUb1VybCh1cmwpO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
