"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

helpers.getSimFileFullPath = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (remotePath) {
    let basePath = this.sim.getDir();
    let appName = null;

    if (this.opts.app) {
      let appNameRegex = new RegExp(`\\${_path.default.sep}([\\w-]+\\.app)`);
      let appNameMatches = appNameRegex.exec(this.opts.app);

      if (appNameMatches) {
        appName = appNameMatches[1];
      }
    }

    if (_appiumSupport.system.isWindows()) {
      if (remotePath.indexof("://") === 1) {
        remotePath = remotePath.slice(4);
      }
    } else {
      if (remotePath.indexOf("/") === 0) {
        remotePath = remotePath.slice(1);
      }
    }

    if (remotePath.indexOf(appName) === 0) {
      _logger.default.debug("We want an app-relative file");

      let findPath = basePath;

      if (this.opts.platformVersion >= 8) {
        findPath = _path.default.resolve(basePath, "Containers", "Bundle");
      }

      findPath = findPath.replace(/\s/g, '\\ ');

      let _ref2 = yield (0, _teen_process.exec)('find', [findPath, '-name', appName]),
          stdout = _ref2.stdout;

      let appRoot = stdout.replace(/\n$/, '');
      let subPath = remotePath.substring(appName.length + 1);
      return _path.default.resolve(appRoot, subPath);
    } else {
      _logger.default.debug("We want a sim-relative file");

      return _path.default.resolve(basePath, remotePath);
    }
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
}();

commands.pushFile = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (remotePath, base64Data) {
    _logger.default.debug(`Pushing ${remotePath} to iOS simulator`);

    if (this.isRealDevice()) {
      _logger.default.debug("Unsupported: cannot write files to physical device");

      throw new _appiumBaseDriver.errors.NotYetImplementedError();
    }

    let fullPath = yield this.getSimFileFullPath(remotePath);

    _logger.default.debug(`Attempting to write ${fullPath}...`);

    if (yield _appiumSupport.fs.exists(fullPath)) {
      _logger.default.debug(`${fullPath} already exists, deleting...`);

      yield _appiumSupport.fs.unlink(fullPath);
    }

    yield (0, _appiumSupport.mkdirp)(_path.default.dirname(fullPath));
    let content = Buffer.from(base64Data, 'base64');
    yield _appiumSupport.fs.writeFile(fullPath, content);

    _logger.default.debug(`Wrote ${content.length} bytes to ${fullPath}`);
  });

  return function (_x2, _x3) {
    return _ref3.apply(this, arguments);
  };
}();

commands.pullFile = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (remotePath) {
    _logger.default.debug(`Pulling ${remotePath} from sim`);

    if (this.isRealDevice()) {
      throw new _appiumBaseDriver.errors.NotYetImplementedError();
    }

    let fullPath = yield this.getSimFileFullPath(remotePath);

    _logger.default.debug(`Attempting to read ${fullPath}`);

    let data = yield _appiumSupport.fs.readFile(fullPath, {
      encoding: 'base64'
    });
    return data;
  });

  return function (_x4) {
    return _ref4.apply(this, arguments);
  };
}();

commands.pullFolder = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (remotePath) {
    _logger.default.debug(`Pulling '${remotePath}' from sim`);

    if (this.isRealDevice()) {
      throw new _appiumBaseDriver.errors.NotYetImplementedError();
    }

    let fullPath = yield this.getSimFileFullPath(remotePath);

    _logger.default.debug(`Adding ${fullPath} to an in-memory zip archive`);

    let buffer = yield _appiumSupport.zip.toInMemoryZip(fullPath);

    _logger.default.debug("Converting in-memory zip file to base64 encoded string");

    let data = buffer.toString('base64');

    _logger.default.debug("Returning in-memory zip file as base54 encoded string");

    return data;
  });

  return function (_x5) {
    return _ref5.apply(this, arguments);
  };
}();

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJnZXRTaW1GaWxlRnVsbFBhdGgiLCJyZW1vdGVQYXRoIiwiYmFzZVBhdGgiLCJzaW0iLCJnZXREaXIiLCJhcHBOYW1lIiwib3B0cyIsImFwcCIsImFwcE5hbWVSZWdleCIsIlJlZ0V4cCIsInBhdGgiLCJzZXAiLCJhcHBOYW1lTWF0Y2hlcyIsImV4ZWMiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJpbmRleG9mIiwic2xpY2UiLCJpbmRleE9mIiwibG9nZ2VyIiwiZGVidWciLCJmaW5kUGF0aCIsInBsYXRmb3JtVmVyc2lvbiIsInJlc29sdmUiLCJyZXBsYWNlIiwic3Rkb3V0IiwiYXBwUm9vdCIsInN1YlBhdGgiLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJwdXNoRmlsZSIsImJhc2U2NERhdGEiLCJpc1JlYWxEZXZpY2UiLCJlcnJvcnMiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwiZnVsbFBhdGgiLCJmcyIsImV4aXN0cyIsInVubGluayIsImRpcm5hbWUiLCJjb250ZW50IiwiQnVmZmVyIiwiZnJvbSIsIndyaXRlRmlsZSIsInB1bGxGaWxlIiwiZGF0YSIsInJlYWRGaWxlIiwiZW5jb2RpbmciLCJwdWxsRm9sZGVyIiwiYnVmZmVyIiwiemlwIiwidG9Jbk1lbW9yeVppcCIsInRvU3RyaW5nIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFXQUQsT0FBTyxDQUFDRSxrQkFBUjtBQUFBLDZDQUE2QixXQUFnQkMsVUFBaEIsRUFBNEI7QUFDdkQsUUFBSUMsUUFBUSxHQUFHLEtBQUtDLEdB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QUwsQ0FBd0JDLFVBQXhCLENBQXJCOztBQUVBa0Isb0JBQU9DLEtBQVAsQ0FBYyxVQUFTZSxRQUFTLDhCQUFoQzs7QUFDQSxRQUFJYyxNQUFNLFNBQVNDLG1CQUFJQyxhQUFKLENBQWtCaEIsUUFBbEIsQ0FBbkI7O0FBRUFoQixvQkFBT0MsS0FBUCxDQUFhLHdEQUFiOztBQUNBLFFBQUl5QixJQUFJLEdBQUdJLE1BQU0sQ0FBQ0csUUFBUCxDQUFnQixRQUFoQixDQUFYOztBQUNBakMsb0JBQU9DLEtBQVAsQ0FBYSx1REFBYjs7QUFDQSxXQUFPeUIsSUFBUDtBQUNELEdBaEJEOztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQWtCQVEsTUFBTSxDQUFDQyxNQUFQLENBQWN2RCxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcywgc3lzdGVtLCBta2RpcnAsIHppcCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuLy8gVE9ETzogbW9yZSBleHBsaWNpdCBlcnJvciBtZXNzYWdlIGZvciBhbGwgdGhlIGZpbGUtbW92ZW1lbnQgY29tbWFuZHNcblxuLypcbiAqICBHZXQgdGhlIGZ1bGwgcGF0aCB0byBhbiBpT1Mgc2ltdWxhdG9yIGZpbGUuXG4gKiAgQ2FsbHMgY2IoZXJyLCBmdWxsRmlsZVBhdGgpXG4gKiAgL1NvbWUvUGF0aCAgICAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZXMgYSBmaWxlIHJlbGF0aXZlIHRvIHRoZSByb290IG9mIHRoZSBkZXZpY2UncyBmaWxlc3lzdGVtLlxuICogIC9BcHBsaWNhdGlvbnMvQXBwTmFtZS5hcHAvU29tZS9QYXRoICBmZXRjaGVzIGEgZmlsZSByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGF0IEFwcGxpY2F0aW9uJ3MgLmFwcCBkaXJlY3RvcnksIGFkZGluZyBpbiB0aGUgR1VJRC5cbiAqICBTbyBpdCBsb29rcyBzb21ldGhpbmcgbGlrZTogL0FwcGxpY2F0aW9ucy9HVUlELUdVSUQtR1VJRC1HVUlEL1NvbWUvUGF0aFxuICovXG5oZWxwZXJzLmdldFNpbUZpbGVGdWxsUGF0aCA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxldCBiYXNlUGF0aCA9IHRoaXMuc2ltLmdldERpcigpO1xuICBsZXQgYXBwTmFtZSA9IG51bGw7XG5cbiAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICBsZXQgYXBwTmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cChgXFxcXCR7cGF0aC5zZXB9KFtcXFxcdy1dK1xcXFwuYXBwKWApO1xuICAgIGxldCBhcHBOYW1lTWF0Y2hlcyA9IGFwcE5hbWVSZWdleC5leGVjKHRoaXMub3B0cy5hcHApO1xuICAgIGlmIChhcHBOYW1lTWF0Y2hlcykge1xuICAgICAgYXBwTmFtZSA9IGFwcE5hbWVNYXRjaGVzWzFdO1xuICAgIH1cbiAgfVxuICAvLyBkZS1hYnNvbHV0aXplIHRoZSBwYXRoXG4gIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleG9mKFwiOi8vXCIpID09PSAxKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSg0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZihcIi9cIikgPT09IDApIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDEpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZW1vdGVQYXRoLmluZGV4T2YoYXBwTmFtZSkgPT09IDApIHtcbiAgICBsb2dnZXIuZGVidWcoXCJXZSB3YW50IGFuIGFwcC1yZWxhdGl2ZSBmaWxlXCIpO1xuXG4gICAgbGV0IGZpbmRQYXRoID0gYmFzZVBhdGg7XG4gICAgaWYgKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gPj0gOCkge1xuICAgICAgLy8gdGhlIC5hcHAgZmlsZSBhcHBlYXJzIGluIC9Db250YWluZXJzL0RhdGEgYW5kIC9Db250YWluZXJzL0J1bmRsZSBib3RoLiBXZSBvbmx5IHdhbnQgL0J1bmRsZVxuICAgICAgZmluZFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIFwiQ29udGFpbmVyc1wiLCBcIkJ1bmRsZVwiKTtcbiAgICB9XG4gICAgZmluZFBhdGggPSBmaW5kUGF0aC5yZXBsYWNlKC9cXHMvZywgJ1xcXFwgJyk7XG5cbiAgICBsZXQgeyBzdGRvdXQgfSA9IGF3YWl0IGV4ZWMoJ2ZpbmQnLCBbZmluZFBhdGgsICctbmFtZScsIGFwcE5hbWVdKTtcbiAgICBsZXQgYXBwUm9vdCA9IHN0ZG91dC5yZXBsYWNlKC9cXG4kLywgJycpO1xuICAgIGxldCBzdWJQYXRoID0gcmVtb3RlUGF0aC5zdWJzdHJpbmcoYXBwTmFtZS5sZW5ndGggKyAxKTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGFwcFJvb3QsIHN1YlBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIldlIHdhbnQgYSBzaW0tcmVsYXRpdmUgZmlsZVwiKTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGJhc2VQYXRoLCByZW1vdGVQYXRoKTtcbiAgfVxufTtcblxuY29tbWFuZHMucHVzaEZpbGUgPSBhc3luYyBmdW5jdGlvbiAocmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBsb2dnZXIuZGVidWcoYFB1c2hpbmcgJHtyZW1vdGVQYXRofSB0byBpT1Mgc2ltdWxhdG9yYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJVbnN1cHBvcnRlZDogY2Fubm90IHdyaXRlIGZpbGVzIHRvIHBoeXNpY2FsIGRldmljZVwiKTtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byB3cml0ZSAke2Z1bGxQYXRofS4uLmApO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGZ1bGxQYXRoKSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgJHtmdWxsUGF0aH0gYWxyZWFkeSBleGlzdHMsIGRlbGV0aW5nLi4uYCk7XG4gICAgYXdhaXQgZnMudW5saW5rKGZ1bGxQYXRoKTtcbiAgfVxuICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSk7XG4gIGxldCBjb250ZW50ID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoZnVsbFBhdGgsIGNvbnRlbnQpO1xuICBsb2dnZXIuZGVidWcoYFdyb3RlICR7Y29udGVudC5sZW5ndGh9IGJ5dGVzIHRvICR7ZnVsbFBhdGh9YCk7XG59O1xuXG5jb21tYW5kcy5wdWxsRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAke3JlbW90ZVBhdGh9IGZyb20gc2ltYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEF0dGVtcHRpbmcgdG8gcmVhZCAke2Z1bGxQYXRofWApO1xuICBsZXQgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZ1bGxQYXRoLCB7ZW5jb2Rpbmc6ICdiYXNlNjQnfSk7XG4gIHJldHVybiBkYXRhO1xufTtcblxuY29tbWFuZHMucHVsbEZvbGRlciA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAnJHtyZW1vdGVQYXRofScgZnJvbSBzaW1gKTtcblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG5cbiAgbGV0IGZ1bGxQYXRoID0gYXdhaXQgdGhpcy5nZXRTaW1GaWxlRnVsbFBhdGgocmVtb3RlUGF0aCk7XG5cbiAgbG9nZ2VyLmRlYnVnKGBBZGRpbmcgJHtmdWxsUGF0aH0gdG8gYW4gaW4tbWVtb3J5IHppcCBhcmNoaXZlYCk7XG4gIGxldCBidWZmZXIgPSBhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChmdWxsUGF0aCk7XG5cbiAgbG9nZ2VyLmRlYnVnKFwiQ29udmVydGluZyBpbi1tZW1vcnkgemlwIGZpbGUgdG8gYmFzZTY0IGVuY29kZWQgc3RyaW5nXCIpO1xuICBsZXQgZGF0YSA9IGJ1ZmZlci50b1N0cmluZygnYmFzZTY0Jyk7XG4gIGxvZ2dlci5kZWJ1ZyhcIlJldHVybmluZyBpbi1tZW1vcnkgemlwIGZpbGUgYXMgYmFzZTU0IGVuY29kZWQgc3RyaW5nXCIpO1xuICByZXR1cm4gZGF0YTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
