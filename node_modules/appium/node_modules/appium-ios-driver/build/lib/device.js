"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.runSimulatorReset = runSimulatorReset;
exports.isolateSimulatorDevice = isolateSimulatorDevice;
exports.checkSimulatorAvailable = checkSimulatorAvailable;
exports.moveBuiltInApp = moveBuiltInApp;
exports.getAdjustedDeviceName = getAdjustedDeviceName;
exports.endSimulator = endSimulator;
exports.runRealDeviceReset = runRealDeviceReset;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _path = _interopRequireDefault(require("path"));

var utils = _interopRequireWildcard(require("./utils"));

var _logger = _interopRequireDefault(require("./logger"));

function checkSimulatorAvailable(_x, _x2, _x3) {
  return _checkSimulatorAvailable.apply(this, arguments);
}

function _checkSimulatorAvailable() {
  _checkSimulatorAvailable = (0, _asyncToGenerator2.default)(function* (opts, sdkVersion, availableDevices) {
    if (sdkVersion < 7.1) {
      _logger.default.debug('Instruments v < 7.1, not checking device string support');

      return;
    }

    _logger.default.debug('Checking whether our device string is supported');

    let dString = yield getAdjustedDeviceName(opts);

    let noDevicesError = function noDevicesError() {
      let msg = `Could not find a device to launch. You requested ` + `'${dString}', but the available devices were: ` + JSON.stringify(availableDevices);

      _logger.default.errorAndThrow(msg);
    };

    if (sdkVersion >= 8) {
      let sim = utils.getSimForDeviceString(dString, availableDevices);

      if (sim[0] === null || sim[1] === null) {
        noDevicesError();
      }

      _logger.default.debug(`iOS sim UDID is ${sim[1]}`);

      return sim[1];
    } else if (!_lodash.default.includes(availableDevices, dString)) {
      noDevicesError();
    }
  });
  return _checkSimulatorAvailable.apply(this, arguments);
}

function getAdjustedDeviceName(_x4) {
  return _getAdjustedDeviceName.apply(this, arguments);
}

function _getAdjustedDeviceName() {
  _getAdjustedDeviceName = (0, _asyncToGenerator2.default)(function* (opts) {
    opts._adjustedDeviceName = opts._adjustedDeviceName || (yield (0, _appiumIosSimulator.getDeviceString)(opts));
    return opts._adjustedDeviceName;
  });
  return _getAdjustedDeviceName.apply(this, arguments);
}

function moveBuiltInApp() {
  return _moveBuiltInApp.apply(this, arguments);
}

function _moveBuiltInApp() {
  _moveBuiltInApp = (0, _asyncToGenerator2.default)(function* () {});
  return _moveBuiltInApp.apply(this, arguments);
}

function runSimulatorReset(_x5, _x6, _x7) {
  return _runSimulatorReset.apply(this, arguments);
}

function _runSimulatorReset() {
  _runSimulatorReset = (0, _asyncToGenerator2.default)(function* (sim, opts, keepApp) {
    if (!opts.reset && !opts.fullReset) {
      _logger.default.debug('Reset not set, not ending sim');

      return;
    }

    _logger.default.debug('Running ios sim reset flow');

    yield endSimulator(sim);

    if (opts.fullReset) {
      _logger.default.debug('Full reset is on, so erasing simulator');

      yield fullResetSimulator(sim);
    } else if (opts.reset) {
      yield resetSimulator(sim, opts, keepApp);
    }
  });
  return _runSimulatorReset.apply(this, arguments);
}

function fullResetSimulator(_x8) {
  return _fullResetSimulator.apply(this, arguments);
}

function _fullResetSimulator() {
  _fullResetSimulator = (0, _asyncToGenerator2.default)(function* (sim) {
    _logger.default.debug('Cleaning the simulator');

    if (sim) {
      yield sim.clean();
    }
  });
  return _fullResetSimulator.apply(this, arguments);
}

function resetSimulator(_x9, _x10, _x11) {
  return _resetSimulator.apply(this, arguments);
}

function _resetSimulator() {
  _resetSimulator = (0, _asyncToGenerator2.default)(function* (sim, opts, keepApp) {
    if (!sim) return;

    _logger.default.debug('Cleaning sim state.');

    try {
      yield clearAppData(sim, opts, keepApp);
    } catch (err) {
      _logger.default.warn(err);

      _logger.default.warn("Could not reset simulator. Leaving as is.");
    }
  });
  return _resetSimulator.apply(this, arguments);
}

function endSimulator(_x12) {
  return _endSimulator.apply(this, arguments);
}

function _endSimulator() {
  _endSimulator = (0, _asyncToGenerator2.default)(function* (sim) {
    if (!sim) return;

    _logger.default.debug('Killing the simulator');

    yield sim.shutdown();
  });
  return _endSimulator.apply(this, arguments);
}

function isolateSimulatorDevice(_x13, _x14, _x15) {
  return _isolateSimulatorDevice.apply(this, arguments);
}

function _isolateSimulatorDevice() {
  _isolateSimulatorDevice = (0, _asyncToGenerator2.default)(function* (sim, opts, sdkVersion) {
    if (opts.isolateSimDevice && sdkVersion >= 8) {
      yield sim.isolateSim();
    }
  });
  return _isolateSimulatorDevice.apply(this, arguments);
}

function clearAppData(_x16, _x17, _x18) {
  return _clearAppData.apply(this, arguments);
}

function _clearAppData() {
  _clearAppData = (0, _asyncToGenerator2.default)(function* (sim, opts, keepApp) {
    if (!keepApp && opts.app && opts.bundleId) {
      yield sim.cleanCustomApp(_path.default.basename(opts.app), opts.bundleId);
    }
  });
  return _clearAppData.apply(this, arguments);
}

function resetRealDevice(_x19, _x20) {
  return _resetRealDevice.apply(this, arguments);
}

function _resetRealDevice() {
  _resetRealDevice = (0, _asyncToGenerator2.default)(function* (device, opts) {
    if (opts.bundleId && opts.fullReset) {
      let bundleId = opts.bundleId;

      _logger.default.debug(`Full reset requested. Will try to uninstall the app '${bundleId}'.`);

      if (!(yield device.isInstalled(bundleId))) {
        _logger.default.debug('App not installed. No need to uninstall');

        return;
      }

      try {
        yield device.remove(bundleId);
      } catch (err) {
        _logger.default.error(`Could not remove '${bundleId}' from device`);

        throw err;
      }

      _logger.default.debug(`Removed ${bundleId}`);
    }
  });
  return _resetRealDevice.apply(this, arguments);
}

function runRealDeviceReset(_x21, _x22) {
  return _runRealDeviceReset.apply(this, arguments);
}

function _runRealDeviceReset() {
  _runRealDeviceReset = (0, _asyncToGenerator2.default)(function* (device, opts) {
    if (opts.reset || opts.fullReset) {
      _logger.default.debug("Running ios real device reset flow");

      if (opts.reset) {
        yield resetRealDevice(device, opts);
      }
    } else {
      _logger.default.debug("Reset not set, continuing");
    }
  });
  return _runRealDeviceReset.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UuanMiXSwibmFtZXMiOlsiY2hlY2tTaW11bGF0b3JBdmFpbGFibGUiLCJvcHRzIiwic2RrVmVyc2lvbiIsImF2YWlsYWJsZURldmljZXMiLCJsb2dnZXIiLCJkZWJ1ZyIsImRTdHJpbmciLCJnZXRBZGp1c3RlZERldmljZU5hbWUiLCJub0RldmljZXNFcnJvciIsIm1zZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvckFuZFRocm93Iiwic2ltIiwidXRpbHMiLCJnZXRTaW1Gb3JEZXZpY2VTdHJpbmciLCJfIiwiaW5jbHVkZXMiLCJfYWRqdXN0ZWREZXZpY2VOYW1lIiwibW92ZUJ1aWx0SW5BcHAiLCJydW5TaW11bGF0b3JSZXNldCIsImtlZXBBcHAiLCJyZXNldCIsImZ1bGxSZXNldCIsImVuZFNpbXVsYXRvciIsImZ1bGxSZXNldFNpbXVsYXRvciIsInJlc2V0U2ltdWxhdG9yIiwiY2xlYW4iLCJjbGVhckFwcERhdGEiLCJlcnIiLCJ3YXJuIiwic2h1dGRvd24iLCJpc29sYXRlU2ltdWxhdG9yRGV2aWNlIiwiaXNvbGF0ZVNpbURldmljZSIsImlzb2xhdGVTaW0iLCJhcHAiLCJidW5kbGVJZCIsImNsZWFuQ3VzdG9tQXBwIiwicGF0aCIsImJhc2VuYW1lIiwicmVzZXRSZWFsRGV2aWNlIiwiZGV2aWNlIiwiaXNJbnN0YWxsZWQiLCJyZW1vdmUiLCJlcnJvciIsInJ1blJlYWxEZXZpY2VSZXNldCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztTQUdlQSx1Qjs7Ozs7NkRBQWYsV0FBd0NDLElBQXhDLEVBQThDQyxVQUE5QyxFQUEwREMsZ0JBQTFELEVBQTRFO0FBQzFFLFFBQUlELFVBQVUsR0FBRyxHQUFqQixFQUFzQjtBQUNwQkUsc0JBQU9DLEtBQVAsQ0FBYSx5REFBYjs7QUFDQTtBQUNEOztBQUVERCxvQkFBT0MsS0FBUCxDQUFhLGlEQUFiOztBQUVBLFFBQUlDLE9B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QUFQLENBQWMscUJBQW9CUixRQUFTLGVBQTNDOztBQUNBLGNBQU1QLEdBQU47QUFDRDs7QUFDRHpCLHNCQUFPQyxLQUFQLENBQWMsV0FBVStCLFFBQVMsRUFBakM7QUFDRDtBQUNGLEc7Ozs7U0FFY1Msa0I7Ozs7O3dEQUFmLFdBQW1DSixNQUFuQyxFQUEyQ3hDLElBQTNDLEVBQWlEO0FBQy9DLFFBQUlBLElBQUksQ0FBQ3FCLEtBQUwsSUFBY3JCLElBQUksQ0FBQ3NCLFNBQXZCLEVBQWtDO0FBQ2hDbkIsc0JBQU9DLEtBQVAsQ0FBYSxvQ0FBYjs7QUFDQSxVQUFJSixJQUFJLENBQUNxQixLQUFULEVBQWdCO0FBQ2QsY0FBTWtCLGVBQWUsQ0FBQ0MsTUFBRCxFQUFTeEMsSUFBVCxDQUFyQjtBQUNEO0FBQ0YsS0FMRCxNQUtPO0FBQ0xHLHNCQUFPQyxLQUFQLENBQWEsMkJBQWI7QUFDRDtBQUNGLEciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0RGV2aWNlU3RyaW5nIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2ltdWxhdG9yQXZhaWxhYmxlIChvcHRzLCBzZGtWZXJzaW9uLCBhdmFpbGFibGVEZXZpY2VzKSB7XG4gIGlmIChzZGtWZXJzaW9uIDwgNy4xKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdJbnN0cnVtZW50cyB2IDwgNy4xLCBub3QgY2hlY2tpbmcgZGV2aWNlIHN0cmluZyBzdXBwb3J0Jyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdDaGVja2luZyB3aGV0aGVyIG91ciBkZXZpY2Ugc3RyaW5nIGlzIHN1cHBvcnRlZCcpO1xuXG4gIGxldCBkU3RyaW5nID0gYXdhaXQgZ2V0QWRqdXN0ZWREZXZpY2VOYW1lKG9wdHMpO1xuICBsZXQgbm9EZXZpY2VzRXJyb3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IG1zZyA9IGBDb3VsZCBub3QgZmluZCBhIGRldmljZSB0byBsYXVuY2guIFlvdSByZXF1ZXN0ZWQgYCArXG4gICAgICAgICAgICAgIGAnJHtkU3RyaW5nfScsIGJ1dCB0aGUgYXZhaWxhYmxlIGRldmljZXMgd2VyZTogYCArXG4gICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGF2YWlsYWJsZURldmljZXMpO1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gIH07XG4gIGlmIChzZGtWZXJzaW9uID49IDgpIHtcbiAgICBsZXQgc2ltID0gdXRpbHMuZ2V0U2ltRm9yRGV2aWNlU3RyaW5nKGRTdHJpbmcsIGF2YWlsYWJsZURldmljZXMpO1xuICAgIGlmIChzaW1bMF0gPT09IG51bGwgfHwgc2ltWzFdID09PSBudWxsKSB7XG4gICAgICBub0RldmljZXNFcnJvcigpO1xuICAgIH1cbiAgICBsb2dnZXIuZGVidWcoYGlPUyBzaW0gVURJRCBpcyAke3NpbVsxXX1gKTtcbiAgICByZXR1cm4gc2ltWzFdO1xuICB9IGVsc2UgaWYgKCFfLmluY2x1ZGVzKGF2YWlsYWJsZURldmljZXMsIGRTdHJpbmcpKSB7XG4gICAgbm9EZXZpY2VzRXJyb3IoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBZGp1c3RlZERldmljZU5hbWUgKG9wdHMpIHtcbiAgb3B0cy5fYWRqdXN0ZWREZXZpY2VOYW1lID0gb3B0cy5fYWRqdXN0ZWREZXZpY2VOYW1lIHx8IGF3YWl0IGdldERldmljZVN0cmluZyhvcHRzKTtcbiAgcmV0dXJuIG9wdHMuX2FkanVzdGVkRGV2aWNlTmFtZTtcbn1cblxuLy8gVE9ETzogd2hhdCB0byBkbyB3aXRoIHRoaXM/XG5hc3luYyBmdW5jdGlvbiBtb3ZlQnVpbHRJbkFwcCAoLypzaW0qLykge1xuICAvLyBjYWxsIHNpbSBmdW5jdGlvbiBvbmNlIGl0IGlzIGluIHBsYWNlXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blNpbXVsYXRvclJlc2V0IChzaW0sIG9wdHMsIGtlZXBBcHApIHtcbiAgaWYgKCFvcHRzLnJlc2V0ICYmICFvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnUmVzZXQgbm90IHNldCwgbm90IGVuZGluZyBzaW0nKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1J1bm5pbmcgaW9zIHNpbSByZXNldCBmbG93Jyk7XG5cbiAgLy8gVGhlIHNpbXVsYXRvciBwcm9jZXNzIG11c3QgYmUgZW5kZWQgYmVmb3JlIHdlIGRlbGV0ZSBhcHBsaWNhdGlvbnMuXG4gIGF3YWl0IGVuZFNpbXVsYXRvcihzaW0pO1xuXG4gIGlmIChvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRnVsbCByZXNldCBpcyBvbiwgc28gZXJhc2luZyBzaW11bGF0b3InKTtcbiAgICBhd2FpdCBmdWxsUmVzZXRTaW11bGF0b3Ioc2ltKTtcbiAgfSBlbHNlIGlmIChvcHRzLnJlc2V0KSB7XG4gICAgYXdhaXQgcmVzZXRTaW11bGF0b3Ioc2ltLCBvcHRzLCBrZWVwQXBwKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBmdWxsUmVzZXRTaW11bGF0b3IgKHNpbSkge1xuICBsb2dnZXIuZGVidWcoJ0NsZWFuaW5nIHRoZSBzaW11bGF0b3InKTtcbiAgaWYgKHNpbSkge1xuICAgIGF3YWl0IHNpbS5jbGVhbigpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlc2V0U2ltdWxhdG9yIChzaW0sIG9wdHMsIGtlZXBBcHApIHtcbiAgaWYgKCFzaW0pIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gIGxvZ2dlci5kZWJ1ZygnQ2xlYW5pbmcgc2ltIHN0YXRlLicpO1xuICB0cnkge1xuICAgIGF3YWl0IGNsZWFyQXBwRGF0YShzaW0sIG9wdHMsIGtlZXBBcHApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIud2FybihlcnIpO1xuICAgIGxvZ2dlci53YXJuKFwiQ291bGQgbm90IHJlc2V0IHNpbXVsYXRvci4gTGVhdmluZyBhcyBpcy5cIik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZW5kU2ltdWxhdG9yIChzaW0pIHtcbiAgaWYgKCFzaW0pIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gIGxvZ2dlci5kZWJ1ZygnS2lsbGluZyB0aGUgc2ltdWxhdG9yJyk7XG4gIGF3YWl0IHNpbS5zaHV0ZG93bigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpc29sYXRlU2ltdWxhdG9yRGV2aWNlIChzaW0sIG9wdHMsIHNka1ZlcnNpb24pIHtcbiAgaWYgKG9wdHMuaXNvbGF0ZVNpbURldmljZSAmJiBzZGtWZXJzaW9uID49IDgpIHtcbiAgICBhd2FpdCBzaW0uaXNvbGF0ZVNpbSgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFyQXBwRGF0YSAoc2ltLCBvcHRzLCBrZWVwQXBwKSB7XG4gIGlmICgha2VlcEFwcCAmJiBvcHRzLmFwcCAmJiBvcHRzLmJ1bmRsZUlkKSB7XG4gICAgYXdhaXQgc2ltLmNsZWFuQ3VzdG9tQXBwKHBhdGguYmFzZW5hbWUob3B0cy5hcHApLCBvcHRzLmJ1bmRsZUlkKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiByZXNldFJlYWxEZXZpY2UgKGRldmljZSwgb3B0cykge1xuICBpZiAob3B0cy5idW5kbGVJZCAmJiBvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxldCBidW5kbGVJZCA9IG9wdHMuYnVuZGxlSWQ7XG4gICAgbG9nZ2VyLmRlYnVnKGBGdWxsIHJlc2V0IHJlcXVlc3RlZC4gV2lsbCB0cnkgdG8gdW5pbnN0YWxsIHRoZSBhcHAgJyR7YnVuZGxlSWR9Jy5gKTtcbiAgICBpZiAoIWF3YWl0IGRldmljZS5pc0luc3RhbGxlZChidW5kbGVJZCkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnQXBwIG5vdCBpbnN0YWxsZWQuIE5vIG5lZWQgdG8gdW5pbnN0YWxsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBkZXZpY2UucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgQ291bGQgbm90IHJlbW92ZSAnJHtidW5kbGVJZH0nIGZyb20gZGV2aWNlYCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGxvZ2dlci5kZWJ1ZyhgUmVtb3ZlZCAke2J1bmRsZUlkfWApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blJlYWxEZXZpY2VSZXNldCAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLnJlc2V0IHx8IG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiUnVubmluZyBpb3MgcmVhbCBkZXZpY2UgcmVzZXQgZmxvd1wiKTtcbiAgICBpZiAob3B0cy5yZXNldCkge1xuICAgICAgYXdhaXQgcmVzZXRSZWFsRGV2aWNlKGRldmljZSwgb3B0cyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlJlc2V0IG5vdCBzZXQsIGNvbnRpbnVpbmdcIik7XG4gIH1cbn1cblxuXG5leHBvcnQge1xuICBydW5TaW11bGF0b3JSZXNldCwgaXNvbGF0ZVNpbXVsYXRvckRldmljZSwgY2hlY2tTaW11bGF0b3JBdmFpbGFibGUsXG4gIG1vdmVCdWlsdEluQXBwLCBnZXRBZGp1c3RlZERldmljZU5hbWUsIGVuZFNpbXVsYXRvciwgcnVuUmVhbERldmljZVJlc2V0LFxufTtcbiJdLCJmaWxlIjoibGliL2RldmljZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
