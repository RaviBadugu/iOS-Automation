"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.setupNewChromedriver = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumChromedriver = _interopRequireDefault(require("appium-chromedriver"));

var _portfinder = _interopRequireDefault(require("portfinder"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

var _webviewHelpers = _interopRequireWildcard(require("../webview-helpers"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.getCurrentContext = async function () {
  return this.curContext || this.defaultContextName();
};

commands.getContexts = async function () {
  let webviews;

  if (this.isChromeSession) {
    webviews = [_webviewHelpers.CHROMIUM_WIN];
  } else {
    webviews = await _webviewHelpers.default.getWebviews(this.adb, this.opts.androidDeviceSocket);
  }

  this.contexts = _lodash.default.union([_webviewHelpers.NATIVE_WIN], webviews);

  _logger.default.debug(`Available contexts: ${JSON.stringify(this.contexts)}`);

  return this.contexts;
};

commands.setContext = async function (name) {
  if (name === null) {
    name = this.defaultContextName();
  } else if (name === _webviewHelpers.WEBVIEW_WIN) {
    name = this.defaultWebviewName();
  }

  let contexts = await this.getContexts();

  if (!_lodash.default.includes(contexts, name)) {
    throw new _appiumBaseDriver.errors.NoSuchContextError();
  }

  if (name === this.curContext) {
    return;
  }

  await this.switchContext(name);
  this.curContext = name;
};

helpers.switchContext = async function (name) {
  if (this.isChromedriverContext(name)) {
    await this.startChromedriverProxy(name);
  } else if (this.isChromedriverContext(this.curContext)) {
    if (this.opts.recreateChromeDriverSessions) {
      _logger.default.debug("recreateChromeDriverSessions set to true; killing existing chromedrivers");

      await this.stopChromedriverProxies();
    } else {
      await this.suspendChromedriverProxy();
    }
  } else {
    throw new Error(`Didn't know how to handle switching to context '${name}'`);
  }
};

helpers.defaultContextName = function () {
  return _webviewHelpers.NATIVE_WIN;
};

helpers.defaultWebviewName = function () {
  return _webviewHelpers.WEBVIEW_BASE + this.opts.appPackage;
};

helpers.isWebContext = function () {
  return this.curContext !== null && this.curContext !== _webviewHelpers.NATIVE_WIN;
};

helpers.startChromedriverProxy = async function (context) {
  _logger.default.debug(`Connecting to chrome-backed webview context '${context}'`);

  let cd;

  if (this.sessionChromedrivers[context]) {
    _logger.default.debug(`Found existing Chromedriver for context '${context}'. Using it.`);

    cd = this.sessionChromedrivers[context];
    await setupExistingChromedriver(cd);
  } else {
    let opts = _lodash.default.cloneDeep(this.opts);

    opts.chromeUseRunningApp = true;

    if (opts.extractChromeAndroidPackageFromContextName) {
      let androidPackage = context.match(`${_webviewHelpers.WEBVIEW_BASE}(.+)`);

      if (androidPackage && androidPackage.length > 0) {
        opts.chromeAndroidPackage = androidPackage[1];
      }
    }

    cd = await this.setupNewChromedriver(opts, this.adb.curDeviceId, this.adb);
    cd.on(_appiumChromedriver.default.EVENT_CHANGED, msg => {
      if (msg.state === _appiumChromedriver.default.STATE_STOPPED) {
        this.onChromedriverStop(context);
      }
    });
    this.sessionChromedrivers[context] = cd;
  }

  this.chromedriver = cd;
  this.proxyReqRes = this.chromedriver.proxyReq.bind(this.chromedriver);
  this.jwpProxyActive = true;
};

helpers.suspendChromedriverProxy = function () {
  this.chromedriver = null;
  this.proxyReqRes = null;
  this.jwpProxyActive = false;
};

helpers.onChromedriverStop = async function (context) {
  _logger.default.warn(`Chromedriver for context ${context} stopped unexpectedly`);

  if (context === this.curContext) {
    let err = new Error("Chromedriver quit unexpectedly during session");
    await this.startUnexpectedShutdown(err);
  } else {
    _logger.default.warn("Chromedriver quit unexpectedly, but it wasn't the active " + "context, ignoring");

    delete this.sessionChromedrivers[context];
  }
};

helpers.stopChromedriverProxies = async function () {
  this.suspendChromedriverProxy();

  for (let context of _lodash.default.keys(this.sessionChromedrivers)) {
    let cd = this.sessionChromedrivers[context];

    _logger.default.debug(`Stopping chromedriver for context ${context}`);

    cd.removeAllListeners(_appiumChromedriver.default.EVENT_CHANGED);

    try {
      await cd.stop();
    } catch (err) {
      _logger.default.warn(`Error stopping Chromedriver: ${err.message}`);
    }

    delete this.sessionChromedrivers[context];
  }
};

helpers.isChromedriverContext = function (viewName) {
  return _lodash.default.includes(viewName, _webviewHelpers.WEBVIEW_WIN) || viewName === _webviewHelpers.CHROMIUM_WIN;
};

helpers.shouldDismissChromeWelcome = function shouldDismissChromeWelcome() {
  return !!this.opts.chromeOptions && _lodash.default.isArray(this.opts.chromeOptions.args) && this.opts.chromeOptions.args.includes('--no-first-run');
};

helpers.dismissChromeWelcome = async function dismissChromeWelcome() {
  _logger.default.info("Trying to dismiss Chrome welcome");

  let activity = await this.getCurrentActivity();

  if (activity !== "org.chromium.chrome.browser.firstrun.FirstRunActivity") {
    _logger.default.info("Chrome welcome dialog never showed up! Continuing");

    return;
  }

  let el = await this.findElOrEls('id', 'com.android.chrome:id/terms_accept', false);
  await this.click(el.ELEMENT);

  try {
    let el = await this.findElOrEls('id', 'com.android.chrome:id/negative_button', false);
    await this.click(el.ELEMENT);
  } catch (e) {
    _logger.default.warn(`This device did not show Chrome SignIn dialog, ${e.message}`);
  }
};

helpers.startChromeSession = async function startChromeSession() {
  _logger.default.info("Starting a chrome-based browser session");

  let opts = _lodash.default.cloneDeep(this.opts);

  opts.chromeUseRunningApp = false;
  const knownPackages = ['org.chromium.chrome.shell', 'com.android.chrome', 'com.chrome.beta', 'org.chromium.chrome', 'org.chromium.webview_shell'];

  if (_lodash.default.includes(knownPackages, this.opts.appPackage)) {
    opts.chromeBundleId = this.opts.appPackage;
  } else {
    opts.chromeAndroidActivity = this.opts.appActivity;
  }

  this.chromedriver = await this.setupNewChromedriver(opts, this.adb.curDeviceId, this.adb);
  this.chromedriver.on(_appiumChromedriver.default.EVENT_CHANGED, msg => {
    if (msg.state === _appiumChromedriver.default.STATE_STOPPED) {
      this.onChromedriverStop(_webviewHelpers.CHROMIUM_WIN);
    }
  });
  this.curContext = _webviewHelpers.CHROMIUM_WIN;
  this.sessionChromedrivers[_webviewHelpers.CHROMIUM_WIN] = this.chromedriver;
  this.proxyReqRes = this.chromedriver.proxyReq.bind(this.chromedriver);
  this.jwpProxyActive = true;

  if (this.shouldDismissChromeWelcome()) {
    await this.dismissChromeWelcome();
  }
};

async function setupExistingChromedriver(chromedriver) {
  if (!(await chromedriver.hasWorkingWebview())) {
    _logger.default.debug("ChromeDriver is not associated with a window. " + "Re-initializing the session.");

    await chromedriver.restart();
  }

  return chromedriver;
}

helpers.setupNewChromedriver = async function setupNewChromedriver(opts, curDeviceId, adb) {
  if (!opts.chromeDriverPort) {
    const getPort = _bluebird.default.promisify(_portfinder.default.getPort, {
      context: _portfinder.default
    });

    opts.chromeDriverPort = await getPort();

    _logger.default.debug(`A port was not given, using random port: ${opts.chromeDriverPort}`);
  }

  const chromedriver = new _appiumChromedriver.default({
    port: opts.chromeDriverPort,
    executable: opts.chromedriverExecutable,
    adb,
    verbose: !!opts.showChromedriverLog,
    executableDir: opts.chromedriverExecutableDir,
    mappingPath: opts.chromedriverChromeMappingFile,
    bundleId: opts.chromeBundleId,
    useSystemExecutable: opts.chromedriverUseSystemExecutable
  });
  opts.chromeOptions = opts.chromeOptions || {};

  for (const opt of _lodash.default.keys(opts)) {
    if (opt.endsWith(':chromeOptions')) {
      _logger.default.warn(`Merging '${opt}' into 'chromeOptions'. This may cause unexpected behavior`);

      _lodash.default.merge(opts.chromeOptions, opts[opt]);
    }
  }

  let caps = {
    chromeOptions: {
      androidPackage: opts.chromeOptions.androidPackage || opts.appPackage
    }
  };

  if (opts.chromeUseRunningApp) {
    caps.chromeOptions.androidUseRunningApp = opts.chromeUseRunningApp;
  }

  if (opts.chromeAndroidPackage) {
    caps.chromeOptions.androidPackage = opts.chromeAndroidPackage;
  }

  if (opts.chromeAndroidActivity) {
    caps.chromeOptions.androidActivity = opts.chromeAndroidActivity;
  }

  if (opts.chromeAndroidProcess) {
    caps.chromeOptions.androidProcess = opts.chromeAndroidProcess;
  }

  if (opts.loggingPrefs) {
    caps.loggingPrefs = opts.loggingPrefs;
  }

  if (opts.enablePerformanceLogging) {
    _logger.default.warn(`The 'enablePerformanceLogging' cap is deprecated; simply use ` + `the 'loggingPrefs' cap instead, with a 'performance' key set to 'ALL'`);

    const newPref = {
      performance: 'ALL'
    };
    caps.loggingPrefs = caps.loggingPrefs ? Object.assign({}, caps.loggingPrefs, newPref) : newPref;
  }

  if (opts.browserName === 'chromium-webview') {
    caps.chromeOptions.androidActivity = opts.appActivity;
  }

  if (opts.pageLoadStrategy) {
    caps.pageLoadStrategy = opts.pageLoadStrategy;
  }

  caps = _webviewHelpers.default.decorateChromeOptions(caps, opts, curDeviceId);
  await chromedriver.start(caps);
  return chromedriver;
};

const setupNewChromedriver = helpers.setupNewChromedriver;
exports.setupNewChromedriver = setupNewChromedriver;
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJnZXRDdXJyZW50Q29udGV4dCIsImN1ckNvbnRleHQiLCJkZWZhdWx0Q29udGV4dE5hbWUiLCJnZXRDb250ZXh0cyIsIndlYnZpZXdzIiwiaXNDaHJvbWVTZXNzaW9uIiwiQ0hST01JVU1fV0lOIiwid2Vidmlld0hlbHBlcnMiLCJnZXRXZWJ2aWV3cyIsImFkYiIsIm9wdHMiLCJhbmRyb2lkRGV2aWNlU29ja2V0IiwiY29udGV4dHMiLCJfIiwidW5pb24iLCJOQVRJVkVfV0lOIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0Q29udGV4dCIsIm5hbWUiLCJXRUJWSUVXX1dJTiIsImRlZmF1bHRXZWJ2aWV3TmFtZSIsImluY2x1ZGVzIiwiZXJyb3JzIiwiTm9TdWNoQ29udGV4dEVycm9yIiwic3dpdGNoQ29udGV4dCIsImlzQ2hyb21lZHJpdmVyQ29udGV4dCIsInN0YXJ0Q2hyb21lZHJpdmVyUHJveHkiLCJyZWNyZWF0ZUNocm9tZURyaXZlclNlc3Npb25zIiwic3RvcENocm9tZWRyaXZlclByb3hpZXMiLCJzdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkiLCJFcnJvciIsIldFQlZJRVdfQkFTRSIsImFwcFBhY2thZ2UiLCJpc1dlYkNvbnRleHQiLCJjb250ZXh0IiwiY2QiLCJzZXNzaW9uQ2hyb21lZHJpdmVycyIsInNldHVwRXhpc3RpbmdDaHJvbWVkcml2ZXIiLCJjbG9uZURlZXAiLCJjaHJvbWVVc2VSdW5uaW5nQXBwIiwiZXh0cmFjdENocm9tZUFuZHJvaWRQYWNrYWdlRnJvbUNvbnRleHROYW1lIiwiYW5kcm9pZFBhY2thZ2UiLCJtYXRjaCIsImxlbmd0aCIsImNocm9tZUFuZHJvaWRQYWNrYWdlIiwic2V0dXBOZXdDaHJvbWVkcml2ZXIiLCJjdXJEZXZpY2VJZCIsIm9uIiwiQ2hyb21lZHJpdmVyIiwiRVZFTlRfQ0hBTkdFRCIsIm1zZyIsInN0YXRlIiwiU1RBVEVfU1RPUFBFRCIsIm9uQ2hyb21lZHJpdmVyU3RvcCIsImNocm9tZWRyaXZlciIsInByb3h5UmVxUmVzIiwicHJveHlSZXEiLCJiaW5kIiwiandwUHJveHlBY3RpdmUiLCJ3YXJuIiwiZXJyIiwic3RhcnRVbmV4cGVjdGVkU2h1dGRvd24iLCJrZXlzIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwic3RvcCIsIm1lc3NhZ2UiLCJ2aWV3TmFtZSIsInNob3VsZERpc21pc3NDaHJvbWVXZWxjb21lIiwiY2hyb21lT3B0aW9ucyIsImlzQXJyYXkiLCJhcmdzIiwiZGlzbWlzc0Nocm9tZVdlbGNvbWUiLCJpbmZvIiwiYWN0aXZpdHkiLCJnZXRDdXJyZW50QWN0aXZpdHkiLCJlbCIsImZpbmRFbE9yRWxzIiwiY2xpY2siLCJFTEVNRU5UIiwiZSIsInN0YXJ0Q2hyb21lU2Vzc2lvbiIsImtub3duUGFja2FnZXMiLCJjaHJvbWVCdW5kbGVJZCIsImNocm9tZUFuZHJvaWRBY3Rpdml0eSIsImFwcEFjdGl2aXR5IiwiaGFzV29ya2luZ1dlYnZpZXciLCJyZXN0YXJ0IiwiY2hyb21lRHJpdmVyUG9ydCIsImdldFBvcnQiLCJCIiwicHJvbWlzaWZ5IiwiUG9ydEZpbmRlciIsInBvcnQiLCJleGVjdXRhYmxlIiwiY2hyb21lZHJpdmVyRXhlY3V0YWJsZSIsInZlcmJvc2UiLCJzaG93Q2hyb21lZHJpdmVyTG9nIiwiZXhlY3V0YWJsZURpciIsImNocm9tZWRyaXZlckV4ZWN1dGFibGVEaXIiLCJtYXBwaW5nUGF0aCIsImNocm9tZWRyaXZlckNocm9tZU1hcHBpbmdGaWxlIiwiYnVuZGxlSWQiLCJ1c2VTeXN0ZW1FeGVjdXRhYmxlIiwiY2hyb21lZHJpdmVyVXNlU3lzdGVtRXhlY3V0YWJsZSIsIm9wdCIsImVuZHNXaXRoIiwibWVyZ2UiLCJjYXBzIiwiYW5kcm9pZFVzZVJ1bm5pbmdBcHAiLCJhbmRyb2lkQWN0aXZpdHkiLCJjaHJvbWVBbmRyb2lkUHJvY2VzcyIsImFuZHJvaWRQcm9jZXNzIiwibG9nZ2luZ1ByZWZzIiwiZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nIiwibmV3UHJlZiIsInBlcmZvcm1hbmNlIiwiT2JqZWN0IiwiYXNzaWduIiwiYnJvd3Nlck5hbWUiLCJwYWdlTG9hZFN0cmF0ZWd5IiwiZGVjb3JhdGVDaHJvbWVPcHRpb25zIiwic3RhcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBTUFGLFFBQVEsQ0FBQ0csaUJBQVQsR0FBNkIsa0JBQWtCO0FBRzdDLFNBQU8sS0FBS0MsVUFBTCxJQUFtQixLQUFLQyxrQkFBTCxFQUExQjtBQUNELENBSkQ7O0FBTUFMLFFBQVEsQ0FBQ00sV0FBVCxHQUF1QixrQkFBa0I7QUFDdkMsTUFBSUMsUUFBSjs7QUFDQSxNQUFJLEtBQUtDLGVBQVQsRUFBMEI7QUFHeEJELElBQUFBLFFBQVEsR0FBRyxDQUFDRSw0QkFBRCxDQUFYO0FBQ0QsR0FKRCxNQUlPO0FBRUxGLElBQUFBLFFBQVEsR0FBRyxNQUFNRyx3QkFBZUMsV0FBZixDQUEyQixLQUFLQyxHQUFoQyxFQUNmLEtBQUtDLElBQUwsQ0FBVUMsbUJBREssQ0FBakI7QUFFRDs7QUFDRCxPQUFLQyxRQUFMLEdBQWdCQyxnQkFBRUMsS0FBRixDQUFRLENBQUNDLDBCQUFELENBQVIsRUFBc0JYLFFBQXRCLENBQWhCOztBQUNBWSxrQkFBSUMsS0FBSixDQUFXLHVCQUFzQkMsSUFBSSxDQUFDQyxTQUFMLENBQWUsS0FBS1AsUUFBcEIsQ0FBOEIsRUFBL0Q7O0FBQ0EsU0FBTyxLQUFLQSxRQUFaO0FBQ0QsQ0FkRDs7QUFnQkFmLFFBQVEsQ0FBQ3VCLFVBQVQsR0FBc0IsZ0JBQWdCQyxJQUFoQixFQUFzQjtBQUMxQyxNQUFJQSxJQUFJLEtBQUss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QUosQ0FBVSwrREFBRCxHQUNDLHVFQURWOztBQUVBLFVBQU11RCxPQUFPLEdBQUc7QUFBQ0MsTUFBQUEsV0FBVyxFQUFFO0FBQWQsS0FBaEI7QUFHQVIsSUFBQUEsSUFBSSxDQUFDSyxZQUFMLEdBQW9CTCxJQUFJLENBQUNLLFlBQUwsR0FDbEJJLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JWLElBQUksQ0FBQ0ssWUFBdkIsRUFBcUNFLE9BQXJDLENBRGtCLEdBRWxCQSxPQUZGO0FBR0Q7O0FBQ0QsTUFBSTNHLElBQUksQ0FBQytHLFdBQUwsS0FBcUIsa0JBQXpCLEVBQTZDO0FBQzNDWCxJQUFBQSxJQUFJLENBQUN2QyxhQUFMLENBQW1CeUMsZUFBbkIsR0FBcUN0RyxJQUFJLENBQUM2RSxXQUExQztBQUNEOztBQUNELE1BQUk3RSxJQUFJLENBQUNnSCxnQkFBVCxFQUEyQjtBQUN6QlosSUFBQUEsSUFBSSxDQUFDWSxnQkFBTCxHQUF3QmhILElBQUksQ0FBQ2dILGdCQUE3QjtBQUNEOztBQUNEWixFQUFBQSxJQUFJLEdBQUd2Ryx3QkFBZW9ILHFCQUFmLENBQXFDYixJQUFyQyxFQUEyQ3BHLElBQTNDLEVBQWlEdUMsV0FBakQsQ0FBUDtBQUNBLFFBQU1RLFlBQVksQ0FBQ21FLEtBQWIsQ0FBbUJkLElBQW5CLENBQU47QUFDQSxTQUFPckQsWUFBUDtBQUNELENBckVEOztBQXNFQSxNQUFNVCxvQkFBb0IsR0FBR2xELE9BQU8sQ0FBQ2tELG9CQUFyQzs7QUFFQXVFLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjekgsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IENocm9tZWRyaXZlciBmcm9tICdhcHBpdW0tY2hyb21lZHJpdmVyJztcbmltcG9ydCBQb3J0RmluZGVyIGZyb20gJ3BvcnRmaW5kZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGRlZmF1bHQgYXMgd2Vidmlld0hlbHBlcnMsXG4gICAgICAgICBOQVRJVkVfV0lOLCBXRUJWSUVXX0JBU0UsIFdFQlZJRVdfV0lOLCBDSFJPTUlVTV9XSU4gfSBmcm9tICcuLi93ZWJ2aWV3LWhlbHBlcnMnO1xuXG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuXG4vKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gKiBBY3R1YWwgTUpTT05XUCBjb21tYW5kIGhhbmRsZXJzXG4gKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5jb21tYW5kcy5nZXRDdXJyZW50Q29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIC8vIGlmIHRoZSBjdXJyZW50IGNvbnRleHQgaXMgYG51bGxgLCBpbmRpY2F0aW5nIG5vIGNvbnRleHRcbiAgLy8gZXhwbGljaXRseSBzZXQsIGl0IGlzIHRoZSBkZWZhdWx0IGNvbnRleHRcbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dCB8fCB0aGlzLmRlZmF1bHRDb250ZXh0TmFtZSgpO1xufTtcblxuY29tbWFuZHMuZ2V0Q29udGV4dHMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCB3ZWJ2aWV3cztcbiAgaWYgKHRoaXMuaXNDaHJvbWVTZXNzaW9uKSB7XG4gICAgLy8gaWYgd2UgaGF2ZSBhIENocm9tZSBicm93c2VyIHNlc3Npb24sIHdlIG9ubHkgY2FyZSBhYm91dCB0aGUgQ2hyb21lXG4gICAgLy8gY29udGV4dCBhbmQgdGhlIG5hdGl2ZSBjb250ZXh0XG4gICAgd2Vidmlld3MgPSBbQ0hST01JVU1fV0lOXTtcbiAgfSBlbHNlIHtcbiAgICAvLyBvdGhlcndpc2Ugd2UgdXNlIEFEQiB0byBmaWd1cmUgb3V0IHdoaWNoIHdlYnZpZXdzIGFyZSBhdmFpbGFibGVcbiAgICB3ZWJ2aWV3cyA9IGF3YWl0IHdlYnZpZXdIZWxwZXJzLmdldFdlYnZpZXdzKHRoaXMuYWRiLFxuICAgICAgdGhpcy5vcHRzLmFuZHJvaWREZXZpY2VTb2NrZXQpO1xuICB9XG4gIHRoaXMuY29udGV4dHMgPSBfLnVuaW9uKFtOQVRJVkVfV0lOXSwgd2Vidmlld3MpO1xuICBsb2cuZGVidWcoYEF2YWlsYWJsZSBjb250ZXh0czogJHtKU09OLnN0cmluZ2lmeSh0aGlzLmNvbnRleHRzKX1gKTtcbiAgcmV0dXJuIHRoaXMuY29udGV4dHM7XG59O1xuXG5jb21tYW5kcy5zZXRDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUpIHtcbiAgaWYgKG5hbWUgPT09IG51bGwpIHtcbiAgICBuYW1lID0gdGhpcy5kZWZhdWx0Q29udGV4dE5hbWUoKTtcbiAgfSBlbHNlIGlmIChuYW1lID09PSBXRUJWSUVXX1dJTikge1xuICAgIC8vIGhhbmRsZSBzZXRDb250ZXh0IFwiV0VCVklFV1wiXG4gICAgbmFtZSA9IHRoaXMuZGVmYXVsdFdlYnZpZXdOYW1lKCk7XG4gIH1cbiAgbGV0IGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0cygpO1xuICAvLyBpZiB0aGUgY29udGV4dCB3ZSB3YW50IGRvZXNuJ3QgZXhpc3QsIGZhaWxcbiAgaWYgKCFfLmluY2x1ZGVzKGNvbnRleHRzLCBuYW1lKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoQ29udGV4dEVycm9yKCk7XG4gIH1cbiAgLy8gaWYgd2UncmUgYWxyZWFkeSBpbiB0aGUgY29udGV4dCB3ZSB3YW50LCBkbyBub3RoaW5nXG4gIGlmIChuYW1lID09PSB0aGlzLmN1ckNvbnRleHQpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBhd2FpdCB0aGlzLnN3aXRjaENvbnRleHQobmFtZSk7XG4gIHRoaXMuY3VyQ29udGV4dCA9IG5hbWU7XG59O1xuXG5oZWxwZXJzLnN3aXRjaENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAobmFtZSkge1xuICAvLyBXZSBoYXZlIHNvbWUgb3B0aW9ucyB3aGVuIGl0IGNvbWVzIHRvIHdlYnZpZXdzLiBJZiB3ZSB3YW50IGFcbiAgLy8gQ2hyb21lZHJpdmVyIHdlYnZpZXcsIHdlIGNhbiBvbmx5IGNvbnRyb2wgb25lIGF0IGEgdGltZS5cbiAgaWYgKHRoaXMuaXNDaHJvbWVkcml2ZXJDb250ZXh0KG5hbWUpKSB7XG4gICAgLy8gc3RhcnQgcHJveHlpbmcgY29tbWFuZHMgZGlyZWN0bHkgdG8gY2hyb21lZHJpdmVyXG4gICAgYXdhaXQgdGhpcy5zdGFydENocm9tZWRyaXZlclByb3h5KG5hbWUpO1xuICB9IGVsc2UgaWYgKHRoaXMuaXNDaHJvbWVkcml2ZXJDb250ZXh0KHRoaXMuY3VyQ29udGV4dCkpIHtcbiAgICAvLyBpZiB3ZSdyZSBtb3ZpbmcgdG8gYSBub24tY2hyb21lZHJpdmVyIHdlYnZpZXcsIGFuZCBvdXIgY3VycmVudCBjb250ZXh0XG4gICAgLy8gX2lzXyBhIGNocm9tZWRyaXZlciB3ZWJ2aWV3LCBpZiBjYXBzIHJlY3JlYXRlQ2hyb21lRHJpdmVyU2Vzc2lvbnMgaXMgc2V0XG4gICAgLy8gdG8gdHJ1ZSB0aGVuIGtpbGwgY2hyb21lZHJpdmVyIHNlc3Npb24gdXNpbmcgc3RvcENocm9tZWRyaXZlclByb3hpZXMgb3JcbiAgICAvLyBlbHNlIHNpbXBseSBzdXNwZW5kIHByb3h5aW5nIHRvIHRoZSBsYXR0ZXJcbiAgICBpZiAodGhpcy5vcHRzLnJlY3JlYXRlQ2hyb21lRHJpdmVyU2Vzc2lvbnMpIHtcbiAgICAgIGxvZy5kZWJ1ZyhcInJlY3JlYXRlQ2hyb21lRHJpdmVyU2Vzc2lvbnMgc2V0IHRvIHRydWU7IGtpbGxpbmcgZXhpc3RpbmcgY2hyb21lZHJpdmVyc1wiKTtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcENocm9tZWRyaXZlclByb3hpZXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5zdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkoKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBEaWRuJ3Qga25vdyBob3cgdG8gaGFuZGxlIHN3aXRjaGluZyB0byBjb250ZXh0ICcke25hbWV9J2ApO1xuICB9XG59O1xuXG5cbi8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogT24tb2JqZWN0IGNvbnRleHQtcmVsYXRlZCBoZWxwZXJzXG4gKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi9cblxuLy8gVGhlIHJlYXNvbiB0aGlzIGlzIGEgZnVuY3Rpb24gYW5kIG5vdCBqdXN0IGEgY29uc3RhbnQgaXMgdGhhdCBib3RoIGFuZHJvaWQtXG4vLyBkcml2ZXIgYW5kIHNlbGVuZHJvaWQtZHJpdmVyIHVzZSB0aGlzIGxvZ2ljLCBhbmQgZWFjaCBvbmUgcmV0dXJuc1xuLy8gYSBkaWZmZXJlbnQgZGVmYXVsdCBjb250ZXh0IG5hbWVcbmhlbHBlcnMuZGVmYXVsdENvbnRleHROYW1lID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gTkFUSVZFX1dJTjtcbn07XG5cbmhlbHBlcnMuZGVmYXVsdFdlYnZpZXdOYW1lID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gV0VCVklFV19CQVNFICsgdGhpcy5vcHRzLmFwcFBhY2thZ2U7XG59O1xuXG5oZWxwZXJzLmlzV2ViQ29udGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dCAhPT0gbnVsbCAmJiB0aGlzLmN1ckNvbnRleHQgIT09IE5BVElWRV9XSU47XG59O1xuXG4vLyBUdXJuIG9uIHByb3h5aW5nIHRvIGFuIGV4aXN0aW5nIENocm9tZWRyaXZlciBzZXNzaW9uIG9yIGEgbmV3IG9uZVxuaGVscGVycy5zdGFydENocm9tZWRyaXZlclByb3h5ID0gYXN5bmMgZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgbG9nLmRlYnVnKGBDb25uZWN0aW5nIHRvIGNocm9tZS1iYWNrZWQgd2VidmlldyBjb250ZXh0ICcke2NvbnRleHR9J2ApO1xuXG4gIGxldCBjZDtcbiAgaWYgKHRoaXMuc2Vzc2lvbkNocm9tZWRyaXZlcnNbY29udGV4dF0pIHtcbiAgICAvLyBpbiB0aGUgY2FzZSB3aGVyZSB3ZSd2ZSBhbHJlYWR5IHNldCB1cCBhIGNocm9tZWRyaXZlciBmb3IgYSBjb250ZXh0LFxuICAgIC8vIHdlIHdhbnQgdG8gcmVjb25uZWN0IHRvIGl0LCBub3QgY3JlYXRlIGEgd2hvbGUgbmV3IG9uZVxuICAgIGxvZy5kZWJ1ZyhgRm91bmQgZXhpc3RpbmcgQ2hyb21lZHJpdmVyIGZvciBjb250ZXh0ICcke2NvbnRleHR9Jy4gVXNpbmcgaXQuYCk7XG4gICAgY2QgPSB0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzW2NvbnRleHRdO1xuICAgIGF3YWl0IHNldHVwRXhpc3RpbmdDaHJvbWVkcml2ZXIoY2QpO1xuICB9IGVsc2Uge1xuICAgIGxldCBvcHRzID0gXy5jbG9uZURlZXAodGhpcy5vcHRzKTtcbiAgICBvcHRzLmNocm9tZVVzZVJ1bm5pbmdBcHAgPSB0cnVlO1xuICAgIGlmIChvcHRzLmV4dHJhY3RDaHJvbWVBbmRyb2lkUGFja2FnZUZyb21Db250ZXh0TmFtZSkge1xuICAgICAgbGV0IGFuZHJvaWRQYWNrYWdlID0gY29udGV4dC5tYXRjaChgJHtXRUJWSUVXX0JBU0V9KC4rKWApO1xuICAgICAgaWYgKGFuZHJvaWRQYWNrYWdlICYmIGFuZHJvaWRQYWNrYWdlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgb3B0cy5jaHJvbWVBbmRyb2lkUGFja2FnZSA9IGFuZHJvaWRQYWNrYWdlWzFdO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNkID0gYXdhaXQgdGhpcy5zZXR1cE5ld0Nocm9tZWRyaXZlcihvcHRzLCB0aGlzLmFkYi5jdXJEZXZpY2VJZCwgdGhpcy5hZGIpO1xuICAgIC8vIGJpbmQgb3VyIHN0b3AvZXhpdCBoYW5kbGVyLCBwYXNzaW5nIGluIGNvbnRleHQgc28gd2Uga25vdyB3aGljaFxuICAgIC8vIG9uZSBzdG9wcGVkIHVuZXhwZWN0ZWRseVxuICAgIGNkLm9uKENocm9tZWRyaXZlci5FVkVOVF9DSEFOR0VELCAobXNnKSA9PiB7XG4gICAgICBpZiAobXNnLnN0YXRlID09PSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCkge1xuICAgICAgICB0aGlzLm9uQ2hyb21lZHJpdmVyU3RvcChjb250ZXh0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBzYXZlIHRoZSBjaHJvbWVkcml2ZXIgb2JqZWN0IHVuZGVyIHRoZSBjb250ZXh0XG4gICAgdGhpcy5zZXNzaW9uQ2hyb21lZHJpdmVyc1tjb250ZXh0XSA9IGNkO1xuICB9XG4gIC8vIGhvb2sgdXAgdGhlIGxvY2FsIHZhcmlhYmxlcyBzbyB3ZSBjYW4gcHJveHkgdGhpcyBiaXpcbiAgdGhpcy5jaHJvbWVkcml2ZXIgPSBjZDtcbiAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuY2hyb21lZHJpdmVyLnByb3h5UmVxLmJpbmQodGhpcy5jaHJvbWVkcml2ZXIpO1xuICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcbn07XG5cbi8vIFN0b3AgcHJveHlpbmcgdG8gYW55IENocm9tZWRyaXZlclxuaGVscGVycy5zdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkgPSBmdW5jdGlvbiAoKSB7XG4gIHRoaXMuY2hyb21lZHJpdmVyID0gbnVsbDtcbiAgdGhpcy5wcm94eVJlcVJlcyA9IG51bGw7XG4gIHRoaXMuandwUHJveHlBY3RpdmUgPSBmYWxzZTtcbn07XG5cbi8vIEhhbmRsZSBhbiBvdXQtb2YtYmFuZCBDaHJvbWVkcml2ZXIgc3RvcCBldmVudFxuaGVscGVycy5vbkNocm9tZWRyaXZlclN0b3AgPSBhc3luYyBmdW5jdGlvbiAoY29udGV4dCkge1xuICBsb2cud2FybihgQ2hyb21lZHJpdmVyIGZvciBjb250ZXh0ICR7Y29udGV4dH0gc3RvcHBlZCB1bmV4cGVjdGVkbHlgKTtcbiAgaWYgKGNvbnRleHQgPT09IHRoaXMuY3VyQ29udGV4dCkge1xuICAgIC8vIHdlIGV4aXRlZCB1bmV4cGVjdGVkbHkgd2hpbGUgYXV0b21hdGluZyB0aGUgY3VycmVudCBjb250ZXh0IGFuZCBzbyB3YW50XG4gICAgLy8gdG8gc2h1dCBkb3duIHRoZSBzZXNzaW9uIGFuZCByZXNwb25kIHdpdGggYW4gZXJyb3JcbiAgICBsZXQgZXJyID0gbmV3IEVycm9yKFwiQ2hyb21lZHJpdmVyIHF1aXQgdW5leHBlY3RlZGx5IGR1cmluZyBzZXNzaW9uXCIpO1xuICAgIGF3YWl0IHRoaXMuc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24oZXJyKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBpZiBhIENocm9tZWRyaXZlciBpbiB0aGUgbm9uLWFjdGl2ZSBjb250ZXh0IGJhcmZzLCB3ZSBkb24ndCByZWFsbHlcbiAgICAvLyBjYXJlLCB3ZSdsbCBqdXN0IG1ha2UgYSBuZXcgb25lIG5leHQgdGltZSB3ZSBuZWVkIHRoZSBjb250ZXh0LlxuICAgIGxvZy53YXJuKFwiQ2hyb21lZHJpdmVyIHF1aXQgdW5leHBlY3RlZGx5LCBidXQgaXQgd2Fzbid0IHRoZSBhY3RpdmUgXCIgK1xuICAgICAgICAgICAgICAgIFwiY29udGV4dCwgaWdub3JpbmdcIik7XG4gICAgZGVsZXRlIHRoaXMuc2Vzc2lvbkNocm9tZWRyaXZlcnNbY29udGV4dF07XG4gIH1cbn07XG5cbi8vIEludGVudGlvbmFsbHkgc3RvcCBhbGwgdGhlIGNocm9tZWRyaXZlcnMgY3VycmVudGx5IGFjdGl2ZSwgYW5kIGlnbm9yZVxuLy8gdGhlaXIgZXhpdCBldmVudHNcbmhlbHBlcnMuc3RvcENocm9tZWRyaXZlclByb3hpZXMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHRoaXMuc3VzcGVuZENocm9tZWRyaXZlclByb3h5KCk7IC8vIG1ha2Ugc3VyZSB3ZSB0dXJuIG9mZiB0aGUgcHJveHkgZmxhZ1xuICBmb3IgKGxldCBjb250ZXh0IG9mIF8ua2V5cyh0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzKSkge1xuICAgIGxldCBjZCA9IHRoaXMuc2Vzc2lvbkNocm9tZWRyaXZlcnNbY29udGV4dF07XG4gICAgbG9nLmRlYnVnKGBTdG9wcGluZyBjaHJvbWVkcml2ZXIgZm9yIGNvbnRleHQgJHtjb250ZXh0fWApO1xuICAgIC8vIHN0b3AgbGlzdGVuaW5nIGZvciB0aGUgc3RvcHBlZCBzdGF0ZSBldmVudFxuICAgIGNkLnJlbW92ZUFsbExpc3RlbmVycyhDaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGNkLnN0b3AoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBFcnJvciBzdG9wcGluZyBDaHJvbWVkcml2ZXI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICAgIGRlbGV0ZSB0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzW2NvbnRleHRdO1xuICB9XG59O1xuXG5oZWxwZXJzLmlzQ2hyb21lZHJpdmVyQ29udGV4dCA9IGZ1bmN0aW9uICh2aWV3TmFtZSkge1xuICByZXR1cm4gXy5pbmNsdWRlcyh2aWV3TmFtZSwgV0VCVklFV19XSU4pIHx8IHZpZXdOYW1lID09PSBDSFJPTUlVTV9XSU47XG59O1xuXG5oZWxwZXJzLnNob3VsZERpc21pc3NDaHJvbWVXZWxjb21lID0gZnVuY3Rpb24gc2hvdWxkRGlzbWlzc0Nocm9tZVdlbGNvbWUgKCkge1xuICByZXR1cm4gISF0aGlzLm9wdHMuY2hyb21lT3B0aW9ucyAmJlxuICAgICAgICAgXy5pc0FycmF5KHRoaXMub3B0cy5jaHJvbWVPcHRpb25zLmFyZ3MpICYmXG4gICAgICAgICB0aGlzLm9wdHMuY2hyb21lT3B0aW9ucy5hcmdzLmluY2x1ZGVzKCctLW5vLWZpcnN0LXJ1bicpO1xufTtcblxuaGVscGVycy5kaXNtaXNzQ2hyb21lV2VsY29tZSA9IGFzeW5jIGZ1bmN0aW9uIGRpc21pc3NDaHJvbWVXZWxjb21lICgpIHtcbiAgbG9nLmluZm8oXCJUcnlpbmcgdG8gZGlzbWlzcyBDaHJvbWUgd2VsY29tZVwiKTtcbiAgbGV0IGFjdGl2aXR5ID0gYXdhaXQgdGhpcy5nZXRDdXJyZW50QWN0aXZpdHkoKTtcbiAgaWYgKGFjdGl2aXR5ICE9PSBcIm9yZy5jaHJvbWl1bS5jaHJvbWUuYnJvd3Nlci5maXJzdHJ1bi5GaXJzdFJ1bkFjdGl2aXR5XCIpIHtcbiAgICBsb2cuaW5mbyhcIkNocm9tZSB3ZWxjb21lIGRpYWxvZyBuZXZlciBzaG93ZWQgdXAhIENvbnRpbnVpbmdcIik7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxldCBlbCA9IGF3YWl0IHRoaXMuZmluZEVsT3JFbHMoJ2lkJywgJ2NvbS5hbmRyb2lkLmNocm9tZTppZC90ZXJtc19hY2NlcHQnLCBmYWxzZSk7XG4gIGF3YWl0IHRoaXMuY2xpY2soZWwuRUxFTUVOVCk7XG4gIHRyeSB7XG4gICAgbGV0IGVsID0gYXdhaXQgdGhpcy5maW5kRWxPckVscygnaWQnLCAnY29tLmFuZHJvaWQuY2hyb21lOmlkL25lZ2F0aXZlX2J1dHRvbicsIGZhbHNlKTtcbiAgICBhd2FpdCB0aGlzLmNsaWNrKGVsLkVMRU1FTlQpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gRE8gTk9USElORywgVEhJUyBERVZJQ0UgRElETlQgTEFVTkNIIFRIRSBTSUdOSU4gRElBTE9HXG4gICAgLy8gSVQgTVVTVCBCRSBBIE5PTiBHTVMgREVWSUNFXG4gICAgbG9nLndhcm4oYFRoaXMgZGV2aWNlIGRpZCBub3Qgc2hvdyBDaHJvbWUgU2lnbkluIGRpYWxvZywgJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuc3RhcnRDaHJvbWVTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRDaHJvbWVTZXNzaW9uICgpIHtcbiAgbG9nLmluZm8oXCJTdGFydGluZyBhIGNocm9tZS1iYXNlZCBicm93c2VyIHNlc3Npb25cIik7XG4gIGxldCBvcHRzID0gXy5jbG9uZURlZXAodGhpcy5vcHRzKTtcbiAgb3B0cy5jaHJvbWVVc2VSdW5uaW5nQXBwID0gZmFsc2U7XG5cbiAgY29uc3Qga25vd25QYWNrYWdlcyA9IFtcbiAgICAnb3JnLmNocm9taXVtLmNocm9tZS5zaGVsbCcsXG4gICAgJ2NvbS5hbmRyb2lkLmNocm9tZScsXG4gICAgJ2NvbS5jaHJvbWUuYmV0YScsXG4gICAgJ29yZy5jaHJvbWl1bS5jaHJvbWUnLFxuICAgICdvcmcuY2hyb21pdW0ud2Vidmlld19zaGVsbCcsXG4gIF07XG5cbiAgaWYgKF8uaW5jbHVkZXMoa25vd25QYWNrYWdlcywgdGhpcy5vcHRzLmFwcFBhY2thZ2UpKSB7XG4gICAgb3B0cy5jaHJvbWVCdW5kbGVJZCA9IHRoaXMub3B0cy5hcHBQYWNrYWdlO1xuICB9IGVsc2Uge1xuICAgIG9wdHMuY2hyb21lQW5kcm9pZEFjdGl2aXR5ID0gdGhpcy5vcHRzLmFwcEFjdGl2aXR5O1xuICB9XG4gIHRoaXMuY2hyb21lZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0Nocm9tZWRyaXZlcihvcHRzLCB0aGlzLmFkYi5jdXJEZXZpY2VJZCwgdGhpcy5hZGIpO1xuICB0aGlzLmNocm9tZWRyaXZlci5vbihDaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCwgKG1zZykgPT4ge1xuICAgIGlmIChtc2cuc3RhdGUgPT09IENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKSB7XG4gICAgICB0aGlzLm9uQ2hyb21lZHJpdmVyU3RvcChDSFJPTUlVTV9XSU4pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gTm93IHRoYXQgd2UgaGF2ZSBhIENocm9tZSBzZXNzaW9uLCB3ZSBlbnN1cmUgdGhhdCB0aGUgY29udGV4dCBpc1xuICAvLyBhcHByb3ByaWF0ZWx5IHNldCBhbmQgdGhhdCB0aGlzIGNocm9tZWRyaXZlciBpcyBhZGRlZCB0byB0aGUgbGlzdFxuICAvLyBvZiBzZXNzaW9uIGNocm9tZWRyaXZlcnMgc28gd2UgY2FuIHN3aXRjaCBiYWNrIGFuZCBmb3J0aFxuICB0aGlzLmN1ckNvbnRleHQgPSBDSFJPTUlVTV9XSU47XG4gIHRoaXMuc2Vzc2lvbkNocm9tZWRyaXZlcnNbQ0hST01JVU1fV0lOXSA9IHRoaXMuY2hyb21lZHJpdmVyO1xuICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5jaHJvbWVkcml2ZXIucHJveHlSZXEuYmluZCh0aGlzLmNocm9tZWRyaXZlcik7XG4gIHRoaXMuandwUHJveHlBY3RpdmUgPSB0cnVlO1xuXG4gIGlmICh0aGlzLnNob3VsZERpc21pc3NDaHJvbWVXZWxjb21lKCkpIHtcbiAgICAvLyBkaXNtaXNzIENocm9tZSB3ZWxjb21lIGRpYWxvZ1xuICAgIGF3YWl0IHRoaXMuZGlzbWlzc0Nocm9tZVdlbGNvbWUoKTtcbiAgfVxufTtcblxuXG4vKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogSW50ZXJuYWwgbGlicmFyeSBmdW5jdGlvbnNcbiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5cbmFzeW5jIGZ1bmN0aW9uIHNldHVwRXhpc3RpbmdDaHJvbWVkcml2ZXIgKGNocm9tZWRyaXZlcikge1xuICAvLyBjaGVjayB0aGUgc3RhdHVzIGJ5IHNlbmRpbmcgYSBzaW1wbGUgd2luZG93LWJhc2VkIGNvbW1hbmQgdG8gQ2hyb21lRHJpdmVyXG4gIC8vIGlmIHRoZXJlIGlzIGFuIGVycm9yLCB3ZSB3YW50IHRvIHJlY3JlYXRlIHRoZSBDaHJvbWVEcml2ZXIgc2Vzc2lvblxuICBpZiAoIWF3YWl0IGNocm9tZWRyaXZlci5oYXNXb3JraW5nV2VidmlldygpKSB7XG4gICAgbG9nLmRlYnVnKFwiQ2hyb21lRHJpdmVyIGlzIG5vdCBhc3NvY2lhdGVkIHdpdGggYSB3aW5kb3cuIFwiICtcbiAgICAgICAgICAgICAgICAgXCJSZS1pbml0aWFsaXppbmcgdGhlIHNlc3Npb24uXCIpO1xuICAgIGF3YWl0IGNocm9tZWRyaXZlci5yZXN0YXJ0KCk7XG4gIH1cbiAgcmV0dXJuIGNocm9tZWRyaXZlcjtcbn1cblxuaGVscGVycy5zZXR1cE5ld0Nocm9tZWRyaXZlciA9IGFzeW5jIGZ1bmN0aW9uIHNldHVwTmV3Q2hyb21lZHJpdmVyIChvcHRzLCBjdXJEZXZpY2VJZCwgYWRiKSB7XG4gIC8vIGlmIGEgcG9ydCB3YXNuJ3QgZ2l2ZW4sIHBpY2sgYSByYW5kb20gYXZhaWxhYmxlIG9uZVxuICBpZiAoIW9wdHMuY2hyb21lRHJpdmVyUG9ydCkge1xuICAgIGNvbnN0IGdldFBvcnQgPSBCLnByb21pc2lmeShQb3J0RmluZGVyLmdldFBvcnQsIHtjb250ZXh0OiBQb3J0RmluZGVyfSk7XG4gICAgb3B0cy5jaHJvbWVEcml2ZXJQb3J0ID0gYXdhaXQgZ2V0UG9ydCgpO1xuICAgIGxvZy5kZWJ1ZyhgQSBwb3J0IHdhcyBub3QgZ2l2ZW4sIHVzaW5nIHJhbmRvbSBwb3J0OiAke29wdHMuY2hyb21lRHJpdmVyUG9ydH1gKTtcbiAgfVxuXG4gIGNvbnN0IGNocm9tZWRyaXZlciA9IG5ldyBDaHJvbWVkcml2ZXIoe1xuICAgIHBvcnQ6IG9wdHMuY2hyb21lRHJpdmVyUG9ydCxcbiAgICBleGVjdXRhYmxlOiBvcHRzLmNocm9tZWRyaXZlckV4ZWN1dGFibGUsXG4gICAgYWRiLFxuICAgIHZlcmJvc2U6ICEhb3B0cy5zaG93Q2hyb21lZHJpdmVyTG9nLFxuICAgIGV4ZWN1dGFibGVEaXI6IG9wdHMuY2hyb21lZHJpdmVyRXhlY3V0YWJsZURpcixcbiAgICBtYXBwaW5nUGF0aDogb3B0cy5jaHJvbWVkcml2ZXJDaHJvbWVNYXBwaW5nRmlsZSxcbiAgICBidW5kbGVJZDogb3B0cy5jaHJvbWVCdW5kbGVJZCxcbiAgICB1c2VTeXN0ZW1FeGVjdXRhYmxlOiBvcHRzLmNocm9tZWRyaXZlclVzZVN5c3RlbUV4ZWN1dGFibGUsXG4gIH0pO1xuXG4gIC8vIG1ha2Ugc3VyZSB0aGVyZSBhcmUgY2hyb21lT3B0aW9uc1xuICBvcHRzLmNocm9tZU9wdGlvbnMgPSBvcHRzLmNocm9tZU9wdGlvbnMgfHwge307XG4gIC8vIHRyeSBvdXQgYW55IHByZWZpeGVkIGNocm9tZU9wdGlvbnMsXG4gIC8vIGFuZCBzdHJpcCB0aGUgcHJlZml4XG4gIGZvciAoY29uc3Qgb3B0IG9mIF8ua2V5cyhvcHRzKSkge1xuICAgIGlmIChvcHQuZW5kc1dpdGgoJzpjaHJvbWVPcHRpb25zJykpIHtcbiAgICAgIGxvZy53YXJuKGBNZXJnaW5nICcke29wdH0nIGludG8gJ2Nocm9tZU9wdGlvbnMnLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICBfLm1lcmdlKG9wdHMuY2hyb21lT3B0aW9ucywgb3B0c1tvcHRdKTtcbiAgICB9XG4gIH1cblxuICBsZXQgY2FwcyA9IHtcbiAgICBjaHJvbWVPcHRpb25zOiB7XG4gICAgICBhbmRyb2lkUGFja2FnZTogb3B0cy5jaHJvbWVPcHRpb25zLmFuZHJvaWRQYWNrYWdlIHx8IG9wdHMuYXBwUGFja2FnZSxcbiAgICB9XG4gIH07XG4gIGlmIChvcHRzLmNocm9tZVVzZVJ1bm5pbmdBcHApIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZFVzZVJ1bm5pbmdBcHAgPSBvcHRzLmNocm9tZVVzZVJ1bm5pbmdBcHA7XG4gIH1cbiAgaWYgKG9wdHMuY2hyb21lQW5kcm9pZFBhY2thZ2UpIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZFBhY2thZ2UgPSBvcHRzLmNocm9tZUFuZHJvaWRQYWNrYWdlO1xuICB9XG4gIGlmIChvcHRzLmNocm9tZUFuZHJvaWRBY3Rpdml0eSkge1xuICAgIGNhcHMuY2hyb21lT3B0aW9ucy5hbmRyb2lkQWN0aXZpdHkgPSBvcHRzLmNocm9tZUFuZHJvaWRBY3Rpdml0eTtcbiAgfVxuICBpZiAob3B0cy5jaHJvbWVBbmRyb2lkUHJvY2Vzcykge1xuICAgIGNhcHMuY2hyb21lT3B0aW9ucy5hbmRyb2lkUHJvY2VzcyA9IG9wdHMuY2hyb21lQW5kcm9pZFByb2Nlc3M7XG4gIH1cbiAgaWYgKG9wdHMubG9nZ2luZ1ByZWZzKSB7XG4gICAgY2Fwcy5sb2dnaW5nUHJlZnMgPSBvcHRzLmxvZ2dpbmdQcmVmcztcbiAgfVxuICBpZiAob3B0cy5lbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmcpIHtcbiAgICBsb2cud2FybihgVGhlICdlbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmcnIGNhcCBpcyBkZXByZWNhdGVkOyBzaW1wbHkgdXNlIGAgK1xuICAgICAgICAgICAgIGB0aGUgJ2xvZ2dpbmdQcmVmcycgY2FwIGluc3RlYWQsIHdpdGggYSAncGVyZm9ybWFuY2UnIGtleSBzZXQgdG8gJ0FMTCdgKTtcbiAgICBjb25zdCBuZXdQcmVmID0ge3BlcmZvcm1hbmNlOiAnQUxMJ307XG5cbiAgICAvLyBkb24ndCBvdmVyd3JpdGUgb3RoZXIgbG9nZ2luZyBwcmVmcyB0aGF0IGhhdmUgYmVlbiBzZW50IGluIGlmIHRoZXkgZXhpc3RcbiAgICBjYXBzLmxvZ2dpbmdQcmVmcyA9IGNhcHMubG9nZ2luZ1ByZWZzID9cbiAgICAgIE9iamVjdC5hc3NpZ24oe30sIGNhcHMubG9nZ2luZ1ByZWZzLCBuZXdQcmVmKSA6XG4gICAgICBuZXdQcmVmO1xuICB9XG4gIGlmIChvcHRzLmJyb3dzZXJOYW1lID09PSAnY2hyb21pdW0td2VidmlldycpIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZEFjdGl2aXR5ID0gb3B0cy5hcHBBY3Rpdml0eTtcbiAgfVxuICBpZiAob3B0cy5wYWdlTG9hZFN0cmF0ZWd5KSB7XG4gICAgY2Fwcy5wYWdlTG9hZFN0cmF0ZWd5ID0gb3B0cy5wYWdlTG9hZFN0cmF0ZWd5O1xuICB9XG4gIGNhcHMgPSB3ZWJ2aWV3SGVscGVycy5kZWNvcmF0ZUNocm9tZU9wdGlvbnMoY2Fwcywgb3B0cywgY3VyRGV2aWNlSWQpO1xuICBhd2FpdCBjaHJvbWVkcml2ZXIuc3RhcnQoY2Fwcyk7XG4gIHJldHVybiBjaHJvbWVkcml2ZXI7XG59O1xuY29uc3Qgc2V0dXBOZXdDaHJvbWVkcml2ZXIgPSBoZWxwZXJzLnNldHVwTmV3Q2hyb21lZHJpdmVyO1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBzZXR1cE5ld0Nocm9tZWRyaXZlciB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2NvbnRleHQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
